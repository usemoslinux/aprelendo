$(document).ready((function(){function t(){const t=$("#text"),e=$("#span-chars-left"),n=1e4-t.val().length;n<0?(e.removeClass("text-success").addClass("text-danger"),e.html(n.toLocaleString()+" for Text-to-Speech (TTS) Support")):(e.removeClass("text-danger").addClass("text-success"),e.text(n.toLocaleString()+" left"))}function e(t){t=t.replace(/(\r\n|\n|\r){3,}/gm,"\n\n");let e=/(\r\n|\n|\r)/gm,n=t.split(/(\r\n|\n|\r){2,}/gm);return n=n.map((t=>t.trim())).filter((t=>""!==t)),n.map((t=>t.replace(e," "))).join("\n\n")}function n(n){if(function(t){const e="https://"+document.documentElement.lang+".wikipedia.org/wiki/";return t.startsWith(e)}(n)){!function(e){a(!0);const n="https://"+document.documentElement.lang+".wikipedia.org/w/api.php",r={action:"query",prop:"extracts",titles:e,format:"json",explaintext:!0,origin:"*"};$.ajax({url:n,method:"GET",data:r}).done((function(n){let a=n.query.pages[Object.keys(n.query.pages)[0]].extract.replace(/(\r\n|\r|\n)+/g,"\n\n");a=function(t){const e=/\[\d+\]/g;return t.replace(e,"")}(a);const r=decodeURIComponent(e.replace(/_/g," "));$("#title").val(r),$("#text").val(a),t()})).fail((function(t,e,n){showMessage("There was an unexpected error trying to fetch this Wikipedia article.","alert-danger")}))}(new URL(n).pathname.split("/").pop())}else!function(t){a(!0),function(t){try{return new URL(t),!0}catch(t){return!1}}(t)&&($("#btn-fetch-img").removeClass().addClass("spinner-border spinner-border-sm text-warning"),$.ajax({type:"GET",url:"ajax/fetchurl.php",data:{url:t}}).done((function(t){if(null!=t.error_msg)showMessage(t.error_msg,"alert-danger");else if(void 0!==t&&0!=t.length){const n=document.implementation.createHTMLDocument("New Document");n.body.parentElement.innerHTML=DOMPurify.sanitize(t.file_contents);const a=new Readability(n).parse();if(null==a)return $("#url").val(t.url),void showMessage("It was not possible to extract the text from the URL you provided. Try doing it manually.","alert-danger");$("#title").val($("<input>").html(a.title).text()),$("#author").val($("<input>").html(a.byline).text()),$("#url").val(t.url);let r="",o=$("<output>").append($.parseHTML(a.content));$("p, h1, h2, h3, h4, h5, h6",o).each((function(){r+=$(this).text().replace(/\s+/g," ")+"\n\n"})),r=e(r),r=r.replace(/\t/g,""),$("#text").val($.trim(r)),$("#text").trigger("input")}else showMessage("There was an unexpected error trying to fetch this text.","alert-danger")})).fail((function(t,e,n){showMessage("There was an unexpected error trying to fetch this text.","alert-danger")})).always((function(){$("#btn-fetch-img").removeClass().addClass("bi bi-arrow-down-right-square text-warning")})))}(n)}function a(t){$("#alert-box").addClass("d-none"),$("#type").prop("selectedIndex",0),$("#title").val(""),$("#author").val(""),$("#title").val(""),$("#text").val(""),$("#upload-text").val(""),t||$("#url").val("")}$("#external_call").length&&n($("#url").val()),$("#form-addtext").on("submit",(function(t){t.preventDefault();const e=new FormData(document.getElementById("form-addtext"));$.ajax({type:"POST",url:"ajax/addtext.php",data:e,dataType:"json",contentType:!1,processData:!1}).done((function(t){void 0!==t?showMessage(t.error_msg,"alert-danger"):"on"==e.get("shared-text")?window.location.replace("/sharedtexts"):window.location.replace("/texts")})).fail((function(t,e,n){showMessage("Oops! There was an unexpected error when uploading this text.","alert-danger")}))})),$("#text").on("input",(function(){t()})),$("#upload-text").on("change",(function(){const n=$(this)[0].files[0],a=new FileReader;a.onload=function(n){const a=n.target.result;$("#text").val(e(a)),t()},a.readAsText(n),$(this).val("")})),$("#text").on("paste",(function(n){n.preventDefault();let a=n.originalEvent.clipboardData.getData("text");$(this).val(e(a)),t()})),$("#btn-fetch").on("click",(function(t){n($("#url").val())})),$("#url").on("paste",(function(t){const e=$("#text").val();if(!e||/^\s*$/.test(e)){n(t.originalEvent.clipboardData.getData("text"))}})),$("#text").text().length>0&&$("#text").trigger("input")}));