$(document).ready((function(){var e,t,a,n,o,r=!1,i=!1,s=null,l=null,d="",p="",c="",u=1,h=!1,g=0,m=0;window.parent.show_confirmation_dialog=!0;var f=$(parent.document),w=f.find("#dicFrame"),y=(y=f.find('iframe[id^="epubjs"]')).length>0?y:$("html");function v(e){var t=(new Date).getTime(),a=$("#audioplayer");t-e>1e3&&!a.prop("ended")?a.trigger("play"):(!a.prop("paused")&&a.trigger("pause"),l=setTimeout(()=>{v(e)},1e3))}function b(){var e=[],t=[],a="",n=!0,o=$("#is_shared").length>0;$(".learning").each((function(){a=$(this).text().toLowerCase(),-1==jQuery.inArray(a,e)&&e.push(a)})),t.push($("#text-container").attr("data-textID")),o&&(t=void 0,n=void 0),$.ajax({type:"POST",url:"/ajax/archivetext.php",data:{words:e,textIDs:JSON.stringify(t),archivetext:n}}).done((function(e){window.parent.show_confirmation_dialog=!1;var t=Number($(".word").length)+Number($(".phrase").length),a=$('<form action="/textstats.php" method="post"><input type="hidden" name="created" value="'+$(".reviewing.new").length+'" /><input type="hidden" name="reviewed" value="'+$(".reviewing.learning").length+'" /><input type="hidden" name="learned" value="'+$(".learned").length+'" /><input type="hidden" name="forgotten" value="'+$(".reviewing.forgotten").length+'" /><input type="hidden" name="total" value="'+t+'" /></form>');$("body").append(a),a.submit()})).fail((function(e,t,a){alert("Oops! There was an error updating the database.")}))}function x(){var e=$("#audioplayer");e.prop("currentTime","0"),e.trigger("play")}function C(){0==$(".dict-answer").length?($(".learning, .new, .forgotten").each((function(e,t){var a=$(this),n=a.text().length,o=a.width(),r=a.css("font-size");a.hide().after('<div class="input-group dict-input-group"><input type="text" class="dict" style="width:'+o+"px; line-height:"+r+';" maxlength="'+n+'" data-text="'+a.text()+'"><span class="input-group-append dict-answer d-none"></span></div>')})),$("html, body").animate({scrollTop:0},"slow"),x(),$(":text:first").focus()):($(".learning, .new, .forgotten").each((function(e,t){$elem=$(this),$elem.show().nextAll(":lt(1)").remove()})),$("html, body").animate({scrollTop:0},"slow"),$("#audioplayer").trigger("pause"))}function k(){$("#btn-next-phase").html('Finish & Save<br><span class="small">Skipped phases 2, 3 & 4: no audio detected</span>'),u=4}function T(){if(!($("#audioplayer").length>0))return!1;var e=$("#text").text(),t=$("html").attr("lang");$.ajax({type:"POST",url:"ajax/fetchaudiostream.php",data:{text:e,langiso:t},dataType:"json"}).done((function(e){if(null!=e.error||0==e.response)return k(),!1;var t=$("#audioplayer");return t.find("source").attr("src",e.response),t[0].load(),$("#audioplayer-loader").addClass("d-none"),$("#audioplayer").removeClass("d-none"),$("#audioplayer-speedbar").removeClass("d-none"),!0})).fail((function(e,t,a){return 403==e.status?($("#audioplayer-loader").addClass("d-none"),$("#alert-msg-audio").removeClass("d-none").empty().append('You have reached your audio streaming limit for today. Although it is possible to continue with the revision of the text, we do not recommend it. Alternatively, you can try again tomorrow or you can consider supporting us and <a class="alert-link" href="gopremium.php">improving your plan</a> to increase the daily audio streaming limit.')):($("#audioplayer-loader").addClass("d-none"),$("#alert-msg-audio").removeClass("d-none").empty().append('There was an unexpected error trying to create audio from this text. <a class="alert-link" href="#" id="retry-audio-load">Try again</a> later.')),k(),!1}))}T(),$(window).on("keydown",(function(e){var t=$("#audioplayer");if(t.length&&e.ctrlKey)switch(e.keyCode){case 32:t.prop("paused")?t.trigger("play"):t.trigger("pause");break}})),$("body").on("input","input:text",(function(e){var t=(new Date).getTime();9!=(e.keyCode||e.which)&&(clearTimeout(l),v(t))})),$("body").on("click","#btn-abloop",(function(e){e.preventDefault(),e.stopPropagation(),0==g&&0==m?(g=$("#audioplayer").prop("currentTime"),$(this).text("B")):g>0&&0==m?(m=$("#audioplayer").prop("currentTime"),$(this).text("C")):(g=m=0,$(this).text("A"))})),$("#audioplayer").on("timeupdate",(function(){m>0&&$(this).prop("currentTime")>=m&&$(this).prop("currentTime",g)})),$(document).on("mousedown touchstart",".word",(function(n){n.stopPropagation(),n.which<2&&(r=!0,e=t=$(this),"touchstart"==n.type&&(a=new Date,o=e.offset().top-$(window).scrollTop()))})),$(document).on("mouseup touchend",".word",(function(o){o.stopPropagation(),n=new Date,"touchend"==o.type&&($("html").css({overflow:"visible"}),i=!1),r&&o.which<2&&(r=!1,e===t&&($closest=$(this).closest(".learning, .learned, .forgotten"),s=$closest.length?$closest:$(this)),function(){var e=$("#audioplayer"),t=$("html").attr("lang");e.length&&(!e.prop("paused")&&e.prop("currentTime")?(e.trigger("pause"),h=!0):h=!1);r=s.text(),i=t,l=f.find("#bdgfreqlvl"),$.ajax({type:"GET",url:"/ajax/getwordfreq.php",data:{word:r,lg_iso:i}}).done((function(e){0==e?l.hide():e<81?l.hide().text("High frequency word").removeClass().addClass("badge badge-danger").show():l.hide().text("Medium frequency word").removeClass().addClass("badge badge-warning").show()})),a=$(parent.document).find("#btnremove"),n=$(parent.document).find("#btnadd"),o=s.filter(".learning, .new, .forgotten, .learned").length,s.filter(".word").length==o?!1===a.is(":visible")&&(a.show(),n.text("Forgot")):(a.hide(),n.text("Add")),f.find("#iframe-loader").attr("class","lds-ripple m-auto"),w.attr("class","d-none"),c=function(){var e=s.prevUntil(":contains('.')").last();e=e.length>0?e:s;var t=s.prev().nextUntil(":contains('.')").last().next();t=t.length>0?t:s.nextAll().last().next();var a=e.nextUntil(t).addBack().next().addBack().text().replace(/(\r\n|\n|\r)/gm," ");return p.replace("%s",encodeURI(a))}();var a,n,o;var r,i,l;var u=s.text().replace(/\r?\n|\r/gm," "),g=d.replace("%s",encodeURIComponent(u));w.get(0).contentWindow.location.replace(g),$("#btnadd").focus(),f.find("#myModal").modal("show")}()),a=n=new Date})),$.fn.isAfter=function(e){return this.prevUntil(e).length!==this.prevAll().length},$(document).on("mouseover touchmove",".word",(function(l){if(l.stopPropagation(),n=new Date,"touchmove"==l.type){var d=$(this).offset().top-$(window).scrollTop();(i=i||Math.abs(o-d)>0)||(r=n-a>1e3)}r&&("touchmove"==l.type&&$("html").css({overflow:"hidden"}),$(".word").removeClass("highlighted"),(t="mouseover"===l.type?$(this):$(document.elementFromPoint(l.originalEvent.touches[0].clientX,l.originalEvent.touches[0].clientY))).isAfter(e)?(e.nextUntil(t.next(),".word").addBack().addClass("highlighted"),s=e.nextUntil(t.next()).addBack()):(e.prevUntil(t.prev(),".word").addBack().addClass("highlighted"),s=t.nextUntil(e.next()).addBack()))})),$.ajax({url:"/ajax/getdicuris.php",type:"GET",dataType:"json"}).done((function(e){null==e.error_msg&&(d=e.dictionary_uri,p=e.translator_uri)})),w.on("load",(function(){f.find("#iframe-loader").attr("class","d-none"),w.removeClass()})),f.on("click","#btn-translate",(function(){window.open(c)})),f.on("click","#btnadd",(function(){var e=s.length>1?1:0,t=s.text();$.ajax({type:"POST",url:"/ajax/addword.php",data:{word:t,is_phrase:e}}).done((function(){if(e){var a=s.filter(".word").length;y.contents().find("span.word").filter((function(){return $(this).text().toLowerCase()===s.eq(0).text().toLowerCase()})).each((function(){var e=$(this).nextAll("span.word").slice(0,a-1).last(),n=$(this).nextUntil(e).addBack().next("span.word").addBack();n.text().toLowerCase()===t.toLowerCase()&&($(this).is(".new, .learning, .learned, .forgotten")?n.wrapAll("<span class='word reviewing forgotten' data-toggle='modal' data-target='#myModal'></span>"):n.wrapAll("<span class='word reviewing new' data-toggle='modal' data-target='#myModal'></span>"),n.contents().unwrap())}))}else{var n=y.contents().find("span.word").filter((function(){return $(this).text().toLowerCase()===t.toLowerCase()}));n.each((function(){var e=$(this);e.is(".new, .learning, .learned, .forgotten")?e.wrap("<span class='word reviewing forgotten' data-toggle='modal' data-target='#myModal'></span>"):e.wrap("<span class='word reviewing new' data-toggle='modal' data-target='#myModal'></span>")})),n.contents().unwrap()}var o=$("#alert-msg-phase").attr("data-phase");if(4==u&&audio_is_loaded&&3==o){$("#btn-next-phase").html("Go to phase "+u+'<br><span class="small">'+["Reading","Listening","Speaking","Writing"][u-1]+"</span>"),u=parseInt(o)}})).fail((function(e,t,a){alert("Oops! There was an error adding this word or phrase to the database.")})),s.removeClass("highlighted")})),f.on("click","#btnremove",(function(){var e=null!=$("#audioplayer").find("source").attr("src")&&""!=$("#audioplayer").find("source").attr("src");$.ajax({type:"POST",url:"/ajax/removeword.php",data:{word:s.text()}}).done((function(){var t=y.contents().find("span.word").filter((function(){return $(this).text().toLowerCase()===s.text().toLowerCase()}));$.ajax({url:"/ajax/underlinewords.php",type:"POST",data:{txt:s.text(),is_ebook:!1}}).done((function(a){t.removeClass(),t.addClass("word"),3==u&&e>0&&0==$(".learning, .new, .forgotten").length&&($("#btn-next-phase").html('Finish & Save<br><span class="small">Skipped phase 4 (writing): no underlined words</span>'),u++)}))})).fail((function(e,t,a){alert("Oops! There was an error removing the word from the database.")}))})),$("body").on("click","#btn-next-phase",(function(){var e=null!=$("#audioplayer").find("source").attr("src")&&""!=$("#audioplayer").find("source").attr("src"),t=$("#alert-msg-phase");switch(u){case 1:if($("html, body").animate({scrollTop:0},"slow"),!e){$(this).html('Finish & Save<br><span class="small">Skipped phases 2, 3 & 4: no audio detected</span>'),u=4;break}u++,t.html('<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button><strong>Assisted learning - Phase 2:</strong> Listening <br><span class="small">Pay attention to the pronunciation of each word. You can slow down the audio if necessary.</span>').attr("data-phase",u),$(this).html('Go to phase 3<br><span class="small">Speaking</span>'),x();break;case 2:if($("html, body").animate({scrollTop:0},"slow"),!e){$(this).html('Finish & Save<br><span class="small">Skipped phase 4 (writing): no audio detected</span>'),u=4;break}0==$(".learning, .new, .forgotten").length?($(this).html('Finish & Save<br><span class="small">Skipped phase 4 (writing): no underlined words</span>'),u=4,t.attr("data-phase",3)):($(this).html('Go to phase 4<br><span class="small">Writing</span>'),u++,t.attr("data-phase",u)),t.html('<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button><strong>Assisted learning - Phase 3:</strong> Speaking <br><span class="small">Read out loud and try to emulate the pronunciation of each word as you listen to the audio. You can slow it down if necessary.</span>'),x();break;case 3:$("html, body").animate({scrollTop:0},"slow"),u++,$(this).html("Finish & Save"),t.html('<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button><strong>Assisted learning - Phase 4:</strong> Writing.<br><span class="small">Fill in the blanks as you listen to the dictation.</span>').attr("data-phase",u),C();break;case 4:b();break;default:break}})),$("body").on("click","#btn-save",b),f.on("hidden.bs.modal","#myModal",(function(){var e=$("#audioplayer");h&&e.length&&e.trigger("play"),s.removeClass("highlighted")})),$("body").on("input change","#range-speed",(function(){cpbr=parseFloat($(this).val()).toFixed(1),$("#currentpbr").text(cpbr),$("#audioplayer").prop("playbackRate",cpbr)})),$("body").on("click","#btndictation",(function(){C()})),$("body").on("blur",":text",(function(){var e=$(this);e.val().toLowerCase()==e.attr("data-text").toLowerCase()?(e.css("border-color","green"),e.next("span").not(".d-none").addClass("d-none")):""!=$.trim(e.val())&&(e.css("border-color","crimson"),e.next("span").removeClass("d-none").addClass("dict-wronganswer").text("[ "+e.attr("data-text")+" ]"))})),$("body").on("input",".dict",(function(e){if(13===e.which){var t=$(".dict").index(this)+1;$(".dict").eq(t).focus()}})),f.on("click","#retry-audio-load",(function(e){e.preventDefault(),$("#alert-msg-audio").addClass("d-none"),$("#audioplayer-loader").removeClass("d-none"),T()})),$(document).on("click",y,(function(e){!1===$(e.target).is(".word")&&(e.stopPropagation(),$text_container=$("#text-container").length?$("#text-container"):y.contents(),r=!1,$text_container.find(".highlighted").removeClass("highlighted"))})),$(window.parent).on("beforeunload",(function(){if(window.parent.show_confirmation_dialog)return"To save your progress, please click the Save button before you go. Otherwise, your changes will be lost. Are you sure you want to exit this page?"}))}));