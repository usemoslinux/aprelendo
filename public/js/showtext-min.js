$(document).ready((function(){let e,t,n,a,o,r=!1,i=!1,s=null,l="",d="",c="",u=2,p=!1,h=0,g=0;window.parent.show_confirmation_dialog=!0;let f=$("html").attr("lang"),w=$(parent.document),m=w.find("#dicFrame"),y=w.find('iframe[id^="epubjs"]');function x(){let e=s.prevUntil(":contains('.')").last();e=e.length>0?e:s;let t=s.prev().nextUntil(":contains('.')").last().next();t=t.length>0?t:s.nextAll().last().next();const n=e.nextUntil(t).addBack().next().addBack().text().replace(/(\r\n|\n|\r)/gm," ").trim();return d.replace("%s",encodeURI(n))}function b(){let e=[],t=[],n="",a=!0;const o=$("#is_shared").length>0;let r=0;$(".learning").each((function(){n=$(this).text().toLowerCase(),-1==$.inArray(n,e)&&e.push(n)})),t.push($("#text-container").attr("data-textID")),o&&(t=void 0,a=void 0),$.ajax({type:"POST",url:"/ajax/archivetext.php",data:{words:e,textIDs:JSON.stringify(t),archivetext:a}}).done((function(e){if(null==e.error_msg){const e={words:{new:$(".reviewing.new").length,learning:$(".reviewing.learning").length,forgotten:$(".reviewing.forgotten").length},texts:{reviewed:1}};$.ajax({type:"post",url:"ajax/updateuserscore.php",data:e}).done((function(e){if(null==e.error_msg){r=e.gems_earned,window.parent.show_confirmation_dialog=!1;const t="/textstats",n=Number($(".word").length)+Number($(".phrase").length),a=$('<form action="'+t+'" method="post"><input type="hidden" name="created" value="'+$(".reviewing.new").length+'" /><input type="hidden" name="reviewed" value="'+$(".reviewing.learning").length+'" /><input type="hidden" name="learned" value="'+$(".learned").length+'" /><input type="hidden" name="forgotten" value="'+$(".reviewing.forgotten").length+'" /><input type="hidden" name="total" value="'+n+'" /><input type="hidden" name="gems_earned" value="'+r+'" /><input type="hidden" name="is_shared" value="'+$("#is_shared").length+'" /></form>');$("body").append(a),a.submit()}else alert("Oops! There was an unexpected error.")})).fail((function(e,t,n){alert("Oops! There was an unexpected error.")}))}else alert("Oops! There was an unexpected error.")})).fail((function(e,t,n){alert("Oops! There was an unexpected error.")}))}function v(){let e=$("#audioplayer");e.prop("currentTime","0"),e.trigger("play")}function k(){if(""!=$("#audioplayer").find("source").attr("src")){let e=$("#text").clone(),t=e.find(".word"),n=$(".word");0==$(".dict-answer").length?(0==$(".learning, .new, .forgotten").length&&($("#btn-next-phase").attr("title","Finish & Save - 5 (reviewing): no underlined words"),u=6),t.each((function(e,t){let a=$(this);const o=a.text().length,r=n.eq(e).width(),i=n.eq(e).css("font-size");a.hide().after('<div class="input-group dict-input-group"><input type="text" class="dict" style="width:'+r+"px; line-height:"+i+';" maxlength="'+o+'" data-text="'+a.text()+'"><span class="dict-answer d-none"></span></div>')})),$("#text").replaceWith(e),$("html, body").animate({scrollTop:0},"fast"),$("#range-speed").trigger("change",[{cpbr:.5}]),v(),$(":text:first").focus()):(t.each((function(e,t){$(this).show().nextAll(":lt(1)").remove()})),$("#text").replaceWith(e),$("html, body").animate({scrollTop:0},"fast"),$("#audioplayer").trigger("pause"))}}function C(){""!=$("#audioplayer").find("source").attr("src")||(0==$(".learning, .new, .forgotten").length?($("#btn-next-phase").attr("title","Finish & Save - Skipped some phases: no audio detected & no underlined words"),u=6):($("#btn-next-phase").attr("title","Go to phase 5: Reviewing - Skipped some phases: no audio detected"),u=5))}function T(){let e=$("#audioplayer");if(!(e.length>0))return!1;{const t=$("#text").text();$.ajax({type:"POST",url:"/ajax/fetchaudiostream.php",data:{text:t,langiso:f},dataType:"json"}).done((function(t){return null==t.error&&t.response?($("#audio-mp3").attr("src",t.response),e[0].load(),$("#audioplayer-loader").addClass("d-none"),$("#audioplayer").removeClass("d-none"),$("#audioplayer-speedbar").removeClass("d-none"),$("#btn-next-phase").attr("title","Go to phase 2: Listening"),u=2,!0):($("#audioplayer-loader").addClass("d-none"),$("#alert-msg-audio").removeClass("d-none").empty().append('There was an unexpected error trying to create audio from this text. <a class="alert-link" href="#" id="retry-audio-load">Try again</a> later.'),C(),!1)})).fail((function(e){return 403==e.status?($("#audioplayer-loader").addClass("d-none"),$("#alert-msg-audio").removeClass("d-none").empty().append("You have reached your audio streaming limit. Try again tomorrow.")):($("#audioplayer-loader").addClass("d-none"),$("#alert-msg-audio").removeClass("d-none").empty().append('There was an unexpected error trying to create audio from this text. <a class="alert-link" href="#" id="retry-audio-load">Try again</a> later.')),C(),!1}))}}y=y.length>0?y:$("html"),T(),"text"==$("#text-container").data("type")&&$.ajax({type:"POST",url:"/ajax/getuserwords.php",data:{txt:$("#text").text()},dataType:"json"}).done((function(e){$("#text").html(underlineWords(e,f))})).fail((function(e,t,n){})).always((function(){C()})),$("body").on("click","#btn-abloop",(function(e){e.preventDefault(),e.stopPropagation(),0==h&&0==g?(h=$("#audioplayer").prop("currentTime"),$(this).text("B")):h>0&&0==g?(g=$("#audioplayer").prop("currentTime"),$(this).text("C")):(h=g=0,$(this).text("A"))})),$("#audioplayer").on("timeupdate",(function(){g>0&&$(this).prop("currentTime")>=g&&$(this).prop("currentTime",h)})),$(document).on("contextmenu",(function(e){return!/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)&&$(e.target).is(".word")&&window.open(x()),!1})),$(document).on("mousedown touchstart",".word",(function(a){a.stopPropagation(),a.which<2?(r=!0,e=t=$(this),"touchstart"==a.type&&(n=new Date,o=e.offset().top-$(window).scrollTop())):3==a.which&&($("#audioplayer").trigger("pause"),s=$(this))})),$(document).on("mouseup touchend",".word",(function(o){if(o.stopPropagation(),a=new Date,"touchend"==o.type&&(i||(r=a-n>1e3),$("html").enableScroll(),i=!1),r&&o.which<2){if(r=!1,e===t){let e=$(this).closest(".learning, .learned, .forgotten");s=e.length?e:$(this)}!function(){let e=$("#audioplayer");e.length&&(!e.prop("paused")&&e.prop("currentTime")?(e.trigger("pause"),p=!0):p=!1);(function(e,t){let n=w.find("#bdgfreqlvl");$.ajax({type:"GET",url:"/ajax/getwordfreq.php",data:{word:e,lg_iso:t}}).done((function(e){0==e?n.hide():e<81?n.hide().text("High frequency word").removeClass().addClass("badge text-bg-danger").show():e<97&&n.hide().text("Medium frequency word").removeClass().addClass("badge text-bg-warning").show()})).fail((function(){n.hide()}))})(s.text(),f),function(){let e=$(parent.document).find("#btnremove"),t=$(parent.document).find("#btnadd");const n=s.filter(".learning, .new, .forgotten, .learned").length;s.filter(".word").length==n?!1===e.is(":visible")&&(e.show(),t.text("Forgot")):(e.hide(),t.text("Add"))}(),w.find("#iframe-loader").attr("class","lds-ellipsis m-auto"),m.attr("class","d-none"),c=x();const t=s.text().replace(/\r?\n|\r/gm," "),n=l.replace("%s",encodeURIComponent(t));m.get(0).contentWindow.location.replace(n),$("#btnadd").focus(),w.find("#myModal").modal("show")}()}n=a=new Date})),$.fn.isAfter=function(e){return this.prevUntil(e).length!==this.prevAll().length},$(document).on("mouseover touchmove",".word",(function(l){if(l.stopPropagation(),a=new Date,"touchmove"==l.type){const e=$(this).offset().top-$(window).scrollTop();i=i||Math.abs(o-e)>0,i||(r=a-n>1e3)}r&&("touchmove"==l.type&&$("html").disableScroll(),$(".word").removeClass("highlighted"),t="mouseover"===l.type?$(this):$(document.elementFromPoint(l.originalEvent.touches[0].clientX,l.originalEvent.touches[0].clientY)),t.isAfter(e)?(e.nextUntil(t.next(),".word").addBack().addClass("highlighted"),s=e.nextUntil(t.next()).addBack()):(e.prevUntil(t.prev(),".word").addBack().addClass("highlighted"),s=t.nextUntil(e.next()).addBack()))})),$.ajax({url:"/ajax/getdicuris.php",type:"GET",dataType:"json"}).done((function(e){null==e.error_msg&&(l=e.dictionary_uri,d=e.translator_uri)})),$.fn.disableScroll=function(){window.oldScrollPos=$(window).scrollTop(),$(window).on("scroll.scrolldisabler",(function(e){$(window).scrollTop(window.oldScrollPos),e.preventDefault()}))},$.fn.enableScroll=function(){$(window).off("scroll.scrolldisabler")},m.on("load",(function(){w.find("#iframe-loader").attr("class","d-none"),m.removeClass()})),w.on("click","#btn-translate",(function(){window.open(c)})),w.on("click","#btnadd",(function(){const e=s.length>1?1:0,t=s.text(),n=""!=$("#audioplayer").find("source").attr("src");$.ajax({type:"POST",url:"/ajax/addword.php",data:{word:t,is_phrase:e}}).done((function(){const a=0==$(".learning, .new, .forgotten").length;if(e){const e=s.filter(".word").length;y.contents().find("a.word").filter((function(){return $(this).text().toLowerCase()===s.eq(0).text().toLowerCase()})).each((function(){let n=$(this).nextAll("a.word").slice(0,e-1).last(),a=$(this).nextUntil(n).addBack().next("a.word").addBack();a.text().toLowerCase()===t.toLowerCase()&&(a.wrapAll("<a class='word reviewing new' data-toggle='modal' data-bs-target='#myModal'></a>"),a.contents().unwrap())}))}else{let e=y.contents().find("a.word").filter((function(){return $(this).text().toLowerCase()===t.toLowerCase()}));e.each((function(){let e=$(this);e.is(".new, .learning, .learned, .forgotten")?e.wrap("<a class='word reviewing forgotten' data-toggle='modal' data-bs-target='#myModal'></a>"):e.wrap("<a class='word reviewing new' data-toggle='modal' data-bs-target='#myModal'></a>")})),e.contents().unwrap()}6==u&&a&&(n?($("#btn-next-phase").attr("title","Go to phase 4: Writing (be patient, may take a while to load depending on text length)"),u=4):C())})).fail((function(e,t,n){alert("Oops! There was an error adding this word or phrase to the database.")})),s.removeClass("highlighted")})),w.on("click","#btnremove",(function(){$.ajax({type:"POST",url:"/ajax/removeword.php",data:{word:s.text()}}).done((function(){let e=y.contents().find("a.word").filter((function(){return $(this).text().toLowerCase()===s.text().toLowerCase()}));$.ajax({type:"POST",url:"/ajax/getuserwords.php",data:{txt:s.text()},dataType:"json"}).done((function(t){let n=$(underlineWords(t,f)),a={},o=/""/;e.each((function(){a=$(this),n.filter(".word").each((function(e){o=langs_with_no_word_separator.includes(f)?new RegExp("(?<![^])"+$(this).text()+"(?![$])","iug").exec(a.text()):new RegExp("(?<![\\p{L}|^])"+$(this).text()+"(?![\\p{L}|$])","iug").exec(a.text()),$(this).text(o);const n=$(this).text().toLowerCase(),r=t.user_words.find((function(e){return e.word==n}));void 0!==r&&(2==r.status?$(this).removeClass("learning").addClass("new"):3==r.status&&$(this).removeClass("learning").addClass("forgotten"))})),a.replaceWith(n.clone())}))}))})).fail((function(e,t,n){alert("Oops! There was an error removing the word from the database.")}))})),$("body").on("click","#btn-next-phase",(function(){const e=""!=$("#audioplayer").find("source").attr("src");let t=$("#alert-msg-phase");switch(u<6&&!e&&C(),u){case 2:$("html, body").animate({scrollTop:0},"fast"),u++,t.html('<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button><h5 class="alert-heading">Assisted learning - Phase 2: Listening</h5><span class="small">Pay attention to the pronunciation of each word. You can slow down the audio if necessary.</span>'),$(this).attr("title","Go to phase 3: Speaking"),v();break;case 3:$("html, body").animate({scrollTop:0},"fast"),u++,$(this).attr("title","Go to phase 4: Writing (be patient, may take a while to load depending on text length)"),t.html('<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button><h5 class="alert-heading">Assisted learning - Phase 3: Speaking</h5><span class="small">Read the text out loud and try to emulate the pronunciation of each word as you listen to the audio. You can slow it down if necessary.</span>'),v();break;case 4:$("html, body").animate({scrollTop:0},"fast"),0==$(".learning, .new, .forgotten").length?($(this).attr("title","Finish & Save - Skipped phase 5 (reviewing): no underlined words</span>"),u=6):($(this).attr("title","Go to phase 5: Reviewing"),u++),t.html('<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button><h5 class="alert-heading">Assisted learning - Phase 4: Writing</h5><span class="small">Fill in the blanks as you listen to the dictation. To toggle audio playback press <kbd>2</kbd>. To rewind or fast-forward 1 second, use <kbd>1</kbd> and <kbd>3</kbd>.</span>'),k();break;case 5:$("html, body").animate({scrollTop:0},"fast"),u++,$(this).attr("title","Finish & Save"),t.html('<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button><h5 class="alert-heading">Assisted learning - Phase 5: Reviewing</h5><span class="small"><u>This is the most <a href="https://en.wikipedia.org/wiki/Testing_effect" class="alert-link" target="_blank" rel="noopener noreferrer">critical phase</a> for long-term language acquisition.</u><br>Review all the underlined words, even the ones with green underlining. Make an effort to remember their meaning and pronunciation, while also paying attention to their spelling. Speak out alternative sentences using these words. The latter is essential to turn your <a href="https://en.wiktionary.org/wiki/passive_vocabulary" class="alert-link" target="_blank" rel="noopener noreferrer">passive vocabulary</a> into <a href="https://en.wiktionary.org/wiki/active_vocabulary" class="alert-link" target="_blank" rel="noopener noreferrer">active vocabulary</a>.</span>'),k();break;case 6:b();break;default:break}})),$("body").on("click","#btn-save-text",b),$("#btn-toggle-audio-player-controls").on("click",(function(){let e=$("#audioplayer-container");"static"==e.css("position")?e.css({position:"sticky"}):e.css({position:"static"})})),w.on("hidden.bs.modal","#myModal",(function(){let e=$("#audioplayer");p&&e.length&&e.trigger("play"),s.removeClass("highlighted")})),$("body").on("input change","#range-speed",(function(e,t){const n=void 0!==t?t.cpbr:parseFloat($(this).val()).toFixed(1);$(this).val(n),$("#currentpbr").text(n),$("#audioplayer").prop("playbackRate",n)})),$("body").on("blur",".dict",(function(){let e=$(this);e.val().toLowerCase()==e.attr("data-text").toLowerCase()?(e.css("border-color","green"),e.next("span").not(".d-none").addClass("d-none")):""!=$.trim(e.val())&&(e.css("border-color","crimson"),e.next("span").removeClass("d-none").addClass("dict-wronganswer").text("[ "+e.attr("data-text")+" ]"))})),$("body").on("keydown",".dict",(function(e){const t=e.keyCode||e.which;if(!e.isComposing&&0!=t&&229!=t&&8==t&&!$(this).val()){const t=$(".dict").index(this)-1;e.preventDefault(),$(".dict").eq(t).focus()}})),$("body").on("input",".dict",(function(e){let t=e.keyCode||e.which;const n=$(this).attr("maxlength"),a=$("#audioplayer")[0].currentTime;switch(0!=t&&229!=t||(t=e.target.value.charAt(e.target.selectionStart-1).charCodeAt()),t){case 8:if(!$(this).val()){const e=$(".dict").index(this)-1;$(".dict").eq(e).focus()}break;case 49:$("#audioplayer")[0].currentTime=a-1;break;case 50:!function(){let e=$("#audioplayer");e.prop("paused")?e.trigger("play"):e.trigger("pause")}();break;case 51:$("#audioplayer")[0].currentTime=a+1;break;default:break}if($(this).val($(this).val().replace(/[0-9]/gi,"")),n==$(this).val().length){const e=$(".dict").index(this)+1;$(".dict").eq(e).focus()}})),w.on("click","#retry-audio-load",(function(e){e.preventDefault(),$("#alert-msg-audio").addClass("d-none"),$("#audioplayer-loader").removeClass("d-none"),T()})),$(document).on("click",y,(function(e){if(!1===$(e.target).is(".word")){e.stopPropagation();let t=$("#text-container").length?$("#text-container"):y.contents();r=!1,$("html").enableScroll(),t.find(".highlighted").removeClass("highlighted")}})),$(window.parent).on("beforeunload",(function(){if(window.parent.show_confirmation_dialog)return"To save your progress, please click the Save button before you go. Otherwise, your changes will be lost. Are you sure you want to exit this page?"}))}));