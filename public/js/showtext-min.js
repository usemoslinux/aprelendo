$(document).ready((function(){var e,t,a,n,o,r=!1,i=!1,s=null,l=null,d="",p="",u="",c=2,h=!1,g=0,m=0;window.parent.show_confirmation_dialog=!0;var f=$(parent.document),w=f.find("#dicFrame"),v=f.find('iframe[id^="epubjs"]');function y(e){var t=(new Date).getTime(),a=$("#audioplayer");t-e>1e3&&!a.prop("ended")?a.trigger("play"):(!a.prop("paused")&&a.trigger("pause"),l=setTimeout((()=>{y(e)}),1e3))}function x(){var e=s.prevUntil(":contains('.')").last();e=e.length>0?e:s;var t=s.prev().nextUntil(":contains('.')").last().next();t=t.length>0?t:s.nextAll().last().next();var a=e.nextUntil(t).addBack().next().addBack().text().replace(/(\r\n|\n|\r)/gm," ");return p.replace("%s",encodeURI(a))}function b(){var e=[],t=[],a="",n=!0,o=$("#is_shared").length>0,r=0;$(".learning").each((function(){a=$(this).text().toLowerCase(),-1==$.inArray(a,e)&&e.push(a)})),t.push($("#text-container").attr("data-textID")),o&&(t=void 0,n=void 0),$.ajax({type:"POST",url:"/ajax/archivetext.php",data:{words:e,textIDs:JSON.stringify(t),archivetext:n}}).done((function(e){if(null==e.error_msg){var t={words:{new:$(".reviewing.new").length,learning:$(".reviewing.learning").length,forgotten:$(".reviewing.forgotten").length},texts:{reviewed:1}};$.ajax({type:"post",url:"ajax/updateuserscore.php",data:t}).done((function(e){if(null==e.error_msg){r=e.gems_earned,window.parent.show_confirmation_dialog=!1;var t=Number($(".word").length)+Number($(".phrase").length),a=$('<form action="/textstats.php" method="post"><input type="hidden" name="created" value="'+$(".reviewing.new").length+'" /><input type="hidden" name="reviewed" value="'+$(".reviewing.learning").length+'" /><input type="hidden" name="learned" value="'+$(".learned").length+'" /><input type="hidden" name="forgotten" value="'+$(".reviewing.forgotten").length+'" /><input type="hidden" name="total" value="'+t+'" /><input type="hidden" name="gems_earned" value="'+r+'" /><input type="hidden" name="is_shared" value="'+$("#is_shared").length+'" /></form>');$("body").append(a),a.submit()}else alert("Oops! There was an unexpected error.")})).fail((function(e,t,a){alert("Oops! There was an unexpected error.")}))}else alert("Oops! There was an unexpected error.")})).fail((function(e,t,a){alert("Oops! There was an unexpected error.")}))}function k(){var e=$("#audioplayer");e.prop("currentTime","0"),e.trigger("play")}function C(){0!=$("#audioplayer").find("source").attr("src")&&(0==$(".dict-answer").length?($(".learning, .new, .forgotten").each((function(e,t){var a=$(this),n=a.text().length,o=a.width(),r=a.css("font-size");a.hide().after('<div class="input-group dict-input-group"><input type="text" class="dict" style="width:'+o+"px; line-height:"+r+';" maxlength="'+n+'" data-text="'+a.text()+'"><span class="input-group-append dict-answer d-none"></span></div>')})),$("html, body").animate({scrollTop:0},"slow"),k(),$(":text:first").focus()):($(".learning, .new, .forgotten").each((function(e,t){$(this).show().nextAll(":lt(1)").remove()})),$("html, body").animate({scrollTop:0},"slow"),$("#audioplayer").trigger("pause")))}function T(){0!=$("#audioplayer").find("source").attr("src")||(0==$(".learning, .new, .forgotten").length?($("#btn-next-phase").html('Finish & Save<br><span class="small">Skipped some phases: no audio detected & no underlined words</span>'),c=6):($("#btn-next-phase").html('Go to phase 5<br><span class="small">Skipped some phases: no audio detected</span>'),c=5))}function _(){var e=$("#audioplayer");if(!(e.length>0))return!1;var t=$("#text").text(),a=$("html").attr("lang");$.ajax({type:"POST",url:"/ajax/fetchaudiostream.php",data:{text:t,langiso:a},dataType:"json"}).done((function(t){return null==t.error&&t.response?($("#audio-mp3").attr("src",t.response),e[0].load(),$("#audioplayer-loader").addClass("d-none"),$("#audioplayer").removeClass("d-none"),$("#audioplayer-speedbar").removeClass("d-none"),!0):($("#audioplayer-loader").addClass("d-none"),$("#alert-msg-audio").removeClass("d-none").empty().append('There was an unexpected error trying to create audio from this text. <a class="alert-link" href="#" id="retry-audio-load">Try again</a> later.'),T(),!1)})).fail((function(e){return 403==e.status?($("#audioplayer-loader").addClass("d-none"),$("#alert-msg-audio").removeClass("d-none").empty().append('You have reached your audio streaming limit for today. Although it is possible to continue with the revision of the text, we do not recommend it. Alternatively, you can try again tomorrow or <a class="alert-link" href="gopremium.php">improve your plan</a> to increase your daily audio streaming limit.')):($("#audioplayer-loader").addClass("d-none"),$("#alert-msg-audio").removeClass("d-none").empty().append('There was an unexpected error trying to create audio from this text. <a class="alert-link" href="#" id="retry-audio-load">Try again</a> later.')),T(),!1}))}v=v.length>0?v:$("html"),_(),"text"==$("#text-container").data("type")&&$.ajax({type:"POST",url:"/ajax/getuserwords.php",data:{txt:$("#text").text()},dataType:"json"}).done((function(e){$("#text").html(underlineWords(e))})).fail((function(e,t,a){})).always((function(){T()})),$(window).on("keydown",(function(e){var t=$("#audioplayer");if(t.length&&e.ctrlKey)switch(e.keyCode){case 32:t.prop("paused")?t.trigger("play"):t.trigger("pause");break}})),$("body").on("input","input:text",(function(e){var t=(new Date).getTime();9!=(e.keyCode||e.which)&&(clearTimeout(l),y(t))})),$("body").on("click","#btn-abloop",(function(e){e.preventDefault(),e.stopPropagation(),0==g&&0==m?(g=$("#audioplayer").prop("currentTime"),$(this).text("B")):g>0&&0==m?(m=$("#audioplayer").prop("currentTime"),$(this).text("C")):(g=m=0,$(this).text("A"))})),$("#audioplayer").on("timeupdate",(function(){m>0&&$(this).prop("currentTime")>=m&&$(this).prop("currentTime",g)})),$(document).on("contextmenu",(function(e){e.preventDefault()})),$(document).on("mousedown touchstart",".word",(function(n){n.stopPropagation(),n.which<2?(r=!0,e=t=$(this),"touchstart"==n.type&&(a=new Date,o=e.offset().top-$(window).scrollTop())):3==n.which&&(s=$(this),window.open(x()))})),$(document).on("mouseup touchend",".word",(function(o){if(o.stopPropagation(),o.preventDefault(),n=new Date,"touchend"==o.type&&(i||(r=n-a>1e3),$("html").css({overflow:"visible"}),i=!1),r&&o.which<2){if(r=!1,e===t){var l=$(this).closest(".learning, .learned, .forgotten");s=l.length?l:$(this)}!function(){var e=$("#audioplayer"),t=$("html").attr("lang");e.length&&(!e.prop("paused")&&e.prop("currentTime")?(e.trigger("pause"),h=!0):h=!1);r=s.text(),i=t,l=f.find("#bdgfreqlvl"),$.ajax({type:"GET",url:"/ajax/getwordfreq.php",data:{word:r,lg_iso:i}}).done((function(e){0==e?l.hide():e<81?l.hide().text("High frequency word").removeClass().addClass("badge badge-danger").show():e<97&&l.hide().text("Medium frequency word").removeClass().addClass("badge badge-warning").show()})).fail((function(){l.hide()})),a=$(parent.document).find("#btnremove"),n=$(parent.document).find("#btnadd"),o=s.filter(".learning, .new, .forgotten, .learned").length,s.filter(".word").length==o?!1===a.is(":visible")&&(a.show(),n.text("Forgot")):(a.hide(),n.text("Add")),f.find("#iframe-loader").attr("class","lds-ripple m-auto"),w.attr("class","d-none"),u=x();var a,n,o;var r,i,l;var p=s.text().replace(/\r?\n|\r/gm," "),c=d.replace("%s",encodeURIComponent(p));w.get(0).contentWindow.location.replace(c),$("#btnadd").focus(),f.find("#myModal").modal("show")}()}a=n=new Date})),$.fn.isAfter=function(e){return this.prevUntil(e).length!==this.prevAll().length},$(document).on("mouseover touchmove",".word",(function(l){if(l.stopPropagation(),n=new Date,"touchmove"==l.type){var d=$(this).offset().top-$(window).scrollTop();(i=i||Math.abs(o-d)>0)||(r=n-a>1e3)}r&&("touchmove"==l.type&&$("html").css({overflow:"hidden"}),$(".word").removeClass("highlighted"),(t="mouseover"===l.type?$(this):$(document.elementFromPoint(l.originalEvent.touches[0].clientX,l.originalEvent.touches[0].clientY))).isAfter(e)?(e.nextUntil(t.next(),".word").addBack().addClass("highlighted"),s=e.nextUntil(t.next()).addBack()):(e.prevUntil(t.prev(),".word").addBack().addClass("highlighted"),s=t.nextUntil(e.next()).addBack()))})),$.ajax({url:"/ajax/getdicuris.php",type:"GET",dataType:"json"}).done((function(e){null==e.error_msg&&(d=e.dictionary_uri,p=e.translator_uri)})),w.on("load",(function(){f.find("#iframe-loader").attr("class","d-none"),w.removeClass()})),f.on("click","#btn-translate",(function(){window.open(u)})),f.on("click","#btnadd",(function(){var e=s.length>1?1:0,t=s.text(),a=0!=$("#audioplayer").find("source").attr("src");$.ajax({type:"POST",url:"/ajax/addword.php",data:{word:t,is_phrase:e}}).done((function(){var n=0==$(".learning, .new, .forgotten").length;if(e){var o=s.filter(".word").length;v.contents().find("span.word").filter((function(){return $(this).text().toLowerCase()===s.eq(0).text().toLowerCase()})).each((function(){var e=$(this).nextAll("span.word").slice(0,o-1).last(),a=$(this).nextUntil(e).addBack().next("span.word").addBack();a.text().toLowerCase()===t.toLowerCase()&&(a.wrapAll("<span class='word reviewing new' data-toggle='modal' data-target='#myModal'></span>"),a.contents().unwrap())}))}else{var r=v.contents().find("span.word").filter((function(){return $(this).text().toLowerCase()===t.toLowerCase()}));r.each((function(){var e=$(this);e.is(".new, .learning, .learned, .forgotten")?e.wrap("<span class='word reviewing forgotten' data-toggle='modal' data-target='#myModal'></span>"):e.wrap("<span class='word reviewing new' data-toggle='modal' data-target='#myModal'></span>")})),r.contents().unwrap()}6==c&&n&&(a?($("#btn-next-phase").html('Go to phase 4<br><span class="small">Writing</span>'),c=4):T())})).fail((function(e,t,a){alert("Oops! There was an error adding this word or phrase to the database.")})),s.removeClass("highlighted")})),f.on("click","#btnremove",(function(){var e=0!=$("#audioplayer").find("source").attr("src");$.ajax({type:"POST",url:"/ajax/removeword.php",data:{word:s.text()}}).done((function(){var t=v.contents().find("span.word").filter((function(){return $(this).text().toLowerCase()===s.text().toLowerCase()}));$.ajax({type:"POST",url:"/ajax/getuserwords.php",data:{txt:s.text()},dataType:"json"}).done((function(a){var n=$(underlineWords(a)),o={},r=/""/;t.each((function(){o=$(this),n.filter(".word").each((function(e){r=new RegExp("(?<![\\p{L}|^])"+$(this).text()+"(?![\\p{L}|$])","iug").exec(o.text()),$(this).text(r);var t=$(this).text().toLowerCase(),n=a.user_words.find((function(e){return e.word==t}));void 0!==n&&(2==n.status?$(this).removeClass("learning").addClass("new"):3==n.status&&$(this).removeClass("learning").addClass("forgotten"))})),o.replaceWith(n.clone())})),4==c&&e>0&&0==$(".learning, .new, .forgotten").length&&($("#btn-next-phase").html('Finish & Save<br><span class="small">Skipped phase 4 (writing) & 5 (reviewing): no underlined words</span>'),c=6)}))})).fail((function(e,t,a){alert("Oops! There was an error removing the word from the database.")}))})),$("body").on("click","#btn-next-phase",(function(){var e=0!=$("#audioplayer").find("source").attr("src"),t=$("#alert-msg-phase");switch(c<6&&!e&&T(),c){case 2:$("html, body").animate({scrollTop:0},"slow"),c++,t.html('<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button><h5>Assisted learning - Phase 2: Listening</h5><span class="small">Pay attention to the pronunciation of each word. You can slow down the audio if necessary.</span>'),$(this).html('Go to phase 3<br><span class="small">Speaking</span>'),k();break;case 3:$("html, body").animate({scrollTop:0},"slow"),0==$(".learning, .new, .forgotten").length?($(this).html('Finish & Save<br><span class="small">Skipped phase 4 (writing) & 5 (reviewing): no underlined words</span>'),c=6):($(this).html('Go to phase 4<br><span class="small">Writing</span>'),c++),t.html('<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button><h5>Assisted learning - Phase 3: Speaking</h5><span class="small">Read the text out loud and try to emulate the pronunciation of each word as you listen to the audio. You can slow it down if necessary.</span>'),k();break;case 4:$("html, body").animate({scrollTop:0},"slow"),c++,$(this).html('Go to phase 5<br><span class="small">Reviewing</span>'),t.html('<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button><h5>Assisted learning - Phase 4: Writing</h5><span class="small">Fill in the blanks as you listen to the dictation.</span>'),C();break;case 5:$("html, body").animate({scrollTop:0},"slow"),c++,$(this).html("Finish & Save"),t.html('<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button><h5>Assisted learning - Phase 5: Reviewing</h5><span class="small"><u>This is the most <a href="https://en.wikipedia.org/wiki/Testing_effect" class="alert-link" target="_blank" rel="noopener noreferrer">critical phase</a> for long-term language acquisition.</u><br>Review all the underlined words, even the ones with green underlining. Make an effort to remember their meaning and pronunciation, while also paying attention to their spelling. Speak out alternative sentences using these words. The latter is essential to turn your <a href="https://en.wiktionary.org/wiki/passive_vocabulary" class="alert-link" target="_blank" rel="noopener noreferrer">passive vocabulary</a> into <a href="https://en.wiktionary.org/wiki/active_vocabulary" class="alert-link" target="_blank" rel="noopener noreferrer">active vocabulary</a>.</span>'),C();break;case 6:b();break;default:break}})),$("body").on("click","#btn-save",b),f.on("hidden.bs.modal","#myModal",(function(){var e=$("#audioplayer");h&&e.length&&e.trigger("play"),s.removeClass("highlighted")})),$("body").on("input change","#range-speed",(function(){var e=parseFloat($(this).val()).toFixed(1);$("#currentpbr").text(e),$("#audioplayer").prop("playbackRate",e)})),$("body").on("click","#btndictation",(function(){C()})),$("body").on("blur",":text",(function(){var e=$(this);e.val().toLowerCase()==e.attr("data-text").toLowerCase()?(e.css("border-color","green"),e.next("span").not(".d-none").addClass("d-none")):""!=$.trim(e.val())&&(e.css("border-color","crimson"),e.next("span").removeClass("d-none").addClass("dict-wronganswer").text("[ "+e.attr("data-text")+" ]"))})),$("body").on("input",".dict",(function(e){if(13===e.which){var t=$(".dict").index(this)+1;$(".dict").eq(t).focus()}})),f.on("click","#retry-audio-load",(function(e){e.preventDefault(),$("#alert-msg-audio").addClass("d-none"),$("#audioplayer-loader").removeClass("d-none"),_()})),$(document).on("click",v,(function(e){if(!1===$(e.target).is(".word")){e.stopPropagation();var t=$("#text-container").length?$("#text-container"):v.contents();r=!1,$("html").css({overflow:"visible"}),t.find(".highlighted").removeClass("highlighted")}})),$(window.parent).on("beforeunload",(function(){if(window.parent.show_confirmation_dialog)return"To save your progress, please click the Save button before you go. Otherwise, your changes will be lost. Are you sure you want to exit this page?"}))}));