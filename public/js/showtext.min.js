$(document).ready((function(){let e,t,n,a,o,i=!1,r=!1,s=null,l="",d="",c="",u="",p=2,h=!1;window.parent.show_confirmation_dialog=!0;let g=$("html").attr("lang"),w=$(parent.document),f=w.find("#dicFrame"),m=w.find('iframe[id^="epubjs"]');function y(){let e=$("#audioplayer");e.length&&(!e.prop("paused")&&e.prop("currentTime")?(e.trigger("pause"),h=!0):h=!1),getWordFrequency(s.text(),g),setAddDeleteButtons(s),w.find("#loading-spinner").attr("class","lds-ellipsis m-auto"),f.attr("class","d-none"),u=buildTextTranslationLink(c,s),f.get(0).contentWindow.location.replace(buildDictionaryLink(l,s.text())),$("#btn-add").focus(),w.find("#dic-modal").modal("show")}function b(){let e=[],t=[],n="",a=!0;const o=$("#is_shared").length>0;let i=0;$(".learned, .learning").each((function(){n=$(this).text().toLowerCase(),-1==$.inArray(n,e)&&e.push(n)})),t.push($("#text-container").attr("data-IdText")),o&&(t=void 0,a=void 0),$.ajax({type:"POST",url:"/ajax/archivetext.php",data:{words:e,textIDs:JSON.stringify(t),archivetext:a}}).done((function(e){if(null==e.error_msg){const e={words:{new:getUniqueElements(".reviewing.new"),learning:getUniqueElements(".reviewing.learning"),forgotten:getUniqueElements(".reviewing.forgotten")},texts:{reviewed:1}};$.ajax({type:"post",url:"ajax/updateuserscore.php",data:e}).done((function(e){if(null==e.error_msg){i=e.gems_earned,window.parent.show_confirmation_dialog=!1;const t="/textstats",n=Number($(".word").length)+Number($(".phrase").length),a=$('<form action="'+t+'" method="post"><input type="hidden" name="created" value="'+$(".reviewing.new").length+'" /><input type="hidden" name="reviewed" value="'+$(".reviewing.learning").length+'" /><input type="hidden" name="learned" value="'+$(".learned").length+'" /><input type="hidden" name="forgotten" value="'+$(".reviewing.forgotten").length+'" /><input type="hidden" name="total" value="'+n+'" /><input type="hidden" name="gems_earned" value="'+i+'" /><input type="hidden" name="is_shared" value="'+$("#is_shared").length+'" /></form>');$("body").append(a),a.submit()}else alert("Oops! There was an unexpected error updating user score.")})).fail((function(e,t,n){alert("Oops! There was an unexpected error updating user score.")}))}else alert("Oops! There was an error unexpected error saving this text.")})).fail((function(e,t,n){alert("Oops! There was an error unexpected error saving this text.")}))}function x(){if(""!=$("#audioplayer").find("source").attr("src")){let e=$("#text").clone(),t=e.find(".word"),n=$(".word");0==$(".dict-answer").length?(0==$(".learning, .new, .forgotten").length&&(setNewTooltip(document.getElementById("btn-next-phase"),"Finish & Save - 5 (reviewing): no underlined words"),p=6),t.each((function(e,t){let a=$(this);const o=a.text().length,i=n.eq(e).width(),r=n.eq(e).css("font-size");let s="";a.hasClass("learned")?s="green":a.hasClass("learning")?s="orange":a.hasClass("new")?s="DodgerBlue":a.hasClass("forgotten")&&(s="crimson"),a.hide().after('<div class="input-group dict-input-group"><input type="text" class="dict" style="width:'+i+"px; line-height:"+r+"; border-color:"+s+';" maxlength="'+o+'" data-text="'+a.text()+'"><span data-toggle="modal" data-bs-target="#dic-modal" class="dict-answer d-none"></span></div>')})),$("#text").replaceWith(e),$("html, body").animate({scrollTop:0},"fast"),$("#range-speed").trigger("change",[{cpbr:.5}]),playAudioFromBeginning(),$(":text:first").focus()):(t.each((function(e,t){$(this).show().nextAll(":lt(1)").remove()})),$("#text").replaceWith(e),$("html, body").animate({scrollTop:0},"fast"),$("#audioplayer").trigger("pause"))}}function v(){const e=""!=$("#audioplayer").find("source").attr("src"),t=document.getElementById("btn-next-phase");e||(0==$(".learning, .new, .forgotten").length?(setNewTooltip(t,"Finish & Save - Skipped some phases: no audio detected & no underlined words"),p=6):(setNewTooltip(t,"Go to phase 5: Reviewing - Skipped some phases: no audio detected"),p=5))}function k(){let e=$("#audioplayer"),t=$("#audio-source").attr("src");if(!(e.length>0&&""===t)||$("#readerpage > :first").is("#navigation"))return!1;{const t=$("#text").text();$.ajax({type:"POST",url:"/ajax/fetchaudiostream.php",data:{text:t,langiso:g},dataType:"json"}).done((function(t){return null==t.error&&t.response?($("#audio-source").attr("src",t.response),e[0].load(),$("#audioplayer-loader").addClass("d-none"),$("#audioplayer-container").removeClass("d-none"),setNewTooltip(document.getElementById("btn-next-phase"),"Go to phase 2: Listening"),p=2,!0):($("#audioplayer-loader").addClass("d-none"),$("#alert-box-audio").removeClass("d-none").empty().append('There was an unexpected error trying to create audio from this text. <a class="alert-link" href="#" id="retry-audio-load">Try again</a> later.'),v(),!1)})).fail((function(e){return 403==e.status?($("#audioplayer-loader").addClass("d-none"),$("#alert-box-audio").removeClass("d-none").empty().append("You have reached your audio streaming limit. Try again tomorrow.")):($("#audioplayer-loader").addClass("d-none"),$("#alert-box-audio").removeClass("d-none").empty().append('There was an unexpected error trying to create audio from this text. <a class="alert-link" href="#" id="retry-audio-load">Try again</a> later.')),v(),!1}))}}m=m.length>0?m:$("html"),k(),"text"==$("#text-container").data("type")&&$.ajax({type:"POST",url:"/ajax/getuserwords.php",data:{txt:$("#text").text()},dataType:"json"}).done((function(e){$("#text").html(underlineWords(e,g,!1))})).fail((function(e,t,n){})).always((function(){v()})),$(document).on("contextmenu",(function(e){return!/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)&&$(e.target).is(".word")&&window.open(buildTextTranslationLink(c,s),"_blank","noopener,noreferrer"),!1})),$(document).on("mousedown touchstart",".word",(function(a){a.stopPropagation(),a.which<2?(i=!0,e=t=$(this),"touchstart"==a.type&&(n=new Date,o=e.offset().top-$(window).scrollTop())):3==a.which&&(togglePlayPause(),$("#audioplayer").trigger("pause"),s=$(this))})),$(document).on("mouseup touchend",".word",(function(o){if(o.stopPropagation(),a=new Date,"touchend"==o.type&&(r||(i=a-n>1e3),$("html").enableScroll(),r=!1),i&&o.which<2){if(i=!1,e===t){let e=$(this).closest(".learning, .learned, .forgotten");s=e.length?e:$(this)}y()}n=a=new Date})),$.fn.isAfter=function(e){return this.prevUntil(e).length!==this.prevAll().length},$(document).on("mouseover touchmove",".word",(function(l){if(l.stopPropagation(),a=new Date,"touchmove"==l.type){const e=$(this).offset().top-$(window).scrollTop();r=r||Math.abs(o-e)>0,r||(i=a-n>1e3)}i&&("touchmove"==l.type&&$("html").disableScroll(),$(".word").removeClass("highlighted"),t="mouseover"===l.type?$(this):$(document.elementFromPoint(l.originalEvent.touches[0].clientX,l.originalEvent.touches[0].clientY)),t.isAfter(e)?(e.nextUntil(t.next(),".word").addBack().addClass("highlighted"),s=e.nextUntil(t.next()).addBack()):(e.prevUntil(t.prev(),".word").addBack().addClass("highlighted"),s=t.nextUntil(e.next()).addBack()))})),$(document).on("click",".dict-answer",(function(e){e.stopPropagation(),s=$(this).parent().prev(),y()})),$.ajax({url:"/ajax/getdicuris.php",type:"GET",dataType:"json"}).done((function(e){null==e.error_msg&&(l=e.dictionary_uri,d=e.img_dictionary_uri,c=e.translator_uri)})),$.fn.disableScroll=function(){window.oldScrollPos=$(window).scrollTop(),$(window).on("scroll.scrolldisabler",(function(e){$(window).scrollTop(window.oldScrollPos),e.preventDefault()}))},$.fn.enableScroll=function(){$(window).off("scroll.scrolldisabler")},f.on("load",(function(){w.find("#loading-spinner").attr("class","d-none"),f.removeClass()})),w.on("click","#btn-translate",(function(){window.open(u,"_blank","noopener,noreferrer")})),w.on("click","#btn-img-dic",(function(){window.open(buildDictionaryLink(d,s.text()),"_blank","noopener,noreferrer")})),w.on("click","#btn-add",(function(){const e=s.length>1?1:0,t=s.text(),n=""!=$("#audioplayer").find("source").attr("src");$.ajax({type:"POST",url:"/ajax/addword.php",data:{word:t,is_phrase:e}}).done((function(){const a=0==$(".learning, .new, .forgotten").length,o=5==p?"style='display: none;'":"";if(e){const e=s.filter(".word").length;m.contents().find("a.word").filter((function(){return $(this).text().toLowerCase()===s.eq(0).text().toLowerCase()})).each((function(){let n=$(this).nextAll("a.word").slice(0,e-1).last(),a=$(this).nextUntil(n).addBack().next("a.word").addBack();a.text().toLowerCase()===t.toLowerCase()&&(a.wrapAll("<a class='word reviewing new' data-toggle='modal' data-bs-target='#dic-modal' "+o+"></a>"),a.contents().unwrap())}))}else{let e=m.contents().find("a.word").filter((function(){return $(this).text().toLowerCase()===t.toLowerCase()}));e.each((function(){let e=$(this);e.is(".new, .learning, .learned, .forgotten")?e.wrap("<a class='word reviewing forgotten' data-toggle='modal' data-bs-target='#dic-modal' "+o+"></a>"):e.wrap("<a class='word reviewing new' data-toggle='modal' data-bs-target='#dic-modal' "+o+"></a>")})),e.contents().unwrap()}if(6==p&&a)if(n){let e=document.getElementById("btn-next-phase");setNewTooltip(e,"Go to phase 4: Writing (be patient, may take a while to load depending on text length)"),p=4}else v()})).fail((function(e,t,n){alert("Oops! There was an error adding this word or phrase to the database.")})),s.removeClass("highlighted")})),w.on("click","#btn-remove",(function(){$.ajax({type:"POST",url:"/ajax/removeword.php",data:{word:s.text()}}).done((function(){let e=m.contents().find("a.word").filter((function(){return $(this).text().toLowerCase()===s.text().toLowerCase()}));$.ajax({type:"POST",url:"/ajax/getuserwords.php",data:{txt:s.text()},dataType:"json"}).done((function(t){let n=$(underlineWords(t,g,5==p)),a={},o=/""/;e.each((function(){a=$(this),n.filter(".word").each((function(e){o=langs_with_no_word_separator.includes(g)?new RegExp("(?<![^])"+$(this).text()+"(?![$])","iug").exec(a.text()):new RegExp("(?<![\\p{L}|^])"+$(this).text()+"(?![\\p{L}|$])","iug").exec(a.text()),$(this).text(o);const n=$(this).text().toLowerCase(),i=t.user_words.find((function(e){return e.word==n}));void 0!==i&&(2==i.status?$(this).removeClass("learning").addClass("new"):3==i.status&&$(this).removeClass("learning").addClass("forgotten"))})),a.replaceWith(n.clone())}))}))})).fail((function(e,t,n){alert("Oops! There was an error removing the word from the database.")}))})),$("body").on("click","#btn-next-phase",(function(){const e=""!=$("#audioplayer").find("source").attr("src"),t=document.getElementById("btn-next-phase");let n=$("#alert-box-phase");switch(p<6&&!e&&v(),p){case 2:$("html, body").animate({scrollTop:0},"fast"),p++,n.html('<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button><h5 class="alert-heading">Assisted learning - Phase 2: Listening</h5><span class="small">Pay attention to the pronunciation of each word. You can slow down the audio if necessary.</span>'),setNewTooltip(document.getElementById("btn-next-phase"),"Go to phase 3: Speaking"),playAudioFromBeginning();break;case 3:$("html, body").animate({scrollTop:0},"fast"),p++,setNewTooltip(t,"Go to phase 4: Writing (be patient, may take a while to load depending on text length)"),n.html('<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button><h5 class="alert-heading">Assisted learning - Phase 3: Speaking</h5><span class="small">Read the text out loud and try to emulate the pronunciation of each word as you listen to the audio. You can slow it down if necessary.</span>'),playAudioFromBeginning();break;case 4:$("html, body").animate({scrollTop:0},"fast"),0==$(".learning, .new, .forgotten").length?(setNewTooltip(t,"Finish & Save - Skipped phase 5 (reviewing): no underlined words</span>"),p=6):(setNewTooltip(t,"Go to phase 5: Reviewing"),p++),n.html('<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button><h5 class="alert-heading">Assisted learning - Phase 4: Writing</h5><span class="small">Fill in the blanks as you listen to the dictation. To toggle audio playback press <kbd>2</kbd>. To rewind or fast-forward 5 seconds, use <kbd>1</kbd> and <kbd>3</kbd>. You can also click on the hint beside any misspelled word to include it in your word list. We recommend you do this once the dictation is complete and you are reviewing your mistakes.</span>'),x();break;case 5:$("html, body").animate({scrollTop:0},"fast"),p++,setNewTooltip(t,"Finish & Save"),n.html('<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button><h5 class="alert-heading">Assisted learning - Phase 5: Reviewing</h5><span class="small"><u>This is the most <a href="https://en.wikipedia.org/wiki/Testing_effect" class="alert-link" target="_blank" rel="noopener noreferrer">critical phase</a> for long-term language acquisition.</u><br>Review all the underlined words, even the ones with green underlining. Make an effort to remember their meaning and pronunciation, while also paying attention to their spelling. Speak out alternative sentences using these words. The latter is essential to turn your <a href="https://en.wiktionary.org/wiki/passive_vocabulary" class="alert-link" target="_blank" rel="noopener noreferrer">passive vocabulary</a> into <a href="https://en.wiktionary.org/wiki/active_vocabulary" class="alert-link" target="_blank" rel="noopener noreferrer">active vocabulary</a>.</span>'),x();break;case 6:b();break;default:break}})),$("body").on("click","#btn-save-text",b),$("#btn-toggle-audio-player-controls").on("click",(function(){let e=$("#audioplayer-container");"static"==e.css("position")?e.css({position:"sticky"}):e.css({position:"static"})})),w.on("hidden.bs.modal","#dic-modal",(function(){let e=$("#audioplayer");h&&e.length&&e.trigger("play"),s.removeClass("highlighted")})),$("body").on("input change","#range-speed",(function(e,t){const n=void 0!==t?t.cpbr:parseFloat($(this).val()).toFixed(1);$(this).val(n),$("#currentpbr").text(n),$("#audioplayer").prop("playbackRate",n)})),$("body").on("blur",".dict",(function(){let e=$(this);e.val().toLowerCase()==e.attr("data-text").toLowerCase()?(e.css("border-color","green"),e.next("span").not(".d-none").addClass("d-none")):""!=$.trim(e.val())&&(e.css("border-color","crimson"),e.next("span").removeClass("d-none").addClass("dict-wronganswer").text("[ "+e.attr("data-text")+" ]"))})),$("body").on("keydown",".dict",(function(e){const t=e.keyCode||e.which;if(!e.isComposing&&0!=t&&229!=t&&!$(this).val())if(8==t){const t=$(".dict").index(this)-1;e.preventDefault(),$(".dict").eq(t).focus()}else 32==t&&e.preventDefault()})),$("body").on("input",".dict",(function(e){let t=e.keyCode||e.which;const n=$(this).attr("maxlength"),a=$("#audioplayer")[0].currentTime;switch(0!=t&&229!=t||(t=e.target.value.charAt(e.target.selectionStart-1).charCodeAt()),t){case 8:if(!$(this).val()){const e=$(".dict").index(this)-1;$(".dict").eq(e).focus()}break;case 49:$("#audioplayer")[0].currentTime=a-5;break;case 50:togglePlayPause();break;case 51:$("#audioplayer")[0].currentTime=a+5;break;default:break}if($(this).val($(this).val().replace(/\d/gi,"")),n==$(this).val().length&&!e.originalEvent.isComposing){const e=$(".dict").index(this)+1;$(".dict").eq(e).focus()}})),w.on("click","#retry-audio-load",(function(e){e.preventDefault(),$("#alert-box-audio").addClass("d-none"),$("#audioplayer-loader").removeClass("d-none"),k()})),$(document).on("click",m,(function(e){if(!1===$(e.target).is(".word")){e.stopPropagation();let t=$("#text-container").length?$("#text-container"):m.contents();i=!1,$("html").enableScroll(),t.find(".highlighted").removeClass("highlighted")}})),$(window.parent).on("beforeunload",(function(e){if(window.parent.show_confirmation_dialog)return e.preventDefault(),"To save your progress, please click the Save button before you go."}))}));