$(document).ready((function(){var e,t,n,a,r,o=document.querySelector("video"),i=!1,d=!1,s=null,l="",c="",u="",h=!1,p=!0,g=0,f=$("html").attr("lang"),w=.01*window.innerHeight;function v(){var e=s.prevUntil(":contains('.')").last();e=e.length>0?e:s;var t=s.prev().nextUntil(":contains('.')").last().next();t=t.length>0?t:s.nextAll().last().next();var n=e.nextUntil(t).addBack().next().addBack().text().replace(/(\r\n|\n|\r)/gm," ");return c.replace("%s",encodeURIComponent(n))}document.documentElement.style.setProperty("--vh",`${w}px`),$.ajax({url:"ajax/getdicuris.php",type:"GET",dataType:"json"}).done((function(e){null==e.error_msg&&(l=e.dictionary_uri,c=e.translator_uri)})),$(document).on("contextmenu",".word",(function(e){return e.preventDefault(),!1})),$(document).on("mousedown touchstart",".word",(function(a){a.stopPropagation(),o.paused||(o.pause(),h=!0),a.which<2?(i=!0,e=t=$(this),"touchstart"==a.type&&(n=new Date,r=e.offset().top-$(window).scrollTop())):3==a.which&&(s=$(this),window.open(v()))})),$(document).on("mouseup touchend",".word",(function(r){r.stopPropagation(),a=new Date,"touchend"==r.type&&(d||(i=a-n>1e3),$("html").css({overflow:"visible"}),d=!1),i&&r.which<2&&(i=!1,e===t&&(s=$(this)),function(){a=s.text(),r=f,o=$("#bdgfreqlvl"),$.ajax({type:"GET",url:"/ajax/getwordfreq.php",data:{word:a,lg_iso:r}}).done((function(e){0==e?o.hide():e<81?o.hide().text("High frequency word").removeClass().addClass("badge badge-danger").show():e<97&&o.hide().text("Medium frequency word").removeClass().addClass("badge badge-warning").show()})).fail((function(){o.hide()})),e=$("#btnremove"),t=$("#btnadd"),n=s.filter(".learning, .new, .forgotten, .learned").length,s.filter(".word").length==n?!1===e.is(":visible")&&(e.show(),t.text("Forgot")):(e.hide(),t.text("Add")),$("#iframe-loader").attr("class","lds-ellipsis m-auto"),$("#dicFrame").attr("class","d-none"),u=v();var e,t,n;var a,r,o;var i=s.text().replace(/(\r\n|\n|\r)/gm," "),d=l.replace("%s",encodeURIComponent(i));$(parent.document).find("#dicFrame").get(0).contentWindow.location.replace(d),$("#btnadd").focus(),$(parent.document).find("#myModal").modal("show")}())})),$.fn.isAfter=function(e){return this.prevUntil(e).length!==this.prevAll().length},$(document).on("mouseover touchmove",".word",(function(o){if(o.stopPropagation(),a=new Date,"touchmove"==o.type){var l=$(this).offset().top-$(window).scrollTop();(d=d||Math.abs(r-l)>0)||(i=a-n>1e3)}i&&("touchmove"==o.type&&$("html").css({overflow:"hidden"}),$(".word").removeClass("highlighted"),t="mouseover"===o.type?$(this):$(document.elementFromPoint(o.originalEvent.touches[0].clientX,o.originalEvent.touches[0].clientY)),e.parent().get(0)===t.parent().get(0)?t.isAfter(e)?(e.nextUntil(t.next(),".word").addBack().addClass("highlighted"),s=e.nextUntil(t.next()).addBack()):(e.prevUntil(t.prev(),".word").addBack().addClass("highlighted"),s=t.nextUntil(e.next()).addBack()):t=s=e)})),$("#btnadd").on("click",(function(){var e=s.text(),t=s.length>1?1:0;$.ajax({type:"POST",url:"ajax/addword.php",data:{word:e.toLowerCase(),is_phrase:t}}).done((function(){if(t){var n=s.eq(0).text(),a=s.filter(".word").length;$("a.word").filter((function(){return $(this).text().toLowerCase()===n.toLowerCase()})).each((function(){var t=$(this).nextAll("a.word").slice(0,a-1).last(),n=$(this).nextUntil(t).addBack().next("a.word").addBack();n.text().toLowerCase()===e.toLowerCase()&&(n.wrapAll("<a class='word reviewing new' data-toggle='modal' data-target='#myModal'></a>"),n.contents().unwrap())}))}else{var r=$("a.word").filter((function(){return $(this).text().toLowerCase()===e.toLowerCase()}));r.each((function(){var e=$(this);e.is(".new, .learning, .learned, .forgotten")?e.wrap("<a class='word reviewing forgotten' data-toggle='modal' data-target='#myModal'></a>"):e.wrap("<a class='word reviewing new' data-toggle='modal' data-target='#myModal'></a>")})),r.contents().unwrap()}})).fail((function(e,t,n){alert("Oops! There was an error adding this word or phrase to the database.")}))})),$(window).on("resize",(function(){w=.01*window.innerHeight,document.documentElement.style.setProperty("--vh",`${w}px`)})),$("#btnremove").on("click",(function(){$.ajax({type:"POST",url:"ajax/removeword.php",data:{word:s.text().toLowerCase()}}).done((function(){var e=$("a.word").filter((function(){return $(this).text().toLowerCase()===s.text().toLowerCase()}));$.ajax({type:"POST",url:"/ajax/getuserwords.php",data:{txt:s.text()},dataType:"json"}).done((function(t){var n=$(underlineWords(t,f)),a={},r=/""/;e.each((function(){a=$(this),n.filter(".word").each((function(e){r=langs_with_no_word_separator.includes(f)?new RegExp("(?<![^])"+$(this).text()+"(?![$])","iug").exec(a.text()):new RegExp("(?<![\\p{L}|^])"+$(this).text()+"(?![\\p{L}|$])","iug").exec(a.text()),$(this).text(r);var n=$(this).text().toLowerCase(),o=t.user_words.find((function(e){return e.word==n}));void 0!==o&&(2==o.status?$(this).removeClass("learning").addClass("new"):3==o.status&&$(this).removeClass("learning").addClass("forgotten"))})),a.replaceWith(n.clone())}))})).fail((function(e,t,n){}))})).fail((function(e,t,n){alert("Oops! There was an error removing the word from the database.")}))})),$("#btn-save-offline-video").on("click",(function(){var e=[],t=[],n="";$(".learning").each((function(){n=$(this).text().toLowerCase(),-1==$.inArray(n,e)&&e.push(n)})),t.push($("#text-container").attr("data-textID")),$.ajax({type:"POST",url:"ajax/archivetext.php",data:{words:e,textIDs:JSON.stringify(t)}}).done((function(e){if(null==e.error_msg){var t={words:{new:$(".reviewing.new").length,learning:$(".reviewing.learning").length,forgotten:$(".reviewing.forgotten").length},texts:{reviewed:1}};$.ajax({type:"post",url:"ajax/updateuserscore.php",data:t}).done((function(e){if(null==e.error_msg){g=e.gems_earned,p=!1;var t=Number($(".word").length)+Number($(".phrase").length),n=$('<form action="/textstats.php" method="post"><input type="hidden" name="created" value="'+$(".reviewing.new").length+'" /><input type="hidden" name="reviewed" value="'+$(".reviewing.learning").length+'" /><input type="hidden" name="learned" value="'+$(".learned").length+'" /><input type="hidden" name="forgotten" value="'+$(".reviewing.forgotten").length+'" /><input type="hidden" name="total" value="'+t+'" /><input type="hidden" name="gems_earned" value="'+g+'" /><input type="hidden" name="is_shared" value="1" /></form>');$("body").append(n),n.submit()}else alert("Oops! There was an unexpected error.")})).fail((function(e,t,n){alert("Oops! There was an unexpected error.")}))}else alert("Oops! There was an unexpected error.")})).fail((function(e,t,n){alert("Oops! There was an error updating the database.")}))})),$("#myModal").on("hidden.bs.modal",(function(){h&&(o.play(),h=!1),s.removeClass("highlighted")})),$("#dicFrame").on("load",(function(){$("#iframe-loader").attr("class","d-none"),$(this).removeClass()})),$("#btn-translate").on("click",(function(){window.open(u)})),$("#text-container").on("click",(function(e){e.preventDefault(),e.stopPropagation(),i=!1,$("#text-container").find(".highlighted").removeClass("highlighted")})),$("#btn-selvideo").on("click",(function(e){e.preventDefault(),$("#video-file-input").trigger("click")})),$("#video-file-input").on("change",(function(){if(this.files[0]){var e=this.files[0],t=e.type;if(o.canPlayType(t)){var n=URL.createObjectURL(e);o.src=n}}})),$("#btn-selsubs").on("click",(function(e){e.preventDefault(),$("#subs-file-input").trigger("click")})),$("#subs-file-input").on("change",(function(){if(this.files[0]){var e=this.files[0];const t=new FileReader;t.addEventListener("load",(e=>{for(var t=e.target.result,n=parser.fromSrt(t,!0),a="",r=0;r<n.length;r++){var o=n[r],i='<div class="text-center"';for(var d in o){var s=o[d];switch(d){case"startTime":i+=' data-start="'+s+'"';break;case"endTime":i+=' data-end="'+s+'"';break;case"text":i+=">"+s;break;default:break}}a+=i+="</div>"}document.getElementById("text-container").innerHTML=a,$.ajax({type:"POST",url:"/ajax/getuserwords.php",data:{txt:$("#text-container").html()},dataType:"json"}).done((function(e){$("#text-container").html(underlineWords(e,f))})).fail((function(e,t,n){}))})),t.readAsText(e)}})),$("#video-stream").on("timeupdate",(function(e){var t=1e3*document.getElementById("video-stream").currentTime,n=$("div.text-center","#text-container"),a=n.filter((function(){return $(this).attr("data-start")<t})).last();a.length>0&&!a.hasClass("video-reading-line")&&(n.removeClass("video-reading-line"),a.addClass("video-reading-line"),a[0].scrollIntoView({behavior:"auto",block:"center",inline:"center"}))})),$(window).on("beforeunload",(function(){if(p)return"To save your progress, please click the Save button before you go. Otherwise, your changes will be lost. Are you sure you want to exit this page?"}))}));