$(document).ready((function(){const e=$("html").attr("lang"),t=$("script[src*='showebook-min.js']").attr("data-id"),n=ePub();window.parent.show_confirmation_dialog=!1;let o=document.getElementById("viewer");(new FormData).append("id",t),fetch("ajax/getebook.php?id="+t).then((function(e){if(200===e.status)return e;throw new Error(e.statusText)})).then((e=>e.arrayBuffer())).then((e=>n.open(e))).catch((function(e){alert("There was an unexpected problem opening this ebook file. Try again later."),window.location.replace("/texts")}));let r=n.renderTo("viewer",{flow:"scrolled-doc"}),a=document.getElementById("readerpage");r.themes.register("darkmode","/css/ebooks-min.css"),r.themes.register("lightmode","/css/ebooks-min.css"),r.themes.register("sepiamode","/css/ebooks-min.css"),r.themes.default({body:{"font-family":a.style.fontFamily+" !important","font-size":a.style.fontSize+" !important","text-align":a.style.textAlign+" !important","line-height":a.style.lineHeight+" !important",padding:"0 5% !important"}}),r.themes.select(a.className),n.opened.then((function(){const e=n.key()+"-lastpos",t=localStorage.getItem(e);c(t||1)})),n.loaded.spine.then((e=>{e.each((e=>{e.load(n.load.bind(n))}))}));let i=document.getElementById("next");i.addEventListener("click",(function(e){e.preventDefault(),$.when(s()).then((function(){let e=i.href.substr(i.href.indexOf("/",8)+1);e=e.replace(/OEBPS\//i,""),c(e),$("html, body").animate({scrollTop:0},"fast")}))}),!1);let l=document.getElementById("prev");function s(){let e=[],t="";$(document).find(".learning").each((function(){t=$(this).text().toLowerCase(),-1==jQuery.inArray(t,e)&&e.push(t)})),$.ajax({type:"POST",url:"/ajax/archivetext.php",async:!1,data:{words:e}}).done((function(e){if(null==e.error_msg){const e={words:{new:$(".reviewing.new").length,learning:$(".reviewing.learning").length,forgotten:$(".reviewing.forgotten").length},texts:{reviewed:1}};$.ajax({type:"post",url:"/ajax/updateuserscore.php",data:e}).done((function(e){null!=e.error_msg&&alert("Oops! There was an unexpected error updating user score.")})).fail((function(e,t,n){alert("Oops! There was an unexpected error updating user score.")}))}else alert("Oops! There was an error unexpected error archiving text.")})).fail((function(e,t,n){alert("Oops! There was an error unexpected error archiving text.")})),window.parent.show_confirmation_dialog=!1}function c(t){let r=n.spine.get(t);return r&&r.render().then((function(a){let s=$("<div/>").append(a);s.find("*").removeAttr("class").removeAttr("style"),$(".loading-spinner").fadeIn(1e3),$.ajax({type:"POST",url:"/ajax/getuserwords.php",data:{txt:s.html()},dataType:"json"}).done((function(t){o.innerHTML=underlineWords(t,e),$(".loading-spinner").fadeOut(1e3)})).fail((function(e,t,n){alert("There was an unexpected error when trying to underline words for this ebook!")}));let c=r.next(),d=r.prev();if(c){const e=n.navigation.get(c.href);let t="";t=e?e.label:"next",i.textContent=t+" »",i.href=c.href,i.title="Go to next chapter & update word status"}else i.textContent="";if(d){const e=n.navigation.get(d.href);let t="";t=e?e.label:"previous",l.textContent="« "+t,l.href=d.href,l.title="Go to previous chapter"}else l.textContent="";localStorage.setItem(n.key()+"-lastpos",t),function(e){let t=document.getElementById("toc"),n=t.querySelector(".fw-bold");null!==n&&n.classList.remove("fw-bold");n=t.querySelector('a[href*="'+e+'"]'),null!==n&&n.classList.add("fw-bold")}(t)})),r}l.addEventListener("click",(function(e){e.preventDefault();let t=l.href.substr(l.href.indexOf("/",8)+1);t=t.replace(/OEBPS\//i,""),c(t),$("html, body").animate({scrollTop:0},"fast")}),!1),$("body").on("click","#btn-close-ebook",(function(){$.when(s()).then((function(){window.location.replace("/texts")}))})),parent.window.addEventListener("unload",(function(){n.destroy()})),n.loaded.navigation.then((function(e){let t=document.getElementById("toc"),n=document.createDocumentFragment();const o=function(e,t){let n=document.createElement("ul");t.forEach((function(e){let t=document.createElement("li"),r=document.createElement("a");r.textContent=e.label,r.href=e.href,t.appendChild(r),e.subitems&&o(t,e.subitems),r.onclick=function(){const e=r.getAttribute("href");return document.getElementById("opener").click(),c(e),$("html, body").animate({scrollTop:0},"fast"),!1},n.appendChild(t)})),e.appendChild(n)};o(n,e),t.appendChild(n),t.offsetHeight+60<window.innerHeight&&t.classList.add("fixed")})),n.loaded.metadata.then((function(e){let t=document.getElementById("title"),o=document.getElementById("book-title"),r=document.getElementById("author"),a=document.getElementById("cover");null!=t&&(t.textContent=e.title,o.textContent=e.title,r.textContent=e.creator,n.archive?n.archive.createUrl(n.cover).then((function(e){a.src=e})):a.src=n.cover)}))}));