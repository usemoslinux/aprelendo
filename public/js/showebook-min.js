$(document).ready((function(){var e=$("html").attr("lang"),t=$("script[src*='showebook-min.js']").attr("data-id"),n=ePub();window.parent.show_confirmation_dialog=!1;var o=document.getElementById("viewer");(new FormData).append("id",t),fetch("ajax/getebook.php?id="+t).then((function(e){if(200===e.status)return e;throw new Error(e.statusText)})).then((e=>e.arrayBuffer())).then((e=>n.open(e))).catch((function(e){alert("There was an unexpected problem opening this ebook file. Try again later."),window.location.replace("texts.php")}));var a=n.renderTo("viewer",{flow:"scrolled-doc"}),r=document.getElementById("readerpage");a.themes.register("darkmode","/css/ebooks-min.css"),a.themes.register("lightmode","/css/ebooks-min.css"),a.themes.register("sepiamode","/css/ebooks-min.css"),a.themes.default({body:{"font-family":r.style.fontFamily+" !important","font-size":r.style.fontSize+" !important","text-align":r.style.textAlign+" !important","line-height":r.style.lineHeight+" !important",padding:"0 5% !important"}}),a.themes.select(r.className),n.opened.then((function(){var e=n.key()+"-lastpos",t=localStorage.getItem(e);m(t||1)})),n.loaded.spine.then((e=>{e.each((e=>{e.load(n.load.bind(n))}))}));var i=document.getElementById("next");i.addEventListener("click",(function(e){e.preventDefault(),$.when(d()).then((function(){m(i.href.substr(i.href.indexOf("/",8)+1)),$("html, body").animate({scrollTop:0},"fast")}))}),!1);var l=document.getElementById("prev");function d(){$(document).find('iframe[id^="epubjs"]');var e=[],t="";$(document).find(".learning").each((function(){t=$(this).text().toLowerCase(),-1==jQuery.inArray(t,e)&&e.push(t)})),$.ajax({type:"POST",url:"/ajax/archivetext.php",async:!1,data:{words:e}}).fail((function(e,t,n){alert("Oops! There was an error updating the database.")})),window.parent.show_confirmation_dialog=!1}l.addEventListener("click",(function(e){e.preventDefault(),$.when(d()).then((function(){m(l.href.substr(l.href.indexOf("/",8)+1)),$("html, body").animate({scrollTop:0},"fast")}))}),!1),$("body").on("click","#btn-close-ebook",(function(){window.location.replace("/texts.php")})),parent.window.addEventListener("unload",(function(){n.destroy()}));var s=document.getElementById("navigation"),c=document.getElementById("main"),u=document.getElementById("opener");function m(t){var a=n.spine.get(t);return a&&a.render().then((function(r){var d=$("<div/>").append(r);d.find("*").removeAttr("class").removeAttr("style"),$(".loading-spinner").fadeIn(1e3),$.ajax({type:"POST",url:"/ajax/getuserwords.php",data:{txt:d.html()},dataType:"json"}).done((function(t){o.innerHTML=underlineWords(t,e),$(".loading-spinner").fadeOut(1e3)})).fail((function(e,t,n){alert("There was an unexpected error when trying to underline words for this ebook!")}));var s=a.next(),c=a.prev();s?(nextNav=n.navigation.get(s.href),nextNav?nextLabel=nextNav.label:nextLabel="next",i.textContent=nextLabel+" »",i.href=s.href):i.textContent="",c?(prevNav=n.navigation.get(c.href),prevNav?prevLabel=prevNav.label:prevLabel="previous",l.textContent="« "+prevLabel,l.href=c.href):l.textContent="",localStorage.setItem(n.key()+"-lastpos",t),function(e){var t=document.getElementById("toc");null!==t.querySelector(".font-weight-bold")&&t.querySelector(".font-weight-bold").classList.remove("font-weight-bold");t.querySelector('a[href*="'+e+'"]').classList.add("font-weight-bold")}(t)})),a}u.addEventListener("click",(function(e){s.classList.toggle("sidebar-closed"),c.classList.toggle("sidebar-opened"),e.preventDefault()}),!1),n.loaded.navigation.then((function(e){var t=document.getElementById("toc"),o=document.createDocumentFragment(),a=n.key()+"-lastpos",r=(localStorage.getItem(a),function(e,t){var n=document.createElement("ul");t.forEach((function(e){var t=document.createElement("li"),o=document.createElement("a");o.textContent=e.label,o.href=e.href,t.appendChild(o),e.subitems&&r(t,e.subitems),o.onclick=function(){return m(o.getAttribute("href")),u.click(),$("html, body").animate({scrollTop:0},"fast"),!1},n.appendChild(t)})),e.appendChild(n)});r(o,e),t.appendChild(o),t.offsetHeight+60<window.innerHeight&&t.classList.add("fixed")})),n.loaded.metadata.then((function(e){var t=document.getElementById("title"),o=document.getElementById("book-title"),a=document.getElementById("author"),r=document.getElementById("cover");null!=t&&(t.textContent=e.title,o.textContent=e.title,a.textContent=e.creator,n.archive?n.archive.createUrl(n.cover).then((function(e){r.src=e})):r.src=n.cover)}))}));