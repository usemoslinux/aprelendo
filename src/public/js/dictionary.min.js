function getTextSentence(n){let t=n.prevUntil(":contains('.'), :contains('!'), :contains('?'), :contains('\n')").last();t=t.length>0?t:n;let e=0==n.prev().length?n.nextUntil(":contains('.'), :contains('。'), :contains('!'), :contains('?'), :contains('\n')").last().next():n.prev().nextUntil(":contains('.'), :contains('。'), :contains('!'), :contains('?'), :contains('\n')").last().next();e=e.length>0?e:n.nextAll().last().next();let i=e.text().length,o=t.nextUntil(e).addBack().next().addBack().text().replace(/(\r\n|\n|\r)/gm," ");return i>1&&o.slice(0,1-i),o.trim()}function buildTextTranslationLink(n,t){let e=getTextSentence(t);return n.replace("%s",encodeURI(e))}function getVideoSentence(n){let t,e=n,i=$(),o="",r=!1;const l=":contains('.'), :contains('。'), :contains('!'), :contains('?')";for(;!r;){if(0===e.index()){o=e.text().replace(/(\r\n|\n|\r)/gm," ").trim();break}if(e.filter(l).length>0)break;t=e.prevAll(l).next().last(),r=t.length>0||e.filter(l).length>0,t=r?t:e.siblings().addBack().first(),i=t.nextUntil(e).addBack().next().addBack(),o=i.text().replace(/(\r\n|\n|\r)/gm," ").trim()+"\n"+o,e=e.parent().prev().children().last(),r=r||0===e.length}t=0===n.next().length?n:n.next();let c;for(r=o.match(/[.。!?]/g);!r;)e=t.nextAll(l).first(),e=e.index()===e.parent().children().length?t:e,r=e.length>0||t.filter(l).length>0,e=r?e:t.siblings().last(),t.filter(l).length>0?(i=t,c=""):(i=t.nextUntil(e).addBack().next().addBack(),c="\n"),o=o.trim()+c+i.text().replace(/(\r\n|\n|\r)/gm," ").trim(),t=t.parent().next().children().first(),r=r||0===t.length;return o.trim()}function buildVideoTranslationLink(n,t){let e=getVideoSentence(t);return n.replace("%s",encodeURIComponent(e))}function buildStudyTranslationLink(n,t){const e=t.parent("p").text().trim();return n.replace("%s",encodeURIComponent(e))}function buildDictionaryLink(n,t){const e=t.trim().replace(/\r?\n|\r/gm," ");return n.replace("%s",encodeURIComponent(e))}function setWordActionButtons(n){let t=$("#word-actions-g1")||$(parent.document).find("#word-actions-g1"),e=$("#word-actions-g2")||$(parent.document).find("#word-actions-g2");const i=n.filter(".learning, .new, .forgotten, .learned").length;n.filter(".word").length==i?(t.hide(),e.show()):(t.show(),e.hide())}function getWordFrequency(n,t){let e=$("#bdgfreqlvl")||$(parent.document).find("#bdgfreqlvl");return new Promise(((i,o)=>{$.ajax({type:"GET",url:"/ajax/getwordfreq.php",data:{word:n,lg_iso:t}}).done((function(n){0==n?e.removeClass().hide():n<81?e.removeClass().addClass("badge text-bg-danger").text("High frequency word").show():n<97&&e.removeClass().addClass("badge text-bg-warning").text("Medium frequency word").show(),i(n)})).fail((function(){e.removeClass().hide(),o(new Error("AJAX request failed"))}))}))}function showActionButtons(n){const t=$("#action-buttons"),e=t.outerWidth(),i=$(window).width(),o=n.offset(),r=n.outerWidth();o.left+e>i?t.css({top:o.top-t.outerHeight()-2,left:o.left-e+r}):t.css({top:o.top-t.outerHeight()-2,left:o.left}),t.show()}function hideActionButtons(n){$("#action-buttons").hide()}function setDicActionButtonsClick(n,t){const e=buildDictionaryLink(t.dictionary,n.text()),i=buildDictionaryLink(t.img_dictionary,n.text()),o=buildTextTranslationLink(t.translator,n);$("#btn-open-dict").off("click").on("click",(function(){window.open(e,"_blank","noopener,noreferrer")})),$("#btn-open-img-dict").off("click").on("click",(function(){window.open(i,"_blank","noopener,noreferrer")})),$("#btn-open-translator").off("click").on("click",(function(){window.open(o,"_blank","noopener,noreferrer")}))}