$(document).ready((function(){let e=$(),t=[],a=10,r=0,n=[["0",0,"bg-success","Excellent"],["1",0,"bg-warning","Partial"],["2",0,"bg-primary","Fuzzy"],["3",0,"bg-danger","No recall"],["4",0,"text-warning bg-dark","No example sentence found!"]];function s(e){i()||($("#examples-placeholder").removeClass("d-none"),$("#study-card-examples").empty(),$.ajax({type:"POST",url:"ajax/getcards.php",data:{word:e},dataType:"json"}).done((function(l){let c=[],u="";const g=$("#card").data("lang");let p=new RegExp("([^\\n.?!]|[\\d][.][\\d]|[A-Z][.](?:[A-Z][.])+)*"+("(?<![\\p{L}])"+e+"(?![\\p{L}])")+"([^\\n.?!]|[.][\\d]|[.](?:[A-Z][.])+)*[\\n.?!]","gmiu");if("ja"!=g&&"zh"!=g||(p=new RegExp("[^\n?!。]*"+e+"[^\n?!。]*[\n?!。]","gmiu")),l.forEach((t=>{let a;for(;null!==(a=p.exec(t.text));)if(a.index===p.lastIndex&&p.lastIndex++,c.length<3){let r=a[0];r!==e&&(t.text=d(r)?t.text:r,c=o(c,t))}})),$("#study-card").data("word",e),function(){const e=Math.round((r+1)/a*100);$("#live-progress-bar").css("width",e+"%").attr("aria-valuenow",e)}(),$("#card-counter").text(r+1+"/"+a),$("#study-card-word-title").removeClass("placeholder").text(e),0===c.length){if(t[r].status=4,n[4][1]=n[4][1]+1,r++,i())return;s(t[r].word)}else c=function(e){let t,a=e.length;for(;a>0;)t=Math.floor(Math.random()*a),a--,[e[a],e[t]]=[e[t],e[a]];return e}(c),c.forEach((t=>{u+=function(e,t){const a=new RegExp("(?<![\\p{L}|\\d])"+t+"(?![\\p{L}|\\d])","gmiu");let r="",n="",s=[];n=e.text.replace(a,(function(e,t){return void 0===t?e:"<a class='word fw-bold bg-warning-subtle border-bottom p-1'>"+e.replace(/\s\s+/g," ")+"</a>"})),r="<blockquote cite='"+e.source_uri+"'>",r+="<p  class='mb-0'>"+n+"</p>",r+=`<cite style='font-size:.85rem' class='text-secondary fw-medium'>${""==e.author?"Anonymous":e.author}`,""==e.source_uri||e.source_uri.endsWith(".epub")?r+=", "+e.title:r+=", <a href='"+e.source_uri+"' target='_blank'>"+e.title+"</a>";return r+="</cite></blockquote>",s.push(r),s}(t,e)})),function(e){const a=$("#study-card-freq-badge");if(e)a.removeClass("placeholder").addClass("border border-light").text("Phrase/Expression");else{const e=Dictionaries.getWordFrequency(t[r].frequency_index)+" frequency";a.removeClass("placeholder").addClass("border border-light").text(e)}}(t[r].is_phrase),$("#examples-placeholder").addClass("d-none"),$("#study-card-examples").html(u);$(".btn-answer").prop("disabled",!1)})).fail((function(e,t,a){showMessage("Oops! There was an unexpected error trying to fetch example sentences for this word.","alert-danger")})))}function o(e,t){if(0===e.length)return e.push(t),e;for(let a=0;a<e.length;a++){const r=e[a];if(t.text.includes(r.text))return e[a]=t,e;if(r.text.includes(t.text))return e}return e.push(t),e}function d(e){const t=(e.match(/"/g)||[]).length,a=(e.match(/“/g)||[]).length,r=(e.match(/”/g)||[]).length;return t%2!=0||a!==r}function i(){if(0==a)return l(),!0;if(r>=a){$("#study-card-word-title").text("Congratulations!"),$("#study-card-freq-badge").hide(),c();let e="";for(const t of n){let r=t[1],n=r/a*100;e+="<div class='progress-bar "+t[2]+"' role='progressbar' aria-valuenow='"+n+"' aria-valuemin='0' aria-valuemax='100' style='width: "+n+"%' title='"+t[3]+": "+r+" answer(s)'>"+Math.round(n)+" %</div>"}return $("#study-card-examples").html("<div class='bi bi-trophy text-warning display-3 mt-3'></div><div class='mt-3'>You have reached the end of your study.</div><div class='mt-3'>These were your results:</div><div class='progress mx-auto mt-3 fw-bold' style='height: 25px;max-width: 550px'>"+e+"</div>"+function(){const e='<table class="table table-bordered table-striped text-end small mx-auto mt-3"\n            aria-describedby="" style="max-width: 550px">\n        <thead>\n            <tr class="table-light">\n                <th>Word</th>\n                <th>Recall level</th>\n            </tr>\n        </thead>\n        <tbody>';let a="";const r="</tbody></table>";return t.forEach((e=>{a+='<tr><td><a class="word bw-bold">'+e.word+'</a></td><td><span class="word-description '+n[e.status][2]+'">'+n[e.status][3]+"</span></td></tr>"})),e+a+r}()+"<div class='small mt-4'>If you want to continue, you can refresh this page (F5).<br>However, we strongly recommend that you keep your study sessions short and take rest intervals.</div>"),$("#study-card-footer").addClass("d-none"),$("#examples-placeholder").addClass("d-none"),$("#live-progress").addClass("d-none"),scrollToPageTop(),!0}return!1}function l(){$("#study-card-header").text("Sorry, no cards to practice"),c(3),$("#study-card-examples").html("<div class='bi bi-exclamation-circle text-danger display-3'></div><div class='mt-3'>It seems there are no cards in your deck. Add some words to your library and try again.</div>"),$("#study-card-footer").addClass("d-none"),$("#examples-placeholder").addClass("d-none"),$("#live-progress").addClass("d-none")}function c(e){const t=$("#study-card"),a=$("#study-card-header");switch(t.removeClass((function(e,t){return(t.match(/\bborder-\S+/g)||[]).join(" ")})),a.removeClass((function(e,t){return(t.match(/\bborder-\S+|\bbg-\S+/g)||[]).join(" ")})),e){case 0:t.addClass("border-success"),a.addClass("bg-gradient bg-success border-success");break;case 1:t.addClass("border-warning"),a.addClass("bg-gradient bg-warning border-warning");break;case 2:t.addClass("border-primary"),a.addClass("bg-gradient bg-primary border-primary");break;case 3:t.addClass("border-danger"),a.addClass("bg-gradient bg-danger border-danger");break;default:t.addClass("border-secondary"),a.addClass("bg-gradient bg-secondary border-secondary");break}}$(".btn-answer").prop("disabled",!0),Dictionaries.fetchURIs(),$.ajax({type:"POST",url:"ajax/getcards.php",data:{limit:a},dataType:"json"}).done((function(e){if(e.error_msg)showMessage("Oops! There was an unexpected error trying to fetch the list of words you are learning in this language.","alert-danger");else{if(0==e.length)return l(),!0;t=e.map((e=>({...e,word:e.word.replace(/\r?\n|\r/g," ")}))),a=t.length>a?a:t.length,$("#card-counter").text("1/"+a),c(t[0].status),s(t[0].word)}})).fail((function(e,t,a){showMessage("Oops! There was an unexpected error trying to fetch the list of words you are learning in this language.","alert-danger")})),$("body").on("click",".word",(function(t){e=$(this),StudyActionBtns.show(e)})),$(".btn-answer").click((function(e){e.preventDefault();const a=$("#study-card").data("word"),o=$(this).attr("value");n[o][1]=n[o][1]+1,t[r].status=o,$(".btn-answer").prop("disabled",!0),$.ajax({type:"POST",url:"ajax/updatecard.php",data:{word:a,answer:o}}).done((function(e){r++,i()||(s(t[r].word),c(t[r].status),scrollToPageTop())})).fail((function(e,t,a){showMessage("There was an unexpected error updating this word's status","alert-danger")})),$("#btn-answer-prev").trigger("click")})),$("#btn-answer-prev").on("click",(function(e){e.preventDefault(),$("#answer-card-page-1").removeClass("d-none"),$("#answer-card-page-2").addClass("d-none")})),$("#btn-answer-more").on("click",(function(e){e.preventDefault(),$("#answer-card-page-1").addClass("d-none"),$("#answer-card-page-2").removeClass("d-none")})),$("#btn-translate").on("click",(function(){const t=Dictionaries.getURIs();openInNewTab(LinkBuilder.forTranslationInStudy(t.translator,e))})),$("#btn-img-dic").on("click",(function(){const t=Dictionaries.getURIs();openInNewTab(LinkBuilder.forWordInDictionary(t.img_dictionary,e.text()))})),$(document).on("contextmenu",(function(e){if(!/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)&&$(e.target).is(".word")){const t=Dictionaries.getURIs();openInNewTab(LinkBuilder.forTranslationInStudy(t.translator,$(e.target)))}return!1})),$(document).keypress((function(e){if(!$(".btn-answer").prop("disabled"))switch(e.which){case 49:$("#btn-answer-no-recall").click();break;case 50:$("#btn-answer-fuzzy").click();break;case 51:$("#btn-answer-partial").click();break;case 52:$("#btn-answer-excellent").click();break;default:break}})),$(document).on("mouseup touchend",(function(e){!1===$(e.target).is(".word")&&!$(e.target).closest("#action-buttons").length>0&&(e.stopPropagation(),ActionBtns.hide())}))}));