$(document).ready((function(){let e="",t="",n="";const a=$("#dicFrame");let r=$(),o=[],s=10,d=0,i=[["0",0,"bg-success","Excellent"],["1",0,"bg-info","Partial"],["2",0,"bg-warning","Fuzzy"],["3",0,"bg-danger","No recall"],["4",0,"text-warning bg-dark","No example sentence found!"]];function l(e){h()||($("#card-loader").removeClass("d-none"),$("#card-text").empty(),$("#card-header").html("Looking for examples of "+e+"..."),$.ajax({type:"POST",url:"ajax/getcards.php",data:{word:e},dataType:"json"}).done((function(t){let n=[],a="";const r=$("#card").data("lang");let i=new RegExp("([^\\n.?!]|[\\d][.][\\d]|[A-Z][.](?:[A-Z][.])+)*(?<![\\p{L}])"+e+"(?![\\p{L}])([^\\n.?!]|[.][\\d]|[.](?:[A-Z][.])+)*[\\n.?!]","gmiu");if("ja"!=r&&"zh"!=r||(i=new RegExp("[^\n?!。]*"+e+"[^\n?!。]*[\n?!。]","gmiu")),t.forEach((t=>{let a;for(;null!==(a=i.exec(t.text));)if(a.index===i.lastIndex&&i.lastIndex++,n.length<3){let r=a[0];r!==e&&(t.text=u(r)?t.text:r,n=c(n,t))}})),0===n.length){if($("#card-header").html("Skipped. No examples found."),o[d][1]=4,d++,h())return;l(o[d][0])}else n=function(e){let t,n=e.length;for(;n>0;)t=Math.floor(Math.random()*n),n--,[e[n],e[t]]=[e[t],e[n]];return e}(n),n.forEach((t=>{a+=function(e,t){const n=new RegExp("(?<![\\p{L}|\\d])"+t+"(?![\\p{L}|\\d])","gmiu");let a="",r="",o=[];r=e.text.replace(n,(function(e,t){return void 0===t?e:"<a class='word fw-bold'>"+e.replace(/\s\s+/g," ")+"</a>"})),a="<blockquote cite='"+e.source_uri+"'>",a+="<p>"+r+"</p>",a+="<cite>"+(""==e.author?"Anonymous":e.author),""==e.source_uri||e.source_uri.endsWith(".epub")?a+=", "+e.title:a+=", <a href='"+e.source_uri+"' target='_blank'>"+e.title+"</a>";return a+="</cite></blockquote>",o.push(a),o}(t,e)}));$("#card").data("word",e),$("#card-loader").addClass("d-none"),$("#card-counter").text(d+1+"/"+s),$("#card-header").html(e),$("#card-text").append(a),$(".btn-answer").prop("disabled",!1)})).fail((function(e,t,n){showMessage("Oops! There was an unexpected error trying to fetch example sentences for this word.","alert-danger")})))}function c(e,t){if(0===e.length)return e.push(t),e;for(let n=0;n<e.length;n++){const a=e[n];if(t.text.includes(a.text))return e[n]=t,e;if(a.text.includes(t.text))return e}return e.push(t),e}function u(e){const t=(e.match(/"/g)||[]).length,n=(e.match(/“/g)||[]).length,a=(e.match(/”/g)||[]).length;return t%2!=0||n!==a}function h(){if(0==s)return p(),!0;if(d>=s){$("#card-header").text("Congratulations!");let e="";for(const t of i){let n=t[1],a=n/s*100;e+="<div class='progress-bar "+t[2]+"' role='progressbar' aria-valuenow='"+a+"' aria-valuemin='0' aria-valuemax='100' style='width: "+a+"%' title='"+t[3]+": "+n+" answer(s)'>"+a+" %</div>"}return $("#card-text").html("<div class='bi bi-trophy text-primary display-3 mt-3'></div><div class='mt-3'>You have reached the end of your study.</div><div class='mt-3'>These were your results:</div><div class='progress mx-auto mt-3 fw-bold' style='height: 25px;max-width: 550px'>"+e+"</div>"+function(){const e='<table class="table text-end small mx-auto mt-3" aria-describedby="" style="max-width: 550px">\n        <thead>\n            <tr class="table-secondary">\n                <th>Word</th>\n                <th>Recall level</th>\n            </tr>\n        </thead>\n        <tbody>';let t="";const n="</tbody></table>";return o.forEach((e=>{t+='<tr><td><strong class="word-description '+i[e[1]][2]+'">'+e[0]+"</td><td>"+i[e[1]][3]+"</strong></td></tr>"})),e+t+n}()+"<div class='small mt-4'>If you want to continue, you can refresh this page (F5).<br>However, we strongly recommend that you keep your study sessions short and take rest intervals.</div>"),$("#card-footer").addClass("d-none"),$("#card-loader").addClass("d-none"),!0}return!1}function p(){$("#card-header").text("Sorry, no cards to practice"),$("#card-text").html("<div class='bi bi-exclamation-circle text-danger display-3'></div><div class='mt-3'>It seems you don't have any cards left for learning.</div>"),$("#card-footer").addClass("d-none"),$("#card-loader").addClass("d-none")}$("#btn-translate").removeClass("ps-0"),$("#btn-remove").hide(),$("#btn-add").hide(),$("#btn-cancel").removeClass().addClass("btn-close me-1").html(""),$(".modal-header").addClass("p-0"),$(".btn-answer").prop("disabled",!0),$.ajax({url:"/ajax/getdicuris.php",type:"GET",dataType:"json"}).done((function(a){null==a.error_msg&&(e=a.dictionary_uri,t=a.img_dictionary_uri,n=a.translator_uri)})),$.ajax({type:"POST",url:"ajax/getcards.php",data:{limit:s},dataType:"json"}).done((function(e){if(e.error_msg)showMessage("Oops! There was an unexpected error trying to fetch the list of words you are learning in this language.","alert-danger");else{if(0==e.length)return p(),!0;o=e.map((function(e,t){return[e.word.replace(/\r?\n|\r/g," ")]})),s=o.length>s?s:o.length,$("#card-counter").text("1/"+s),l(o[0][0])}})).fail((function(e,t,n){showMessage("Oops! There was an unexpected error trying to fetch the list of words you are learning in this language.","alert-danger")})),$("body").on("click",".word",(function(t){r=$(this);const n=e.replace("%s",encodeURI(r.text()));$("#btn-add").text("Forgot").removeClass("btn-primary").addClass("btn-danger"),$("#loading-spinner").attr("class","lds-ellipsis m-auto"),a.attr("class","d-none"),a.get(0).contentWindow.location.replace(n),$("#dic-modal").modal("show")})),a.on("load",(function(){$("#loading-spinner").attr("class","d-none"),a.removeClass()})),$(".btn-answer").click((function(e){e.preventDefault();const t=$("#card").data("word"),n=$(this).attr("value");i[n][1]=i[n][1]+1,o[d][1]=n,$(".btn-answer").prop("disabled",!0),$.ajax({type:"POST",url:"ajax/updatecard.php",data:{word:t,answer:n}}).done((function(e){d++,h()||l(o[d][0])})).fail((function(e,t,n){showMessage("There was an unexpected error updating this word's status","alert-danger")}))})),$("#btn-translate").on("click",(function(){window.open(buildStudyTranslationLink(n,r),"_blank","noopener,noreferrer")})),$("#btn-img-dic").on("click",(function(){window.open(buildDictionaryLink(t,r.text()),"_blank","noopener,noreferrer")})),$(document).on("contextmenu",(function(e){return!/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)&&$(e.target).is(".word")&&window.open(buildStudyTranslationLink(n,$(e.target)),"_blank","noopener,noreferrer"),!1})),$(document).keypress((function(e){if(!$(".btn-answer").prop("disabled"))switch(e.which){case 49:$("#btn-answer-no-recall").click();break;case 50:$("#btn-answer-fuzzy").click();break;case 51:$("#btn-answer-partial").click();break;case 52:$("#btn-answer-excellent").click();break;default:break}}))}));