$(document).ready((function(){let e="",a="",t="";const r=$("#dicFrame");let n=$(),s=[],d=10,o=0,l=[["0",0,"bg-success","Excellent"],["1",0,"bg-warning","Partial"],["2",0,"bg-primary","Fuzzy"],["3",0,"bg-danger","No recall"],["4",0,"text-warning bg-dark","No example sentence found!"]];function i(e){p()||($("#examples-placeholder").removeClass("d-none"),$("#study-card-examples").empty(),$.ajax({type:"POST",url:"ajax/getcards.php",data:{word:e},dataType:"json"}).done((function(a){let t=[],r="";const n=$("#card").data("lang");let l=new RegExp("([^\\n.?!]|[\\d][.][\\d]|[A-Z][.](?:[A-Z][.])+)*(?<![\\p{L}])"+e+"(?![\\p{L}])([^\\n.?!]|[.][\\d]|[.](?:[A-Z][.])+)*[\\n.?!]","gmiu");if("ja"!=n&&"zh"!=n||(l=new RegExp("[^\n?!。]*"+e+"[^\n?!。]*[\n?!。]","gmiu")),a.forEach((a=>{let r;for(;null!==(r=l.exec(a.text));)if(r.index===l.lastIndex&&l.lastIndex++,t.length<3){let n=r[0];n!==e&&(a.text=u(n)?a.text:n,t=c(t,a))}})),0===t.length){if($("#study-card-header").html("Skipped. No examples found."),s[o].status=4,o++,p())return;i(s[o].word)}else t=function(e){let a,t=e.length;for(;t>0;)a=Math.floor(Math.random()*t),t--,[e[t],e[a]]=[e[a],e[t]];return e}(t),t.forEach((a=>{r+=function(e,a){const t=new RegExp("(?<![\\p{L}|\\d])"+a+"(?![\\p{L}|\\d])","gmiu");let r="",n="",s=[];n=e.text.replace(t,(function(e,a){return void 0===a?e:"<a class='word fw-bold'>"+e.replace(/\s\s+/g," ")+"</a>"})),r="<blockquote cite='"+e.source_uri+"'>",r+="<p>"+n+"</p>",r+="<cite>"+(""==e.author?"Anonymous":e.author),""==e.source_uri||e.source_uri.endsWith(".epub")?r+=", "+e.title:r+=", <a href='"+e.source_uri+"' target='_blank'>"+e.title+"</a>";return r+="</cite></blockquote>",s.push(r),s}(a,e)}));$("#study-card").data("word",e),$("#card-counter").text(o+1+"/"+d),$("#study-card-word-title").addClass("word").removeClass("placeholder").text(e),$("#examples-placeholder").addClass("d-none"),$("#study-card-examples").append(r),$(".btn-answer").prop("disabled",!1);const g=$("#study-card").data("lang");b(e,g)})).fail((function(e,a,t){showMessage("Oops! There was an unexpected error trying to fetch example sentences for this word.","alert-danger")})))}function c(e,a){if(0===e.length)return e.push(a),e;for(let t=0;t<e.length;t++){const r=e[t];if(a.text.includes(r.text))return e[t]=a,e;if(r.text.includes(a.text))return e}return e.push(a),e}function u(e){const a=(e.match(/"/g)||[]).length,t=(e.match(/“/g)||[]).length,r=(e.match(/”/g)||[]).length;return a%2!=0||t!==r}function p(){if(0==d)return g(),!0;if(o>=d){$("#study-card-word-title").removeClass("word").text("Congratulations!"),h(),b();let e="";for(const a of l){let t=a[1],r=t/d*100;e+="<div class='progress-bar "+a[2]+"' role='progressbar' aria-valuenow='"+r+"' aria-valuemin='0' aria-valuemax='100' style='width: "+r+"%' title='"+a[3]+": "+t+" answer(s)'>"+Math.round(r)+" %</div>"}return $("#study-card-examples").html("<div class='bi bi-trophy text-warning display-3 mt-3'></div><div class='mt-3'>You have reached the end of your study.</div><div class='mt-3'>These were your results:</div><div class='progress mx-auto mt-3 fw-bold' style='height: 25px;max-width: 550px'>"+e+"</div>"+function(){const e='<table class="table table-bordered table-striped text-end small mx-auto mt-3"\n            aria-describedby="" style="max-width: 550px">\n        <thead>\n            <tr class="table-light">\n                <th>Word</th>\n                <th>Recall level</th>\n            </tr>\n        </thead>\n        <tbody>';let a="";const t="</tbody></table>";return s.forEach((e=>{a+='<tr><td><a class="word bw-bold">'+e.word+'</a></td><td><span class="word-description '+l[e.status][2]+'">'+l[e.status][3]+"</span></td></tr>"})),e+a+t}()+"<div class='small mt-4'>If you want to continue, you can refresh this page (F5).<br>However, we strongly recommend that you keep your study sessions short and take rest intervals.</div>"),$("#study-card-footer").addClass("d-none"),$("#examples-placeholder").addClass("d-none"),scrollToPageTop(),!0}return!1}function g(){$("#study-card-header").text("Sorry, no cards to practice"),h(3),$("#study-card-examples").html("<div class='bi bi-exclamation-circle text-danger display-3'></div><div class='mt-3'>It seems there are no cards in your deck. Add some words to your library and try again.</div>"),$("#study-card-footer").addClass("d-none"),$("#examples-placeholder").addClass("d-none")}function h(e){const a=$("#study-card"),t=$("#study-card-header");switch(a.removeClass((function(e,a){return(a.match(/\bborder-\S+/g)||[]).join(" ")})),t.removeClass((function(e,a){return(a.match(/\bborder-\S+|\btext-bg-\S+/g)||[]).join(" ")})),e){case 0:a.addClass("border-success"),t.addClass("text-bg-success border-success");break;case 1:a.addClass("border-warning"),t.addClass("text-bg-warning border-warning");break;case 2:a.addClass("border-primary"),t.addClass("text-bg-primary border-primary");break;case 3:a.addClass("border-danger"),t.addClass("text-bg-danger border-danger");break;default:a.addClass("border-secondary"),t.addClass("text-bg-secondary border-secondary");break}}async function b(e,a){await getWordFrequency(e,a),$("#bdgfreqlvl").hasClass("text-bg-danger")?$("#study-card").removeClass("card-medium-freq").addClass("card-high-freq"):$("#bdgfreqlvl").hasClass("text-bg-warning")?$("#study-card").removeClass("card-high-freq").addClass("card-medium-freq"):$("#study-card").removeClass("card-medium-freq card-high-freq")}$("#btn-translate").removeClass("ps-0"),$("#btn-remove").hide(),$("#btn-add").hide(),$("#btn-cancel").removeClass().addClass("btn-close me-1").html(""),$(".modal-header").addClass("p-0"),$(".btn-answer").prop("disabled",!0),$.ajax({url:"/ajax/getdicuris.php",type:"GET",dataType:"json"}).done((function(r){null==r.error_msg&&(e=r.dictionary_uri,a=r.img_dictionary_uri,t=r.translator_uri)})),$.ajax({type:"POST",url:"ajax/getcards.php",data:{limit:d},dataType:"json"}).done((function(e){if(e.error_msg)showMessage("Oops! There was an unexpected error trying to fetch the list of words you are learning in this language.","alert-danger");else{if(0==e.length)return g(),!0;s=e.map((e=>({...e,word:e.word.replace(/\r?\n|\r/g," ")}))),d=s.length>d?d:s.length,$("#card-counter").text("1/"+d),h(s[0].status),i(s[0].word)}})).fail((function(e,a,t){showMessage("Oops! There was an unexpected error trying to fetch the list of words you are learning in this language.","alert-danger")})),$("body").on("click",".word",(function(a){n=$(this);const t=e.replace("%s",encodeURI(n.text()));$("#btn-add").text("Forgot").removeClass("btn-primary").addClass("btn-danger"),$("#loading-spinner").attr("class","lds-ellipsis m-auto"),r.attr("class","d-none"),r.get(0).contentWindow.location.replace(t),$("#dic-modal").modal("show")})),r.on("load",(function(){$("#loading-spinner").attr("class","d-none"),r.removeClass()})),$(".btn-answer").click((function(e){e.preventDefault();const a=$("#study-card").data("word"),t=$(this).attr("value");l[t][1]=l[t][1]+1,s[o].status=t,$(".btn-answer").prop("disabled",!0),$.ajax({type:"POST",url:"ajax/updatecard.php",data:{word:a,answer:t}}).done((function(e){o++,p()||(i(s[o].word),h(s[o].status),scrollToPageTop())})).fail((function(e,a,t){showMessage("There was an unexpected error updating this word's status","alert-danger")}))})),$("#btn-translate").on("click",(function(){window.open(buildStudyTranslationLink(t,n),"_blank","noopener,noreferrer")})),$("#btn-img-dic").on("click",(function(){window.open(buildDictionaryLink(a,n.text()),"_blank","noopener,noreferrer")})),$(document).on("contextmenu",(function(e){return!/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)&&$(e.target).is(".word")&&window.open(buildStudyTranslationLink(t,$(e.target)),"_blank","noopener,noreferrer"),!1})),$(document).keypress((function(e){if(!$(".btn-answer").prop("disabled"))switch(e.which){case 49:$("#btn-answer-no-recall").click();break;case 50:$("#btn-answer-fuzzy").click();break;case 51:$("#btn-answer-partial").click();break;case 52:$("#btn-answer-excellent").click();break;default:break}}))}));