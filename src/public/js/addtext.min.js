$(document).ready((function(){function e(e){$("#alert-box").addClass("d-none"),$("#type").prop("selectedIndex",0),$("#title").val(""),$("#author").val(""),$("#title").val(""),$("#text").val(""),$("#upload-text").val(""),e||$("#url").val("")}function t(){const e=$("#text"),t=$("#span-chars-left"),n=1e4-e.val().length;n<0?(t.removeClass("text-success").addClass("text-danger"),t.html(n.toLocaleString()+" for Text-to-Speech (TTS) Support")):(t.removeClass("text-danger").addClass("text-success"),t.text(n.toLocaleString()+" left"))}function n(n){if(function(e){const t=$("#text").data("text-lang"),n=`https://${t}.wikipedia.org/wiki/`,a=`https://${t}.m.wikipedia.org/wiki/`;return e.startsWith(n)||e.startsWith(a)}(n)){const o=new URL(n).pathname.split("/").pop();!function(n){e(!0);const o="https://"+$("#text").data("text-lang")+".wikipedia.org/w/api.php",r={action:"query",prop:"extracts",titles:n,format:"json",explaintext:!0,origin:"*"};$.ajax({url:o,method:"GET",data:r}).done((function(e){const o=e.query.pages[Object.keys(e.query.pages)[0]];let r=o.extract.replace(/\[\d+\]/g,"");r=function(e){return e.replace(/\.(?=\p{L})(?!\p{L}\.)/gu,".\n\n")}(r),r=a(r);const i=decodeURIComponent(n.replace(/_/g," "));$("#title").val(i),$("#text").val(r),t()})).fail((function(e,t,n){showMessage("There was an unexpected error trying to fetch this Wikipedia article.","alert-danger")}))}(decodeURIComponent(o))}else!function(n){function o(e){return $("<input>").html(e).text()}e(!0),function(e){try{return new URL(e),!0}catch(e){return!1}}(n)&&($("#btn-fetch-img").removeClass().addClass("spinner-border spinner-border-sm text-warning"),$.ajax({type:"GET",url:"ajax/fetchurl.php",data:{url:n}}).done((function(e){if(null!=e.error_msg)showMessage("It was not possible to extract the text from the URL you provided. Try doing it manually.","alert-danger");else if(void 0!==e&&0!=e.length){const n=$("#text").data("text-lang");""!==e.lang&&e.lang!==n&&showMessage("It looks like you might be adding a text in a different language than the one currently active in Aprelendo. Please double-check to ensure it matches your selected language before proceeding. This helps keep your learning experience focused and organized!","alert-warning");const r=document.implementation.createHTMLDocument("New Document");r.documentElement.innerHTML=e.file_contents;const i=new Readability(r,{keepClasses:!1}).parse();if(null==i)return $("#url").val(e.url),void showMessage("It was not possible to extract the text from the URL you provided. Try doing it manually.","alert-danger");$("#title").val(o(i.title)),$("#author").val(o(i.byline)),$("#url").val(decodeURIComponent(e.url));const l=DOMPurify.sanitize(i.content||"",{USE_PROFILES:{html:!0},FORBID_TAGS:["figure","figcaption","img","picture","video","audio","iframe","form","button","input"],KEEP_CONTENT:!1}),s=$("<output>").append($.parseHTML(l,document,!1));let c=$("p, h1, h2, h3, h4, h5, h6, li, blockquote",s).map((function(){return $(this).text().replace(/\s+/g," ").trim()})).get().filter(Boolean).join("\n\n");c=a(c).replace(/\t/g,""),$("#text").val($.trim(c)),t()}else showMessage("There was an unexpected error trying to fetch this text.","alert-danger")})).fail((function(e,t,n){showMessage("There was an unexpected error trying to fetch this text.","alert-danger")})).always((function(){$("#btn-fetch-img").removeClass().addClass("bi bi-arrow-down-right-square text-warning")})))}(n)}function a(e){return e.replace(/(\r\n|\r|\n)+/g,"\n\n")}$("#external_call").length&&n($("#url").val()),$("#form-addtext").on("submit",(function(e){e.preventDefault();const t=new FormData(document.getElementById("form-addtext")),n=new URLSearchParams(window.location.search).get("id"),a=n?"ajax/edittext.php":"ajax/addtext.php";n&&t.append("id",n),$.ajax({type:"POST",url:a,data:t,dataType:"json",contentType:!1,processData:!1}).done((function(e){void 0!==e?showMessage(e.error_msg,"alert-danger"):"on"==t.get("shared-text")?window.location.replace("/sharedtexts"):window.location.replace("/texts")})).fail((function(e,t,n){showMessage("Oops! There was an unexpected error processing this text.","alert-danger")}))})),$("#text").on("input",(function(){t()})),$("#upload-text").on("change",(function(){const e=$(this)[0].files[0],n=new FileReader;n.onload=function(e){const n=e.target.result;$("#text").val(n),t()},n.readAsText(e),$(this).val("")})),$("#text").on("paste",(function(e){t()})),$("#btn-fetch").on("click",(function(e){n($("#url").val())})),$("#url").on("paste",(function(e){const t=$("#text").val();if(!t||/^\s*$/.test(t)){n(e.originalEvent.clipboardData.getData("text"))}})),$("#audio-url").on("input",(function(){const e=$(this).val(),t=$("#audio-url-helptext");e.includes("drive.google.com")?t.html('<i class="bi bi-cloud-fill"></i> Remember to <a href="https://support.google.com/drive/answer/2494822?hl=en&co=GENIE.Platform%3DDesktop#zippy=%2Cshare-a-file-publicly" target="_blank" rel="noopener noreferrer" class="alert-link">share this file publicly</a>, allowing access to anyone with the link.'):t.text("Accepts URLs from Google Drive or any standard audio source.")})),$("#text").text().length>0&&t()}));