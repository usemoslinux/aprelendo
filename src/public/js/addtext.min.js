$(document).ready((function(){function e(e){$("#alert-box").addClass("d-none"),$("#type").prop("selectedIndex",0),$("#title").val(""),$("#author").val(""),$("#title").val(""),$("#text").val(""),$("#upload-text").val(""),e||$("#url").val("")}function t(){const e=$("#text"),t=$("#span-chars-left"),n=1e4-e.val().length;n<0?(t.removeClass("text-success").addClass("text-danger"),t.html(n.toLocaleString()+" for Text-to-Speech (TTS) Support")):(t.removeClass("text-danger").addClass("text-success"),t.text(n.toLocaleString()+" left"))}function n(n){if(function(e){const t=$("#text").data("text-lang"),n=`https://${t}.wikipedia.org/wiki/`,a=`https://${t}.m.wikipedia.org/wiki/`;return e.startsWith(n)||e.startsWith(a)}(n)){const r=new URL(n).pathname.split("/").pop();!async function(n){e(!0);let r=$("#text").data("text-lang");const o="https://"+r+".wikipedia.org/w/api.php",i=new URLSearchParams({action:"query",prop:"extracts",titles:n,format:"json",explaintext:!0,origin:"*"});try{const e=await fetch(`${o}?${i.toString()}`);if(!e.ok)throw new Error(`HTTP error: ${e.status}`);const s=await e.json();if(!s.success)throw new Error(s.error_msg||"No data received from Wikipedia API.");let l=function(e,t){const n={ar:["انظر أيضا","مراجع","وصلات خارجية"],bg:["Вижте също","Източници","Външни препратки"],ca:["Vegeu també","Referències","Enllaços externs"],cs:["Viz též","Reference","Externí odkazy"],da:["Se også","Referencer","Eksterne henvisninger"],de:["Siehe auch","Einzelnachweise","Weblinks","Literatur"],el:["Δείτε επίσης","Παραπομπές","Εξωτερικοί σύνδεσμοι"],en:["See also","References","Further reading","External links"],es:["Véase también","Referencias","Bibliografía","Enlaces externos"],fr:["Voir aussi","Notes et références","Liens externes"],he:["ראו גם","הערות שוליים","קישורים חיצוניים"],hi:["इन्हें भी देखें","सन्दर्भ","बाहरी कड़ियाँ"],hr:["Vidi još","Izvori","Vanjske poveznice"],hu:["Lásd még","Jegyzetek","Források","További információk"],it:["Voci correlate","Note","Bibliografia","Collegamenti esterni"],ja:["関連項目","脚注","参考文献","外部リンク"],ko:["같이 보기","각주","참고 문헌","외부 링크"],nl:["Zie ook","Bronnen","Externe links"],no:["Se også","Referanser","Eksterne lenker"],pl:["Zobacz też","Przypisy","Bibliografia","Linki zewnętrzne"],pt:["Ver também","Referências","Ligações externas"],ro:["Vezi și","Note","Referințe","Legături externe"],ru:["См. также","Примечания","Литература","Ссылки"],sk:["Pozri aj","Referencie","Externé odkazy"],sl:["Glej tudi","Sklici","Viri","Zunanje povezave"],sv:["Se även","Referenser","Externa länkar"],tr:["Ayrıca bakınız","Kaynakça","Dış bağlantılar"],vi:["Xem thêm","Tham khảo","Liên kết ngoài"],zh:["参见","参考文献","外部链接"]},a=n[t]||n.en,r=new RegExp(`(\\n+|^)\\s*={2,}\\s*(${a.join("|")})\\s*={2,}`,"i"),o=e.search(r);if(-1!==o)return e.substring(0,o);return e}(s.query.pages[Object.keys(s.query.pages)[0]].extract,r);l=l.replace(/\[\d+\]/g,""),l=a(l),l=function(e){return e.replace(/[ \t]*=+[ \t]*/g,"")}(l);const c=decodeURIComponent(n.replace(/_/g," "));$("#title").val(c),$("#text").val(l),t()}catch(e){showMessage(e.message,"alert-danger")}}(decodeURIComponent(r))}else!async function(n){function r(e){return $("<input>").html(e).text()}if(e(!0),function(e){try{return new URL(e),!0}catch(e){return!1}}(n)){$("#btn-fetch-img").removeClass().addClass("spinner-border spinner-border-sm text-warning");try{const e=new URLSearchParams({url:n}),o=await fetch(`/ajax/fetchurl.php?${e.toString()}`);if(!o.ok)throw new Error(`HTTP error: ${o.status}`);const i=await o.json();if(!i.success)throw new Error(i.error_msg||"Failed to fetch text from URL.");const s=$("#text").data("text-lang");if(""!==i.payload.lang&&i.payload.lang!==s){showMessage("It looks like you might be adding a text in a different language \n                        than the one currently active in Aprelendo. Please double-check to ensure it \n                        matches your selected language before proceeding. This helps keep your learning \n                        experience focused and organized!","alert-warning")}const l=document.implementation.createHTMLDocument("New Document");l.documentElement.innerHTML=i.payload.file_contents;const c=new Readability(l,{keepClasses:!1}).parse();if(null==c)throw $("#url").val(i.payload.url),new Error("Readability parsing failed.");$("#title").val(r(c.title)),$("#author").val(r(c.byline)),$("#url").val(decodeURIComponent(i.payload.url));const u=DOMPurify.sanitize(c.content||"",{USE_PROFILES:{html:!0},FORBID_TAGS:["figure","figcaption","img","picture","video","audio","iframe","form","button","input"],KEEP_CONTENT:!1}),d=$("<output>").append($.parseHTML(u,document,!1));let p=$("p, h1, h2, h3, h4, h5, h6, li, blockquote",d).map((function(){return $(this).text().replace(/\s+/g," ").trim()})).get().filter(Boolean).join("\n\n");p=a(p).replace(/\t/g,""),$("#text").val(p.trim()),t()}catch(e){showMessage(e.message,"alert-danger")}finally{$("#btn-fetch-img").removeClass().addClass("bi bi-arrow-down-right-square text-warning")}}}(n)}function a(e){return e.replace(/(\r\n|\r|\n)([ \t\r\n]*)/g,"\n\n")}$("#external_call").length&&n($("#url").val()),$("#form-addtext").on("submit",(async function(e){e.preventDefault();const t=new FormData(document.getElementById("form-addtext")),n=new URLSearchParams(window.location.search).get("id"),a=n?"/ajax/edittext.php":"/ajax/addtext.php";n&&t.append("id",n);try{const e=await fetch(a,{method:"POST",body:t});if(!e.ok)throw new Error(`HTTP error: ${e.status}`);const n=await e.json();if(!n.success)throw new Error(n.error_msg||"Failed to add text");"on"==t.get("shared-text")?window.location.replace("/sharedtexts"):window.location.replace("/texts")}catch(e){showMessage(e.message,"alert-danger")}})),$("#text").on("input",(function(){t()})),$("#upload-text").on("change",(function(){const e=$(this)[0].files[0],n=new FileReader;n.onload=function(e){const n=e.target.result;$("#text").val(n),t()},n.readAsText(e),$(this).val("")})),$("#text").on("paste",(function(e){t()})),$("#btn-fetch").on("click",(function(e){n($("#url").val())})),$("#url").on("paste",(function(e){const t=$("#text").val();if(!t||/^\s*$/.test(t)){n(e.originalEvent.clipboardData.getData("text"))}})),$("#audio-url").on("input",(function(){const e=$(this).val(),t=$("#audio-url-helptext");e.includes("drive.google.com")?t.html('<i class="bi bi-cloud-fill"></i> Remember to <a href="https://support.google.com/drive/answer/2494822?hl=en&co=GENIE.Platform%3DDesktop#zippy=%2Cshare-a-file-publicly" target="_blank" rel="noopener noreferrer" class="alert-link">share this file publicly</a>, allowing access to anyone with the link.'):t.text("Accepts URLs from Google Drive or any standard audio source.")})),$("#text").text().length>0&&t()}));