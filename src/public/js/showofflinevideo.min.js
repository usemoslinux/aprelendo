$(document).ready((function(){let e=0;const t=$("html").attr("lang"),n=document.querySelector("video");let r=!0,o=.01*window.innerHeight;document.documentElement.style.setProperty("--vh",`${o}px`),Dictionaries.fetchURIs(),WordSelection.setupEvents({actionBtns:VideoActionBtns,controller:VideoController,linkBuilder:LinkBuilder.forTranslationInVideo}),$("#btn-add, #btn-forgot").on("click",(async function(e){const t=$(this);ActionBtns.setActionMenuLoading(t);const n=WordSelection.get(),r=n.text(),o=n.length>1?1:0;try{const e=new URLSearchParams({word:r.toLowerCase(),is_phrase:o,source_id:$("[data-idtext]").attr("data-idtext")||"",text_is_shared:!1,sentence:SentenceExtractor.extractSentence(n)}),a=await fetch("/ajax/addword.php",{method:"POST",body:e});if(!a.ok)throw new Error(`HTTP error: ${a.status}`);const s=await a.json();if(!s.success)throw new Error(s.error_msg||"Failed to add word.");if(o){const e=n.eq(0).text(),t=n.filter(".word").length;$("a.word").filter((function(){return $(this).text().toLowerCase()===e.toLowerCase()})).each((function(){let e=$(this).nextAll("a.word").slice(0,t-1).last(),n=$(this).nextUntil(e).addBack().next("a.word").addBack();n.text().toLowerCase()===r.toLowerCase()&&(n.wrapAll("<a class='word reviewing new'></a>"),n.contents().unwrap())}))}else{let e=$("a.word").filter((function(){return $(this).text().toLowerCase()===r.toLowerCase()}));e.each((function(){let e=$(this);e.is(".new, .learning, .learned, .forgotten")?e.wrap("<a class='word reviewing forgotten'></a>"):e.wrap("<a class='word reviewing new'></a>")})),e.contents().unwrap()}TextProcessor.updateAnchorsList()}catch(e){alert(`Oops! ${e.message}`)}finally{ActionBtns.clearActionMenuLoading(t),VideoActionBtns.hide(),VideoController.resume()}})),$("#btn-remove").on("click",(async function(){const e=$(this);ActionBtns.setActionMenuLoading(e);const n=WordSelection.get();try{const r=await fetch("/ajax/removeword.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({word:n.text().toLowerCase()})});if(!r.ok)throw new Error(`HTTP error: ${r.status}`);const o=await r.json();if(!o.success)throw new Error(o.error_msg||"Failed to remove word.");let a=$("a.word").filter((function(){return $(this).text().toLowerCase()===n.text().toLowerCase()}));const s=await fetch("/ajax/getuserwords.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({txt:n.text()})});if(!s.ok)throw new Error(`HTTP error: ${s.status}`);const i=await s.json();if(!i.success)throw new Error(i.error_msg||"Failed to get user words for re-underlining.");let c=$(TextUnderliner.apply(i.payload,t)),d={},l=/""/;a.each((function(){d=$(this),c.filter(".word").each((function(e){l=TextProcessor.langHasNoWordSeparators(t)?new RegExp("(?<![^])"+$(this).text()+"(?![$])","iug").exec(d.text()):new RegExp("(?<![\\p{L}|^])"+$(this).text()+"(?![\\p{L}|$])","iug").exec(d.text()),$(this).text(l);const n=$(this).text().toLowerCase(),r=i.payload.user_words.find((function(e){return e.word==n}));void 0!==r&&(2==r.status?$(this).removeClass("learning").addClass("new"):3==r.status&&$(this).removeClass("learning").addClass("forgotten"))})),d.replaceWith(c.clone())})),TextProcessor.updateAnchorsList()}catch(e){alert(`Oops! ${e.message}`)}finally{ActionBtns.clearActionMenuLoading(e),VideoActionBtns.hide(),VideoController.resume()}})),$("#btn-save-offline-video").on("click",(async function(){let t=[],n=[],o="";$("#text").find(".reviewing").each((function(){o=$(this).text().toLowerCase(),-1==$.inArray(o,t)&&t.push(o)})),n.push($("#text-container").attr("data-IdText"));try{const o=await fetch("/ajax/updatewords.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({words:JSON.stringify(t),textIDs:JSON.stringify(n)})});if(!o.ok)throw new Error(`HTTP error: ${o.status}`);const a=await o.json();if(!a.success)throw new Error(a.error_msg||"Failed to update words status.");const s={words:{new:getUniqueElements(".reviewing.new"),learning:getUniqueElements(".reviewing.learning"),forgotten:getUniqueElements(".reviewing.forgotten")},texts:{reviewed:1}},i=await fetch("/ajax/updateuserscore.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({review_data:JSON.stringify(s)})});if(!i.ok)throw new Error(`HTTP error: ${i.status}`);const c=await i.json();if(!c.success)throw new Error(c.error_msg||"Failed to update user score.");e=c.gems_earned,r=!1;const d="/textstats",l=Number($(".word").length)+Number($(".phrase").length),w=$('<form action="'+d+'" method="post"><input type="hidden" name="created" value="'+$(".reviewing.new").length+'" /><input type="hidden" name="learning" value="'+$(".reviewing.learning").length+'" /><input type="hidden" name="learned" value="'+$(".learned").length+'" /><input type="hidden" name="forgotten" value="'+$(".reviewing.forgotten").length+'" /><input type="hidden" name="total" value="'+l+'" /><input type="hidden" name="gems_earned" value="'+e+'" /><input type="hidden" name="is_shared" value="1" /></form>');$("body").append(w),w.trigger("submit")}catch(e){alert(`Oops! ${e.message}`)}})),$("#btn-selvideo").on("click",(function(e){e.preventDefault(),$("#video-file-input").trigger("click")})),$("#video-file-input").on("change",(function(){if(this.files[0]){const e=this.files[0],t=e.type;if(n.canPlayType(t)){const t=URL.createObjectURL(e);n.src=t}}})),$("#btn-selsubs").on("click",(function(e){e.preventDefault(),$("#subs-file-input").trigger("click")})),$("#subs-file-input").on("change",(function(){if(this.files[0]){const e=this.files[0],n=new FileReader;n.addEventListener("load",(async e=>{const n=e.target.result,r=parser.fromSrt(n,!0);let o="";for(const e of r){let t="<span";for(let n in e){let r=e[n];switch(n){case"startTime":t+=' data-start="'+r+'"';break;case"endTime":t+=' data-end="'+r+'"';break;case"text":t+=">"+r.replace(/(\r\n|\n|\r)/g," ");break;default:break}}t+="</span>\r\n",o+=t}document.getElementById("text").innerHTML=o;try{const e=new URLSearchParams({txt:$("#text").html()}),n=await fetch("/ajax/getuserwords.php",{method:"POST",body:e});if(!n.ok)throw new Error(`HTTP error: ${n.status}`);const r=await n.json();if(!r.success)throw new Error(r.error_msg||"Failed to get user words for underlining");$("#text").html(TextUnderliner.apply(r.payload,t)),TextProcessor.updateAnchorsList()}catch(e){alert(`Oops! ${e.message}`)}})),n.readAsText(e),$("#nosubs").remove(),$("#btn-save-offline-video").removeClass("disabled")}})),$(window).on("resize",(function(){o=.01*window.innerHeight,document.documentElement.style.setProperty("--vh",`${o}px`)})),$(window).on("beforeunload",(function(){if(r)return"Press Save before you go or your changes will be lost."}))}));