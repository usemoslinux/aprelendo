$(document).ready((function(){let e=0;const t=$("html").attr("lang"),r=document.querySelector("video");let n=!0,o=.01*window.innerHeight;document.documentElement.style.setProperty("--vh",`${o}px`),Dictionaries.fetchURIs(),WordSelection.setupEvents({actionBtns:VideoActionBtns,controller:VideoController,linkBuilder:LinkBuilder.forTranslationInVideo}),$("#btn-add, #btn-forgot").on("click",(async function(e){const t=WordSelection.get(),r=t.text(),n=t.length>1?1:0;try{const e=new URLSearchParams({word:r.toLowerCase(),is_phrase:n,source_id:$("[data-idtext]").attr("data-idtext")||"",text_is_shared:!1,sentence:SentenceExtractor.extractSentence(t)}),o=await fetch("/ajax/addword.php",{method:"POST",body:e});if(!o.ok)throw new Error(`HTTP error: ${o.status}`);const a=await o.json();if(!a.success)throw new Error(a.error_msg||"Failed to add word.");if(n){const e=t.eq(0).text(),n=t.filter(".word").length;$("a.word").filter((function(){return $(this).text().toLowerCase()===e.toLowerCase()})).each((function(){let e=$(this).nextAll("a.word").slice(0,n-1).last(),t=$(this).nextUntil(e).addBack().next("a.word").addBack();t.text().toLowerCase()===r.toLowerCase()&&(t.wrapAll("<a class='word reviewing new'></a>"),t.contents().unwrap())}))}else{let e=$("a.word").filter((function(){return $(this).text().toLowerCase()===r.toLowerCase()}));e.each((function(){let e=$(this);e.is(".new, .learning, .learned, .forgotten")?e.wrap("<a class='word reviewing forgotten'></a>"):e.wrap("<a class='word reviewing new'></a>")})),e.contents().unwrap()}TextProcessor.updateAnchorsList()}catch(e){alert(`Oops! ${e.message}`)}VideoActionBtns.hide(),VideoController.resume()})),$("#btn-remove").on("click",(async function(){const e=WordSelection.get();try{const r=await fetch("/ajax/removeword.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({word:e.text().toLowerCase()})});if(!r.ok)throw new Error(`HTTP error: ${r.status}`);const n=await r.json();if(!n.success)throw new Error(n.error_msg||"Failed to remove word.");let o=$("a.word").filter((function(){return $(this).text().toLowerCase()===e.text().toLowerCase()}));const a=await fetch("/ajax/getuserwords.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({txt:e.text()})});if(!a.ok)throw new Error(`HTTP error: ${a.status}`);const s=await a.json();if(!s.success)throw new Error(s.error_msg||"Failed to get user words for re-underlining.");let i=$(TextUnderliner.apply(s.payload,t)),d={},c=/""/;o.each((function(){d=$(this),i.filter(".word").each((function(e){c=TextProcessor.langHasNoWordSeparators(t)?new RegExp("(?<![^])"+$(this).text()+"(?![$])","iug").exec(d.text()):new RegExp("(?<![\\p{L}|^])"+$(this).text()+"(?![\\p{L}|$])","iug").exec(d.text()),$(this).text(c);const r=$(this).text().toLowerCase(),n=s.payload.user_words.find((function(e){return e.word==r}));void 0!==n&&(2==n.status?$(this).removeClass("learning").addClass("new"):3==n.status&&$(this).removeClass("learning").addClass("forgotten"))})),d.replaceWith(i.clone())})),TextProcessor.updateAnchorsList()}catch(e){alert(`Oops! ${e.message}`)}VideoActionBtns.hide(),VideoController.resume()})),$("#btn-save-offline-video").on("click",(async function(){let t=[],r=[],o="";$("#text").find(".reviewing").each((function(){o=$(this).text().toLowerCase(),-1==$.inArray(o,t)&&t.push(o)})),r.push($("#text-container").attr("data-IdText"));try{const o=await fetch("/ajax/updatewords.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({words:JSON.stringify(t),textIDs:JSON.stringify(r)})});if(!o.ok)throw new Error(`HTTP error: ${o.status}`);const a=await o.json();if(!a.success)throw new Error(a.error_msg||"Failed to update words status.");const s={words:{new:getUniqueElements(".reviewing.new"),learning:getUniqueElements(".reviewing.learning"),forgotten:getUniqueElements(".reviewing.forgotten")},texts:{reviewed:1}},i=await fetch("/ajax/updateuserscore.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({review_data:JSON.stringify(s)})});if(!i.ok)throw new Error(`HTTP error: ${i.status}`);const d=await i.json();if(!d.success)throw new Error(d.error_msg||"Failed to update user score.");e=d.gems_earned,n=!1;const c="/textstats",l=Number($(".word").length)+Number($(".phrase").length),w=$('<form action="'+c+'" method="post"><input type="hidden" name="created" value="'+$(".reviewing.new").length+'" /><input type="hidden" name="learning" value="'+$(".reviewing.learning").length+'" /><input type="hidden" name="learned" value="'+$(".learned").length+'" /><input type="hidden" name="forgotten" value="'+$(".reviewing.forgotten").length+'" /><input type="hidden" name="total" value="'+l+'" /><input type="hidden" name="gems_earned" value="'+e+'" /><input type="hidden" name="is_shared" value="1" /></form>');$("body").append(w),w.trigger("submit")}catch(e){alert(`Oops! ${e.message}`)}})),$("#btn-selvideo").on("click",(function(e){e.preventDefault(),$("#video-file-input").trigger("click")})),$("#video-file-input").on("change",(function(){if(this.files[0]){const e=this.files[0],t=e.type;if(r.canPlayType(t)){const t=URL.createObjectURL(e);r.src=t}}})),$("#btn-selsubs").on("click",(function(e){e.preventDefault(),$("#subs-file-input").trigger("click")})),$("#subs-file-input").on("change",(function(){if(this.files[0]){const e=this.files[0],r=new FileReader;r.addEventListener("load",(async e=>{const r=e.target.result,n=parser.fromSrt(r,!0);let o="";for(const e of n){let t="<span";for(let r in e){let n=e[r];switch(r){case"startTime":t+=' data-start="'+n+'"';break;case"endTime":t+=' data-end="'+n+'"';break;case"text":t+=">"+n.replace(/(\r\n|\n|\r)/g," ");break;default:break}}t+="</span>\r\n",o+=t}document.getElementById("text").innerHTML=o;try{const e=new URLSearchParams({txt:$("#text").html()}),r=await fetch("/ajax/getuserwords.php",{method:"POST",body:e});if(!r.ok)throw new Error(`HTTP error: ${r.status}`);const n=await r.json();if(!n.success)throw new Error(n.error_msg||"Failed to get user words for underlining");$("#text").html(TextUnderliner.apply(n.payload,t)),TextProcessor.updateAnchorsList()}catch(e){alert(`Oops! ${e.message}`)}})),r.readAsText(e),$("#nosubs").remove(),$("#btn-save-offline-video").removeClass("disabled")}})),$(window).on("resize",(function(){o=.01*window.innerHeight,document.documentElement.style.setProperty("--vh",`${o}px`)})),$(window).on("beforeunload",(function(){if(n)return"Press Save before you go or your changes will be lost."}))}));