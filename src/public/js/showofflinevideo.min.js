$(document).ready((function(){let e,t,n,o,i,r=document.querySelector("video"),a=!1,s=!1,l=null,d="",c="",u="",h=!1,p=!1,f=!0,g=0,w=$("html").attr("lang"),m=.01*window.innerHeight;function x(){h&&(r.play(),h=!1)}function v(e){e&&$("#text-container").enableScroll(),hideActionButtons()}document.documentElement.style.setProperty("--vh",`${m}px`),$.ajax({url:"ajax/getdicuris.php",type:"GET",dataType:"json"}).done((function(e){null==e.error_msg&&(d=e.dictionary_uri,c=e.img_dictionary_uri,u=e.translator_uri)})),$(document).on("contextmenu",(function(e){return e.preventDefault(),!1})),$(document).on("mousedown touchstart",".word",(function(o){o.stopPropagation(),v(!1),p=r.paused,p||(r.pause(),h=!0),o.which<2?(a=!0,e=t=$(this),"touchstart"==o.type&&(n=new Date,i=e.offset().top-$(window).scrollTop())):3==o.which&&(l=$(this),window.open(buildVideoTranslationLink(u,l),"_blank","noopener,noreferrer"))})),$(document).on("mouseup touchend",".word",(function(i){i.stopPropagation(),o=new Date,"touchend"==i.type&&(s||(a=o-n>1e3),$("html").css({overflow:"visible"}),s=!1),a&&i.which<2&&(a=!1,e===t&&(l=$(this)),$(".highlighted").removeClass("highlighted"),l.addClass("highlighted"),function(){getWordFrequency(l.text(),w),$("#text-container").disableScroll(),setWordActionButtons(l);setDicActionButtonsClick(l,{dictionary:d,img_dictionary:c,translator:u}),showActionButtons(l)}())})),$(document).on("mouseover touchmove",".word",(function(r){if(r.stopPropagation(),o=new Date,"touchmove"==r.type){const e=$(this).offset().top-$(window).scrollTop();s=s||Math.abs(i-e)>0,s||(a=o-n>1e3)}a&&("touchmove"==r.type&&$("html").css({overflow:"hidden"}),$(".highlighted").removeClass("highlighted"),t="mouseover"===r.type?$(this):$(document.elementFromPoint(r.originalEvent.touches[0].clientX,r.originalEvent.touches[0].clientY)),e.parent().get(0)===t.parent().get(0)?t.isAfter(e)?(e.nextUntil(t.next(),".word").addBack().addClass("highlighted"),l=e.nextUntil(t.next()).addBack()):(e.prevUntil(t.prev(),".word").addBack().addClass("highlighted"),l=t.nextUntil(e.next()).addBack()):t=l=e)})),$("#btn-add, #btn-forgot").on("click",(function(){const e=l.text(),t=l.length>1?1:0;$.ajax({type:"POST",url:"ajax/addword.php",data:{word:e.toLowerCase(),is_phrase:t,source_id:null,text_is_shared:null,sentence:getVideoSentence(l)}}).done((function(){if(t){const t=l.eq(0).text(),n=l.filter(".word").length;$("a.word").filter((function(){return $(this).text().toLowerCase()===t.toLowerCase()})).each((function(){let t=$(this).nextAll("a.word").slice(0,n-1).last(),o=$(this).nextUntil(t).addBack().next("a.word").addBack();o.text().toLowerCase()===e.toLowerCase()&&(o.wrapAll("<a class='word reviewing new'></a>"),o.contents().unwrap())}))}else{let t=$("a.word").filter((function(){return $(this).text().toLowerCase()===e.toLowerCase()}));t.each((function(){let e=$(this);e.is(".new, .learning, .learned, .forgotten")?e.wrap("<a class='word reviewing forgotten'></a>"):e.wrap("<a class='word reviewing new'></a>")})),t.contents().unwrap()}})).fail((function(e,t,n){alert("Oops! There was an error adding this word or phrase to the database.")})),v(!0),x()})),$(window).on("resize",(function(){m=.01*window.innerHeight,document.documentElement.style.setProperty("--vh",`${m}px`)})),$("#btn-remove").on("click",(function(){$.ajax({type:"POST",url:"ajax/removeword.php",data:{word:l.text().toLowerCase()}}).done((function(){let e=$("a.word").filter((function(){return $(this).text().toLowerCase()===l.text().toLowerCase()}));$.ajax({type:"POST",url:"/ajax/getuserwords.php",data:{txt:l.text()},dataType:"json"}).done((function(t){let n=$(underlineWords(t,w,!1)),o={},i=/""/;e.each((function(){o=$(this),n.filter(".word").each((function(e){i=langs_with_no_word_separator.includes(w)?new RegExp("(?<![^])"+$(this).text()+"(?![$])","iug").exec(o.text()):new RegExp("(?<![\\p{L}|^])"+$(this).text()+"(?![\\p{L}|$])","iug").exec(o.text()),$(this).text(i);const n=$(this).text().toLowerCase(),r=t.user_words.find((function(e){return e.word==n}));void 0!==r&&(2==r.status?$(this).removeClass("learning").addClass("new"):3==r.status&&$(this).removeClass("learning").addClass("forgotten"))})),o.replaceWith(n.clone())}))})).fail((function(e,t,n){}))})).fail((function(e,t,n){alert("Oops! There was an error removing the word from the database.")})),v(!0),x()})),$("#btn-save-offline-video").on("click",(function(){let e=[],t=[],n="";$(".learning").each((function(){n=$(this).text().toLowerCase(),-1==$.inArray(n,e)&&e.push(n)})),t.push($("#text-container").attr("data-IdText")),$.ajax({type:"POST",url:"ajax/archivetext.php",data:{words:e,textIDs:JSON.stringify(t)}}).done((function(e){if(null==e.error_msg){const e={words:{new:getUniqueElements(".reviewing.new"),learning:getUniqueElements(".reviewing.learning"),forgotten:getUniqueElements(".reviewing.forgotten")},texts:{reviewed:1}};$.ajax({type:"post",url:"ajax/updateuserscore.php",data:e}).done((function(e){if(null==e.error_msg){g=e.gems_earned,f=!1;const t="/textstats",n=Number($(".word").length)+Number($(".phrase").length),o=$('<form action="'+t+'" method="post"><input type="hidden" name="created" value="'+$(".reviewing.new").length+'" /><input type="hidden" name="reviewed" value="'+$(".reviewing.learning").length+'" /><input type="hidden" name="learned" value="'+$(".learned").length+'" /><input type="hidden" name="forgotten" value="'+$(".reviewing.forgotten").length+'" /><input type="hidden" name="total" value="'+n+'" /><input type="hidden" name="gems_earned" value="'+g+'" /><input type="hidden" name="is_shared" value="1" /></form>');$("body").append(o),o.submit()}else alert("Oops! There was an unexpected error.")})).fail((function(e,t,n){alert("Oops! There was an unexpected error.")}))}else alert("Oops! There was an unexpected error.")})).fail((function(e,t,n){alert("Oops! There was an error updating the database.")}))})),$(document).on("mouseup touchend","#text-container",(function(e){if(!1===$(e.target).is(".word")&&!$(e.target).closest("#action-buttons").length>0){e.stopPropagation();let t=$("#text-container");a=!1,t.find(".highlighted").removeClass("highlighted"),v(!0),x()}})),$("#btn-selvideo").on("click",(function(e){e.preventDefault(),$("#video-file-input").trigger("click")})),$("#video-file-input").on("change",(function(){if(this.files[0]){const e=this.files[0],t=e.type;if(r.canPlayType(t)){const t=URL.createObjectURL(e);r.src=t}}})),$("#btn-selsubs").on("click",(function(e){e.preventDefault(),$("#subs-file-input").trigger("click")})),$("#subs-file-input").on("change",(function(){if(this.files[0]){const e=this.files[0],t=new FileReader;t.addEventListener("load",(e=>{const t=e.target.result,n=parser.fromSrt(t,!0);let o="";for(const e of n){let t='<div class="text-center"';for(let n in e){let o=e[n];switch(n){case"startTime":t+=' data-start="'+o+'"';break;case"endTime":t+=' data-end="'+o+'"';break;case"text":t+=">"+o;break;default:break}}t+="</div>",o+=t}document.getElementById("text-container").innerHTML=o,$.ajax({type:"POST",url:"/ajax/getuserwords.php",data:{txt:$("#text-container").html()},dataType:"json"}).done((function(e){$("#text-container").html(underlineWords(e,w,!1))})).fail((function(e,t,n){}))})),t.readAsText(e)}})),$("#btn-fullscreen").on("click",(function(e){if(document.fullscreenElement)document.exitFullscreen().catch((e=>{alert(`An error occurred while trying to exit fullscreen mode: ${e.message} (${e.name})`)}));else{document.documentElement.requestFullscreen({navigationUI:"show"}).catch((e=>{alert(`An error occurred while trying to switch into fullscreen mode: ${e.message} (${e.name})`)}))}})),$("#video-stream").on("timeupdate",(function(e){const t=1e3*document.getElementById("video-stream").currentTime;let n=$("div.text-center","#text-container"),o=n.filter((function(){return $(this).attr("data-start")<t})).last();o.length>0&&!o.hasClass("video-reading-line")&&(n.removeClass("video-reading-line"),o.addClass("video-reading-line"),o[0].scrollIntoView({behavior:"auto",block:"center",inline:"center"}))})),$(window).on("beforeunload",(function(){if(f)return"To save your progress, please click the Save button before you go. Otherwise, your changes will be lost. Are you sure you want to exit this page?"}))}));