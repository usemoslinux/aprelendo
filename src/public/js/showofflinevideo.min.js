$(document).ready((function(){let e,t,n,o=!1,r=-1,i=-1,a=null,s=0;const l=$("html").attr("lang"),c=$(parent.document),u=document.querySelector("video");let d=!0,h=.01*window.innerHeight;function f(r){o=!1,t=r.pageX,n=r.pageY,e=setTimeout((function(){o=!0,VideoController.pause(!0)}),500)}function g(){clearTimeout(e),t=null,n=null}function p(){if(o&&r>=0&&i>=0){TextProcessor.getAnchorsList().eq(r).parent()[0]===TextProcessor.getAnchorsList().eq(i).parent()[0]&&(a=TextHighlighter.getSelection(r,i),VideoActionBtns.show(a))}g(),o=!1,r=-1,i=-1}function w(e){(function(e){if(null==t||null==n)return!1;const o=e.pageX-t,r=e.pageY-n;return Math.abs(o)>10||Math.abs(r)>10})(e)&&g(),o&&function(e){if(!o||r<0)return;const t=document.elementFromPoint(e.clientX,e.clientY),n=$(t).closest("a");n.length&&(i=TextProcessor.getAnchorIndex(n),TextHighlighter.removeAll(),TextHighlighter.addSelection(r,i))}(e)}document.documentElement.style.setProperty("--vh",`${h}px`),Dictionaries.fetchURIs(),c.on("contextmenu",(function(e){return e.preventDefault(),!1})),c.on("click","#text .word",(function(e){o||(a=$(this),TextHighlighter.removeAll(),a.addClass("highlighted"),VideoActionBtns.hide(),VideoController.pause(!0),VideoActionBtns.show(a))})),c.on("mousedown touchstart","#text .word",(function(e){r=TextProcessor.getAnchorIndex($(this))})),c.on("mousedown","#text",(function(e){if(e.originalEvent.which<2)f(e);else if(3==e.originalEvent.which){VideoController.pause(!1),a=$(e.target);const t=Dictionaries.getURIs();openInNewTab(LinkBuilder.forTranslationInVideo(t.translator,a))}})),c.on("mousemove","#text",(function(e){w(e)})),c.on("mouseup","#text",(function(e){p()})),c.on("touchstart","#text",(function(e){f(e.originalEvent.touches[0])})),c.on("touchmove","#text",(function(e){w(e.originalEvent.touches[0])})),c.on("touchend","#text",(function(e){p()})),c.on("mouseup touchend",(function(e){if($("#action-buttons").is(":visible")){let t=$(e.target).is(".word"),n=$(e.target).closest(".btn").length>0,o=$(e.target).closest(".offcanvas").length>0,r=$(e.target).closest(".modal").length>0;t||n||o||r||(e.stopPropagation(),TextHighlighter.removeAll(),VideoActionBtns.hide(),VideoController.resume())}})),$("#btn-add, #btn-forgot").on("click",(function(e){const t=a.text(),n=a.length>1?1:0;$.ajax({type:"POST",url:"ajax/addword.php",data:{word:t.toLowerCase(),is_phrase:n,source_id:$("[data-idtext]").attr("data-idtext"),text_is_shared:!0,sentence:SentenceExtractor.extractSentence(a)}}).done((function(){if(n){const e=a.eq(0).text(),n=a.filter(".word").length;$("a.word").filter((function(){return $(this).text().toLowerCase()===e.toLowerCase()})).each((function(){let e=$(this).nextAll("a.word").slice(0,n-1).last(),o=$(this).nextUntil(e).addBack().next("a.word").addBack();o.text().toLowerCase()===t.toLowerCase()&&(o.wrapAll("<a class='word reviewing new'></a>"),o.contents().unwrap())}))}else{let e=$("a.word").filter((function(){return $(this).text().toLowerCase()===t.toLowerCase()}));e.each((function(){let e=$(this);e.is(".new, .learning, .learned, .forgotten")?e.wrap("<a class='word reviewing forgotten'></a>"):e.wrap("<a class='word reviewing new'></a>")})),e.contents().unwrap()}TextProcessor.updateAnchorsList()})).fail((function(e,t,n){alert("Oops! There was an error adding this word or phrase to the database.")})),VideoActionBtns.hide(),VideoController.resume()})),$("#btn-remove").on("click",(function(){$.ajax({type:"POST",url:"ajax/removeword.php",data:{word:a.text().toLowerCase()}}).done((function(){let e=$("a.word").filter((function(){return $(this).text().toLowerCase()===a.text().toLowerCase()}));$.ajax({type:"POST",url:"/ajax/getuserwords.php",data:{txt:a.text()},dataType:"json"}).done((function(t){let n=$(TextUnderliner.apply(t,l,!1)),o={},r=/""/;e.each((function(){o=$(this),n.filter(".word").each((function(e){r=TextProcessor.langHasNoWordSeparators(l)?new RegExp("(?<![^])"+$(this).text()+"(?![$])","iug").exec(o.text()):new RegExp("(?<![\\p{L}|^])"+$(this).text()+"(?![\\p{L}|$])","iug").exec(o.text()),$(this).text(r);const n=$(this).text().toLowerCase(),i=t.user_words.find((function(e){return e.word==n}));void 0!==i&&(2==i.status?$(this).removeClass("learning").addClass("new"):3==i.status&&$(this).removeClass("learning").addClass("forgotten"))})),o.replaceWith(n.clone())})),TextProcessor.updateAnchorsList()})).fail((function(e,t,n){}))})).fail((function(e,t,n){alert("Oops! There was an error removing the word from the database.")})),VideoActionBtns.hide(),VideoController.resume()})),$("#btn-save-offline-video").on("click",(function(){let e=[],t=[],n="";$(".learning").each((function(){n=$(this).text().toLowerCase(),-1==$.inArray(n,e)&&e.push(n)})),t.push($("#text-container").attr("data-IdText")),$.ajax({type:"POST",url:"ajax/archivetext.php",data:{words:e,textIDs:JSON.stringify(t)}}).done((function(e){if(null==e.error_msg){const e={words:{new:getUniqueElements(".reviewing.new"),learning:getUniqueElements(".reviewing.learning"),forgotten:getUniqueElements(".reviewing.forgotten")},texts:{reviewed:1}};$.ajax({type:"post",url:"ajax/updateuserscore.php",data:e}).done((function(e){if(null==e.error_msg){s=e.gems_earned,d=!1;const t="/textstats",n=Number($(".word").length)+Number($(".phrase").length),o=$('<form action="'+t+'" method="post"><input type="hidden" name="created" value="'+$(".reviewing.new").length+'" /><input type="hidden" name="reviewed" value="'+$(".reviewing.learning").length+'" /><input type="hidden" name="learned" value="'+$(".learned").length+'" /><input type="hidden" name="forgotten" value="'+$(".reviewing.forgotten").length+'" /><input type="hidden" name="total" value="'+n+'" /><input type="hidden" name="gems_earned" value="'+s+'" /><input type="hidden" name="is_shared" value="1" /></form>');$("body").append(o),o.submit()}else alert("Oops! There was an unexpected error.")})).fail((function(e,t,n){alert("Oops! There was an unexpected error.")}))}else alert("Oops! There was an unexpected error.")})).fail((function(e,t,n){alert("Oops! There was an error updating the database.")}))})),$("#btn-selvideo").on("click",(function(e){e.preventDefault(),$("#video-file-input").trigger("click")})),$("#video-file-input").on("change",(function(){if(this.files[0]){const e=this.files[0],t=e.type;if(u.canPlayType(t)){const t=URL.createObjectURL(e);u.src=t}}})),$("#btn-selsubs").on("click",(function(e){e.preventDefault(),$("#subs-file-input").trigger("click")})),$("#subs-file-input").on("change",(function(){if(this.files[0]){const e=this.files[0],t=new FileReader;t.addEventListener("load",(e=>{const t=e.target.result,n=parser.fromSrt(t,!0);let o="";for(const e of n){let t="<span";for(let n in e){let o=e[n];switch(n){case"startTime":t+=' data-start="'+o+'"';break;case"endTime":t+=' data-end="'+o+'"';break;case"text":t+=">"+o.replace(/(\r\n|\n|\r)/g," ");break;default:break}}t+="</span>\r\n",o+=t}document.getElementById("text").innerHTML=o,$.ajax({type:"POST",url:"/ajax/getuserwords.php",data:{txt:$("#text").html()},dataType:"json"}).done((function(e){$("#text").html(TextUnderliner.apply(e,l,!1)),TextProcessor.updateAnchorsList()})).fail((function(e,t,n){}))})),t.readAsText(e)}})),$("#btn-fullscreen").on("click",(function(e){if(document.fullscreenElement)document.exitFullscreen().catch((e=>{alert(`An error occurred while trying to exit fullscreen mode: ${e.message} (${e.name})`)}));else{document.documentElement.requestFullscreen({navigationUI:"show"}).catch((e=>{alert(`An error occurred while trying to switch into fullscreen mode: ${e.message} (${e.name})`)}))}})),$(window).on("resize",(function(){h=.01*window.innerHeight,document.documentElement.style.setProperty("--vh",`${h}px`)})),$(window).on("beforeunload",(function(){if(d)return"To save your progress, please click the Save button before you go. Otherwise, your changes will be lost. Are you sure you want to exit this page?"}))}));