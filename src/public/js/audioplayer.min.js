const AudioController=(()=>{const t=document.getElementById("audioplayer"),e=document.getElementById("audio-source"),n=document.getElementById("ap-play-btn"),r=document.getElementById("ap-play-btn-icon"),a=document.getElementById("ap-progress-bar"),o=document.getElementById("ap-progress-bar-container"),i=document.getElementById("ap-elapsedtime-stamp"),l=document.getElementById("ap-hovertime-stamp"),s=document.getElementById("ap-totaltime-stamp"),d=document.querySelectorAll("#ap-speed-menu .dropdown-item"),c=document.getElementById("ap-abloop-btn"),u=document.getElementById("ap-chapter-controls"),p=document.getElementById("ap-chapter-select"),m=document.getElementById("ap-prev-chapter"),h=document.getElementById("ap-next-chapter"),g=t&&t.dataset.playlistSrc||"",b=t&&t.dataset.playlistType||"",y=g.trim(),f=b.trim().toLowerCase(),E=""!==y,v=""!==f?f:"m3u";let x=!1,L=-1,N=-1,C=[],S=0,T=!1,A=null,B=null,$=!1,w=!1,M=()=>{},I=()=>{},k=()=>{},F=()=>{},P=()=>{},q=()=>{},R=()=>!1,j=()=>{},D=()=>"",X=()=>{},U=()=>1,W=()=>{};if(t){if(r){const t=e&&e.getAttribute("src");(E||t)&&(r.className="spinner-border spinner-border-sm")}M=()=>{!E||T?t.play():$=!0},I=()=>{t.pause(),t.currentTime=0},k=e=>{x=!(t.paused&&!x)&&e,t.pause()},P=()=>{t.paused||t.ended?M():t.pause()},F=()=>{x&&(M(),x=!1)},q=()=>{t.pause(),t.currentTime=0,M()},R=()=>E;const g=(t,e)=>{try{return new URL(t,e).href}catch(e){return t}},b=(t,e)=>{const n=t.split(/\r?\n/),r=[];let a="";return n.forEach((t=>{const n=t.trim();if(!n)return;if(n.startsWith("#EXTINF")){const t=n.split(",");return void(a=t.length>1?t.slice(1).join(",").trim():"")}if(n.startsWith("#"))return;const o=g(n,e),i=a||`Chapter ${r.length+1}`;r.push({title:i,url:o}),a=""})),r},f=(t,e)=>{const n=(new DOMParser).parseFromString(t,"application/xml");if(n.getElementsByTagName("parsererror").length>0)return[];const r=Array.from(n.querySelectorAll("item, entry")),a=[];return r.forEach((t=>{const n=t.querySelector("title");let r=n?n.textContent.trim():"",o="";const i=t.querySelector("enclosure");if(i&&i.getAttribute("url")&&(o=i.getAttribute("url")),!o){const e=t.querySelector("media\\:content");e&&e.getAttribute("url")&&(o=e.getAttribute("url"))}if(!o){Array.from(t.querySelectorAll("link")).some((t=>!("enclosure"!==(t.getAttribute("rel")||"").toLowerCase()||!t.getAttribute("href"))&&(o=t.getAttribute("href"),!0)))}o&&(r||(r=`Chapter ${a.length+1}`),a.push({title:r,url:g(o,e)}))})),a},_=()=>{u&&p&&(E&&0!==C.length?(p.innerHTML="",C.forEach(((t,e)=>{const n=document.createElement("option");n.value=String(e),n.textContent=t.title,p.appendChild(n)})),p.value=String(S),u.classList.remove("d-none"),m&&(m.disabled=0===S),h&&(h.disabled=S>=C.length-1)):u.classList.add("d-none"))},H=()=>{null!==A&&(t.currentTime=A,A=null)},O=(o,l=0,d=!1)=>{if(!E||!C.length)return;const c=Math.min(Math.max(o,0),C.length-1);S=c;const u=C[c];u&&u.url&&(w=d,n&&(n.classList="btn btn-primary"),r&&(r.className="spinner-border spinner-border-sm"),a&&(a.style.width="0%"),i&&(i.textContent="00:00"),s&&(s.textContent=""),e.src=u.url,t.load(),A=l,_(),d&&t.play())},z=(t,e)=>{E&&(T?O(t,e,!1):B={index:t,seconds:e})};j=t=>{if(!E||!t)return;const e=String(t).split("|");if(2!==e.length)return;const n=parseInt(e[0],10),r=parseFloat(e[1]);Number.isNaN(n)||Number.isNaN(r)||z(n,r)},D=()=>{if(!E)return"";const e=Number.isFinite(t.currentTime)?Math.floor(t.currentTime):0;return`${S}|${e}`};const G=t=>{n.classList="btn btn-danger disabled",r.className="bi bi-play-fill",i.textContent=t,s.textContent=""},J=t=>fetch(t,{cache:"no-store"}).then((e=>{if(!e.ok)throw new Error("Failed to fetch playlist");return e.text().then((n=>({text:n,url:e.url||t})))})),K=t=>{const e="rss"===v?"rss":"m3u",n=`${"rss"===v?"/ajax/fetchrss.php":"/ajax/fetchm3u.php"}?url=${encodeURIComponent(t)}`;return fetch(n).then((t=>t.json())).then((n=>{if(n&&n.error_msg)throw new Error(n.error_msg);return{text:n&&n[e]?n[e]:"",url:n&&n.url?n.url:t}}))},Q=()=>{E&&J(y).catch((()=>K(y))).then((({text:e,url:n})=>{C="rss"===v?f(e,n):b(e,n),T=C.length>0,T?(B?(O(B.index,B.seconds,!1),B=null):O(0,0,!1),$&&($=!1,t.play())):G("No playable chapters found.")})).catch((()=>{G("Error loading playlist!")}))},V=()=>{if(!Number.isFinite(t.duration)||t.duration<=0)return a.style.width="0%",i.textContent="00:00",void(s.textContent="");let e=t.currentTime/t.duration*100;a.style.width=`${e}%`;let n=Math.floor(t.currentTime/3600),r=Math.floor(t.currentTime%3600/60),o=Math.floor(t.currentTime%60),l=Math.floor(t.duration/3600),d=Math.floor(t.duration%3600/60),c=Math.floor(t.duration%60),u=n>0?`${n}:`:"";u+=`${r<10?"0":""}${r}:${o<10?"0":""}${o}`;let p=l>0?`${l}:`:"";p+=`${d<10?"0":""}${d}:${c<10?"0":""}${c}`,i.textContent=u,s.textContent=p};X=e=>{Number.isFinite(e)&&(t.playbackRate=e,document.querySelectorAll("#ap-speed-menu .dropdown-item").forEach((t=>{parseFloat(t.getAttribute("data-speed"))===e?t.classList.add("active"):t.classList.remove("active")})))},U=()=>t.playbackRate,W=e=>{if(!Number.isFinite(e))return;const n=t.duration,r=t.currentTime+e;Number.isFinite(n)?t.currentTime=Math.min(Math.max(r,0),n):t.currentTime=Math.max(r,0)},n.addEventListener("click",P),t.addEventListener("loadedmetadata",V),t.addEventListener("loadedmetadata",H),t.addEventListener("timeupdate",(()=>{N>-1&&t.currentTime>=N&&(t.currentTime=L),V()})),o.addEventListener("click",(e=>{const n=o.getBoundingClientRect(),r=(e.clientX-n.left)/n.width;t.currentTime=r*t.duration})),window.matchMedia("(hover: hover)").matches&&(o.addEventListener("mousemove",(e=>{const n=o.getBoundingClientRect(),r=e.clientX-n.left,a=r/n.width,i=Math.max(0,Math.floor(a*t.duration)),s=Math.floor(i/3600),d=Math.floor(i%3600/60),c=i%60;l.textContent=s>0?`${s}:${d.toString().padStart(2,"0")}:${c.toString().padStart(2,"0")}`:`${d.toString().padStart(2,"0")}:${c.toString().padStart(2,"0")}`,l.style.left=`${r}px`,l.style.display="block"})),o.addEventListener("mouseleave",(t=>{l.style.display="none"}))),d.forEach((t=>{t.addEventListener("click",(t=>{t.preventDefault();const e=t.target;if(e.hasAttribute("data-speed")){const t=parseFloat(e.getAttribute("data-speed"));X(t)}}))})),t.addEventListener("play",(()=>{w=!1,r.className="bi bi-pause-fill"})),t.addEventListener("pause",(()=>{w=!1,r.className="bi bi-play-fill"})),t.addEventListener("ended",(()=>{E&&C.length>0&&S<C.length-1?O(S+1,0,!0):(t.currentTime=0,r.className="bi bi-play-fill")})),e.addEventListener("error",(()=>{""!==e.src&&e.src!==window.location.href&&(w=!1,n.classList="btn btn-danger disabled",r.className="bi bi-play-fill",i.textContent="Error loading audio!",s.textContent="")})),t.addEventListener("loadedmetadata",(()=>{w||(t.paused||t.ended?r.className="bi bi-play-fill":r.className="bi bi-pause-fill")})),p&&p.addEventListener("change",(()=>{const e=parseInt(p.value,10);if(Number.isNaN(e))return;const n=!t.paused&&!t.ended;O(e,0,n)})),m&&m.addEventListener("click",(()=>{const e=!t.paused&&!t.ended;O(S-1,0,e)})),h&&h.addEventListener("click",(()=>{const e=!t.paused&&!t.ended;O(S+1,0,e)})),c&&c.addEventListener("click",(function(e){e.preventDefault(),e.stopPropagation(),-1===L?(L=t.currentTime,c.textContent="B",setNewTooltip(c,"Loop audio from point A to point B, click to set point B")):L>-1&&-1===N?(N=t.currentTime,c.style.backgroundColor="var(--bs-btn-color)",c.style.color="black",c.textContent="A-B",setNewTooltip(c,"Stop the A-B loop"),c.blur()):(L=N=-1,c.textContent="A",c.style.backgroundColor="var(--bs-btn-bg)",c.style.color="var(--bs-btn-color)",setNewTooltip(c,"Loop audio from point A to point B, click to set point A"),c.blur())})),Q()}return{play:M,stop:I,pause:k,resume:F,togglePlayPause:P,playFromBeginning:q,isPlaylist:R,setPlaylistPositionFromString:j,getPlaylistPositionString:D,setSpeed:X,getSpeed:U,seekRelative:W}})();