const AudioController=(()=>{const t=document.getElementById("audioplayer"),e=document.getElementById("audio-source"),n=document.getElementById("ap-play-btn"),r=document.getElementById("ap-play-btn-icon"),a=document.getElementById("ap-progress-bar"),o=document.getElementById("ap-progress-bar-container"),l=document.getElementById("ap-elapsedtime-stamp"),i=document.getElementById("ap-hovertime-stamp"),s=document.getElementById("ap-totaltime-stamp"),d=document.querySelectorAll("#ap-speed-menu .dropdown-item"),c=document.getElementById("ap-abloop-btn"),u=document.getElementById("ap-chapter-controls"),p=document.getElementById("ap-chapter-select"),m=document.getElementById("ap-prev-chapter"),h=document.getElementById("ap-next-chapter"),g=t&&t.dataset.playlistSrc||"",b=t&&t.dataset.playlistType||"",y=g.trim(),f=b.trim().toLowerCase(),E=""!==y,v=""!==f?f:"m3u";let L=!1,x=-1,C=-1,N=[],A=0,B=!1,S=null,$=null,w=!1,T=!1,I=()=>{},M=()=>{},k=()=>{},F=()=>{},P=()=>{},q=()=>{},R=()=>!1,j=()=>{},D=()=>"";if(t){if(r){const t=e&&e.getAttribute("src");(E||t)&&(r.className="spinner-border spinner-border-sm")}I=()=>{!E||B?t.play():w=!0},M=()=>{t.pause(),t.currentTime=0},k=e=>{L=!(t.paused&&!L)&&e,t.pause()},P=()=>{t.paused||t.ended?I():t.pause()},F=()=>{L&&(I(),L=!1)},q=()=>{t.pause(),t.currentTime=0,I()},R=()=>E;const g=(t,e)=>{try{return new URL(t,e).href}catch(e){return t}},b=(t,e)=>{const n=t.split(/\r?\n/),r=[];let a="";return n.forEach((t=>{const n=t.trim();if(!n)return;if(n.startsWith("#EXTINF")){const t=n.split(",");return void(a=t.length>1?t.slice(1).join(",").trim():"")}if(n.startsWith("#"))return;const o=g(n,e),l=a||`Chapter ${r.length+1}`;r.push({title:l,url:o}),a=""})),r},f=(t,e)=>{const n=(new DOMParser).parseFromString(t,"application/xml");if(n.getElementsByTagName("parsererror").length>0)return[];const r=Array.from(n.querySelectorAll("item, entry")),a=[];return r.forEach((t=>{const n=t.querySelector("title");let r=n?n.textContent.trim():"",o="";const l=t.querySelector("enclosure");if(l&&l.getAttribute("url")&&(o=l.getAttribute("url")),!o){const e=t.querySelector("media\\:content");e&&e.getAttribute("url")&&(o=e.getAttribute("url"))}if(!o){Array.from(t.querySelectorAll("link")).some((t=>!("enclosure"!==(t.getAttribute("rel")||"").toLowerCase()||!t.getAttribute("href"))&&(o=t.getAttribute("href"),!0)))}o&&(r||(r=`Chapter ${a.length+1}`),a.push({title:r,url:g(o,e)}))})),a},X=()=>{u&&p&&(E&&0!==N.length?(p.innerHTML="",N.forEach(((t,e)=>{const n=document.createElement("option");n.value=String(e),n.textContent=t.title,p.appendChild(n)})),p.value=String(A),u.classList.remove("d-none"),m&&(m.disabled=0===A),h&&(h.disabled=A>=N.length-1)):u.classList.add("d-none"))},U=()=>{null!==S&&(t.currentTime=S,S=null)},W=(o,i=0,d=!1)=>{if(!E||!N.length)return;const c=Math.min(Math.max(o,0),N.length-1);A=c;const u=N[c];u&&u.url&&(T=d,n&&(n.classList="btn btn-primary"),r&&(r.className="spinner-border spinner-border-sm"),a&&(a.style.width="0%"),l&&(l.textContent="00:00"),s&&(s.textContent=""),e.src=u.url,t.load(),S=i,X(),d&&t.play())},_=(t,e)=>{E&&(B?W(t,e,!1):$={index:t,seconds:e})};j=t=>{if(!E||!t)return;const e=String(t).split("|");if(2!==e.length)return;const n=parseInt(e[0],10),r=parseFloat(e[1]);Number.isNaN(n)||Number.isNaN(r)||_(n,r)},D=()=>{if(!E)return"";const e=Number.isFinite(t.currentTime)?Math.floor(t.currentTime):0;return`${A}|${e}`};const H=t=>{n.classList="btn btn-danger disabled",r.className="bi bi-play-fill",l.textContent=t,s.textContent=""},O=t=>fetch(t,{cache:"no-store"}).then((e=>{if(!e.ok)throw new Error("Failed to fetch playlist");return e.text().then((n=>({text:n,url:e.url||t})))})),z=t=>{const e="rss"===v?"rss":"m3u",n=`${"rss"===v?"/ajax/fetchrss.php":"/ajax/fetchm3u.php"}?url=${encodeURIComponent(t)}`;return fetch(n).then((t=>t.json())).then((n=>{if(n&&n.error_msg)throw new Error(n.error_msg);return{text:n&&n[e]?n[e]:"",url:n&&n.url?n.url:t}}))},G=()=>{E&&O(y).catch((()=>z(y))).then((({text:e,url:n})=>{N="rss"===v?f(e,n):b(e,n),B=N.length>0,B?($?(W($.index,$.seconds,!1),$=null):W(0,0,!1),w&&(w=!1,t.play())):H("No playable chapters found.")})).catch((()=>{H("Error loading playlist!")}))},J=()=>{if(!Number.isFinite(t.duration)||t.duration<=0)return a.style.width="0%",l.textContent="00:00",void(s.textContent="");let e=t.currentTime/t.duration*100;a.style.width=`${e}%`;let n=Math.floor(t.currentTime/3600),r=Math.floor(t.currentTime%3600/60),o=Math.floor(t.currentTime%60),i=Math.floor(t.duration/3600),d=Math.floor(t.duration%3600/60),c=Math.floor(t.duration%60),u=n>0?`${n}:`:"";u+=`${r<10?"0":""}${r}:${o<10?"0":""}${o}`;let p=i>0?`${i}:`:"";p+=`${d<10?"0":""}${d}:${c<10?"0":""}${c}`,l.textContent=u,s.textContent=p},K=e=>{t.playbackRate=e,document.querySelectorAll("#ap-speed-menu .dropdown-item").forEach((t=>{parseFloat(t.getAttribute("data-speed"))===e?t.classList.add("active"):t.classList.remove("active")}))};n.addEventListener("click",P),t.addEventListener("loadedmetadata",J),t.addEventListener("loadedmetadata",U),t.addEventListener("timeupdate",(()=>{C>-1&&t.currentTime>=C&&(t.currentTime=x),J()})),o.addEventListener("click",(e=>{const n=o.getBoundingClientRect(),r=(e.clientX-n.left)/n.width;t.currentTime=r*t.duration})),window.matchMedia("(hover: hover)").matches&&(o.addEventListener("mousemove",(e=>{const n=o.getBoundingClientRect(),r=e.clientX-n.left,a=r/n.width,l=Math.max(0,Math.floor(a*t.duration)),s=Math.floor(l/3600),d=Math.floor(l%3600/60),c=l%60;i.textContent=s>0?`${s}:${d.toString().padStart(2,"0")}:${c.toString().padStart(2,"0")}`:`${d.toString().padStart(2,"0")}:${c.toString().padStart(2,"0")}`,i.style.left=`${r}px`,i.style.display="block"})),o.addEventListener("mouseleave",(t=>{i.style.display="none"}))),d.forEach((t=>{t.addEventListener("click",(t=>{t.preventDefault();const e=t.target;if(e.hasAttribute("data-speed")){const t=parseFloat(e.getAttribute("data-speed"));K(t)}}))})),t.addEventListener("play",(()=>{T=!1,r.className="bi bi-pause-fill"})),t.addEventListener("pause",(()=>{T=!1,r.className="bi bi-play-fill"})),t.addEventListener("ended",(()=>{E&&N.length>0&&A<N.length-1?W(A+1,0,!0):(t.currentTime=0,r.className="bi bi-play-fill")})),e.addEventListener("error",(()=>{""!==e.src&&e.src!==window.location.href&&(T=!1,n.classList="btn btn-danger disabled",r.className="bi bi-play-fill",l.textContent="Error loading audio!",s.textContent="")})),t.addEventListener("loadedmetadata",(()=>{T||(t.paused||t.ended?r.className="bi bi-play-fill":r.className="bi bi-pause-fill")})),p&&p.addEventListener("change",(()=>{const e=parseInt(p.value,10);if(Number.isNaN(e))return;const n=!t.paused&&!t.ended;W(e,0,n)})),m&&m.addEventListener("click",(()=>{const e=!t.paused&&!t.ended;W(A-1,0,e)})),h&&h.addEventListener("click",(()=>{const e=!t.paused&&!t.ended;W(A+1,0,e)})),c&&c.addEventListener("click",(function(e){e.preventDefault(),e.stopPropagation(),-1===x?(x=t.currentTime,c.textContent="B",setNewTooltip(c,"Loop audio from point A to point B, click to set point B")):x>-1&&-1===C?(C=t.currentTime,c.style.backgroundColor="var(--bs-btn-color)",c.style.color="black",c.textContent="A-B",setNewTooltip(c,"Stop the A-B loop"),c.blur()):(x=C=-1,c.textContent="A",c.style.backgroundColor="var(--bs-btn-bg)",c.style.color="var(--bs-btn-color)",setNewTooltip(c,"Loop audio from point A to point B, click to set point A"),c.blur())})),G()}return{play:I,stop:M,pause:k,resume:F,togglePlayPause:P,playFromBeginning:q,isPlaylist:R,setPlaylistPositionFromString:j,getPlaylistPositionString:D}})();