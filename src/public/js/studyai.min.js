$(document).ready((function(){let e=[],t=10,r=0,a=[["0",0,"bg-success","Excellent"],["1",0,"bg-warning","Partial"],["2",0,"bg-primary","Fuzzy"],["3",0,"bg-danger","No recall"]];function s(a){var s;$("#study-card").data("word",a.word),function(){const e=Math.round((r+1)/t*100);$("#live-progress-bar").css("width",e+"%").attr("aria-valuenow",e)}(),$("#card-counter").text(r+1+"/"+t),$("#study-card-word-title").removeClass("placeholder").text(a.word),s=a.word,$("#select-prompt option").each((function(){const e=$(this),t=e.data("template")||e.text();e.data("template")||e.data("template",t);const r=t.replace(/{word}/,`"${s}"`);e.text(r)})),function(t){const a=$("#study-card-freq-badge");if(t)a.removeClass("placeholder").addClass("border border-light").text("Phrase/Expression");else{const t=Dictionaries.getWordFrequency(e[r].frequency_index)+" frequency";a.removeClass("placeholder").addClass("border border-light").text(t)}}(e[r].is_phrase),d(a.status)}function n(){if(0==t)return o(),!0;if(r>=t){$("#study-card-word-title").text("Congratulations!"),$("#study-card-freq-badge").addClass("d-none"),d();let r="";for(const e of a){let a=e[1],s=a/t*100;r+=`\n                    <div class="progress-bar ${e[2]}" \n                        role="progressbar" \n                        aria-valuenow="${s}" \n                        aria-valuemin="0" \n                        aria-valuemax="100" \n                        style="width: ${s}%" \n                        title="${e[3]}: ${a} answer(s)">\n                        ${Math.round(s)} %\n                    </div>`}return $("#ai-card").html(`\n                <div class="bi bi-trophy text-warning display-3 mt-3"></div>\n                <div class="mt-3">You have reached the end of your study.</div>\n                <div class="mt-3">These were your results:</div>\n                <div class="progress mx-auto mt-3 fw-bold" style="height: 25px; max-width: 550px">\n                    ${r}\n                </div>\n                ${function(){const t='<table class="table table-bordered table-striped text-end small mx-auto mt-3"\n            aria-describedby="" style="max-width: 550px">\n        <thead>\n            <tr class="table-light">\n                <th>Word</th>\n                <th>Recall level</th>\n            </tr>\n        </thead>\n        <tbody>';let r="";const s="</tbody></table>";return e.forEach((e=>{r+='<tr><td><a class="word bw-bold">'+e.word+'</a></td><td><span class="word-description '+a[e.status][2]+'">'+a[e.status][3]+"</span></td></tr>"})),t+r+s}()}\n                <div class="small mt-4">\n                    If you want to continue, you can refresh this page (F5).<br>\n                    However, we strongly recommend that you keep your study sessions short \n                    and take rest intervals.\n                </div>\n            `),$("#study-card-footer").addClass("d-none"),$("#live-progress").addClass("d-none"),scrollToPageTop(),!0}return!1}function o(){$("#study-card-header").text("Sorry, no cards to practice"),d(3),$("#ai-card").html("\n            <div class='bi bi-exclamation-circle text-danger display-3'></div>\n            <div class='mt-3'>It seems there are no cards in your deck. Add\n            some words to your library and try again.</div>\n        "),$("#study-card-footer").addClass("d-none"),$("#live-progress").addClass("d-none")}function d(e){const t=$("#study-card"),r=$("#study-card-header");switch(t.removeClass((function(e,t){return(t.match(/\bborder-\S+/g)||[]).join(" ")})),r.removeClass((function(e,t){return(t.match(/\bborder-\S+|\bbg-\S+/g)||[]).join(" ")})),e){case 0:t.addClass("border-success"),r.addClass("bg-gradient bg-success border-success");break;case 1:t.addClass("border-warning"),r.addClass("bg-gradient bg-warning border-warning");break;case 2:t.addClass("border-primary"),r.addClass("bg-gradient bg-primary border-primary");break;case 3:t.addClass("border-danger"),r.addClass("bg-gradient bg-danger border-danger");break;default:t.addClass("border-secondary"),r.addClass("bg-gradient bg-secondary border-secondary");break}}$(".btn-answer").prop("disabled",!0),Dictionaries.fetchURIs(),async function(){try{const r=new URLSearchParams({limit:t,status:0}),a=await fetch("/ajax/getcards.php",{method:"POST",body:r});if(!a.ok)throw new Error(`HTTP error: ${a.status}`);const n=await a.json();if(!n.success)throw new Error(n.error_msg||"Failed to fetch list of cards.");if(0==n.payload.length)return o(),!0;e=n.payload.map((e=>({...e,word:e.word.replace(/\r?\n|\r/g," ")}))),t=e.length>t?t:e.length,s(e[0])}catch(e){alert(`Oops! ${e.message}`)}}(),$("#btn-submit-user-answer").on("click",(function(){if(""!==$("#text-user-answer").val().trim()){const e="Evaluate user response in two lines: first line with one of the four ratings (1) Completely incorrect (major mistakes or confused meaning); (2) Incorrect, but close (made some significant usage mistakes, but I was on the right track); (3) Mostly correct (made minor errors (missing details, awkward phrasing, etc.); or (4) Correct & comprehensive (perfect answer). Second line with a brief explanation and, if useful, a corrected version. Keep it concise."+"\n Question:"+$("#select-prompt").val()+"\n Answer: "+$("#text-user-answer").val();if(!e)return;const t=new showdown.Converter;$("#text-ai-answer").html("Lingobot is thinking..."),AIBot.streamReply(e,{onUpdate(e){const r=t.makeHtml(e);$("#text-ai-answer").html(r)},onError(){$("#text-ai-answer").html("<p>Failed to get response from AI. Please try again.</p>")}})}else $("#text-ai-answer").html("(1) Completely incorrect â€” couldn't provide an answer.");$(".btn-answer").prop("disabled",!1)})),$(".btn-answer").on("click",(async function(t){t.preventDefault();const o=$("#study-card").data("word"),d=$(this).attr("value");a[d][1]=a[d][1]+1,e[r].status=d,$(".btn-answer").prop("disabled",!0),$("#text-ai-answer").text(""),$("#text-user-answer").val("").trigger("focus");try{const t=new URLSearchParams({word:o,answer:d}),a=await fetch("/ajax/updatecard.php",{method:"POST",body:t});if(!a.ok)throw new Error(`HTTP error: ${a.status}`);const i=await a.json();if(!i.success)throw new Error(i.error_msg||"Failed to update word status.");if(r++,n())return;s(e[r]),scrollToPageTop()}catch(e){alert(`Oops! ${e.message}`)}})),$("body").on("click",".word",(function(){StudyActionBtns.show($(this))})),$(document).on("mouseup touchend",(function(e){!1===$(e.target).is(".word")&&!$(e.target).closest("#action-buttons").length>0&&(e.stopPropagation(),ActionBtns.hide())})),$(document).on("contextmenu",(function(e){return!1})),$(document).on("keypress",(function(e){if(!$(".btn-answer").prop("disabled"))switch(e.which){case 49:$("#btn-answer-no-recall").trigger("click");break;case 50:$("#btn-answer-fuzzy").trigger("click");break;case 51:$("#btn-answer-partial").trigger("click");break;case 52:$("#btn-answer-excellent").trigger("click");break;default:break}}))}));