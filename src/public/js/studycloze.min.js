$(document).ready((function(){let e=$(),t=[],r=10,a=0,s=[],n=[["0",0,"bg-success","Excellent"],["1",0,"bg-warning","Partial"],["2",0,"bg-primary","Fuzzy"],["3",0,"bg-danger","No recall"],["4",0,"text-warning bg-dark","No example sentence found!"]];async function o(e){$("#answer-card").addClass("d-none"),$(".btn-answer").prop("disabled",!0),$("#guess-ui").removeClass("d-none"),$("#guess-input").val("").trigger("focus"),$("#guess-feedback").removeClass("text-danger text-success").addClass("text-secondary").text("First letters, spaces & word length are locked as hints.");const u=function(e){const t=e.split(" ");return t.map((e=>{const t=Array.from(e);if(t.length<3)return e;const r=t[0],a=t.slice(1);let s;for(let e=0;e<10;e++){s=[...a];for(let e=s.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[s[e],s[t]]=[s[t],s[e]]}if(s.join("")!==a.join(""))break}return r+s.join("")})).join(" ")}(e);$("#study-card").data("word",e),$("#study-card").data("scrambled",u),$("#study-card").data("revealed",!1),$("#study-card-word-title").removeClass("placeholder").text(u),await async function(e,u){if(l())return;$("#examples-placeholder").removeClass("d-none"),$("#study-card-examples").empty();try{const g=new URLSearchParams({word:e}),p=await fetch("/ajax/getcards.php",{method:"POST",body:g});if(!p.ok)throw new Error(`HTTP error: ${p.status}`);const b=await p.json();if(!b.success)throw new Error(b.error_msg||"Failed to fetch example sentences.");let h=[],f="";const m=$("#card").data("lang"),y="(?<![\\p{L}])"+w(e)+"(?![\\p{L}])";let x=new RegExp("([^\\n.?!]|[\\d][.][\\d]|[A-Z][.](?:[A-Z][.])+)*"+y+"([^\\n.?!]|[.][\\d]|[.](?:[A-Z][.])+)*[\\n.?!]","gmiu");"ja"!=m&&"zh"!=m||(x=new RegExp("[^\n?!。]*"+w(e)+"[^\n?!。]*[\n?!。]","gmiu"));if((Array.isArray(b.payload)?b.payload:b.payload?[b.payload]:[]).forEach((t=>{let r;for(;null!==(r=x.exec(t.text));)if(r.index===x.lastIndex&&x.lastIndex++,h.length<3){let a=r[0];a!==e&&(t.text=i(a)?t.text:a,h=d(h,t))}})),$("#study-card").data("word",e),function(){const e=Math.round((a+1)/r*100);$("#live-progress-bar").css("width",e+"%").attr("aria-valuenow",e)}(),$("#card-counter").text(a+1+"/"+r),h=function(e){let t,r=e.length;for(;r>0;)t=Math.floor(Math.random()*r),r--,[e[r],e[t]]=[e[t],e[r]];return e}(h),s=h,0===h.length){if(t[a].status=4,n[4][1]=n[4][1]+1,a++,l())return;await o(t[a].word)}else h.forEach((t=>{f+=c(t,e,u,!0)})),function(e){const r=$("#study-card-freq-badge");if(e)r.removeClass("placeholder").addClass("border border-light").text("Phrase/Expression");else{const e=Dictionaries.getWordFrequency(t[a].frequency_index)+" frequency";r.removeClass("placeholder").addClass("border border-light").text(e)}}(t[a].is_phrase),$("#examples-placeholder").addClass("d-none"),$("#study-card-examples").html(f)}catch(e){alert(`Oops! ${e.message}`)}}(e,u)}function d(e,t){if(0===e.length)return e.push(t),e;for(let r=0;r<e.length;r++){const a=e[r];if(t.text.includes(a.text))return e[r]=t,e;if(a.text.includes(t.text))return e}return e.push(t),e}function c(e,t,r,a){const s=new RegExp("(?<![\\p{L}|\\d])"+w(t)+"(?![\\p{L}|\\d])","gmiu");let n="",o="";return o=e.text.replace(s,(function(){return`<a class='${(!a?"word ":"")+"fw-bold bg-warning-subtle border-bottom p-1"}' ${a?"title='scrambled – guess the original word'":""}>${f(a?r:t)}</a>`})),n=`<blockquote cite='${e.source_uri}'>`,n+=`<p class='mb-0'>${o}</p>`,n+=`<cite style='font-size:.85rem' class='text-secondary fw-medium'>${""==e.author?"Anonymous":e.author}`,""==e.source_uri||e.source_uri.endsWith(".epub")?n+=", "+e.title:n+=`, <a href='${e.source_uri}' target='_blank'>${e.title}</a>`,n+="</cite></blockquote>",n}function i(e){const t=(e.match(/"/g)||[]).length,r=(e.match(/"/g)||[]).length,a=(e.match(/"/g)||[]).length;return t%2!=0||r!==a}function l(){if(0==r)return u(),!0;if(a>=r){$("#study-card-word-title").text("Congratulations!"),$("#study-card-freq-badge").addClass("d-none"),g();let e="";for(const t of n){let a=t[1],s=a/r*100;e+=`\n                    <div class="progress-bar ${t[2]}" \n                        role="progressbar" \n                        aria-valuenow="${s}" \n                        aria-valuemin="0" \n                        aria-valuemax="100" \n                        style="width: ${s}%" \n                        title="${t[3]}: ${a} answer(s)">\n                        ${Math.round(s)} %\n                    </div>`}return $("#study-card-examples").html(`\n                <div class="bi bi-trophy text-warning display-3 mt-3"></div>\n                <div class="mt-3">You have reached the end of your study.</div>\n                <div class="mt-3">These were your results:</div>\n                <div class="progress mx-auto mt-3 fw-bold" style="height: 25px; max-width: 550px">\n                    ${e}\n                </div>\n                ${function(){const e='<table class="table table-bordered table-striped text-end small mx-auto mt-3" style="max-width: 550px">\n                <thead>\n                    <tr class="table-light">\n                        <th>Word</th>\n                        <th>Recall level</th>\n                    </tr>\n                </thead>\n                <tbody>';let r="";const a="</tbody></table>";return t.forEach((e=>{r+='<tr><td><a class="word fw-bold bg-warning-subtle border-bottom p-1">'+f(e.word)+'</a></td><td><span class="word-description '+n[e.status][2]+'">'+n[e.status][3]+"</span></td></tr>"})),e+r+a}()}\n                <div class="small mt-4">\n                    If you want to continue, you can refresh this page (F5).<br>\n                    However, we strongly recommend that you keep your study sessions short \n                    and take rest intervals.\n                </div>\n            `),$("#study-card-footer").addClass("d-none"),$("#examples-placeholder").addClass("d-none"),$("#live-progress").addClass("d-none"),$("#guess-ui").addClass("d-none"),scrollToPageTop(),!0}return!1}function u(){$("#study-card-header").text("Sorry, no cards to practice"),g(3),$("#study-card-examples").html("<div class='bi bi-exclamation-circle text-danger display-3'></div><div class='mt-3'>It seems there are no cards in your deck. Add some words to your library and try again.</div>"),$("#study-card-footer").addClass("d-none"),$("#examples-placeholder").addClass("d-none"),$("#live-progress").addClass("d-none"),$("#guess-ui").addClass("d-none")}function g(e){const t=$("#study-card"),r=$("#study-card-header");switch(t.removeClass((function(e,t){return(t.match(/\bborder-\S+/g)||[]).join(" ")})),r.removeClass((function(e,t){return(t.match(/\bborder-\S+|\bbg-\S+/g)||[]).join(" ")})),e){case 0:t.addClass("border-success"),r.addClass("bg-gradient bg-success border-success");break;case 1:t.addClass("border-warning"),r.addClass("bg-gradient bg-warning border-warning");break;case 2:t.addClass("border-primary"),r.addClass("bg-gradient bg-primary border-primary");break;case 3:t.addClass("border-danger"),r.addClass("bg-gradient bg-danger border-danger");break;default:t.addClass("border-secondary"),r.addClass("bg-gradient bg-secondary border-secondary");break}}function p(){const e=($("#guess-input").val()||"").trim(),t=$("#study-card").data("word");e&&(h(e)===h(t)?($("#guess-feedback").removeClass("text-secondary text-danger").addClass("text-success").text("Correct! Showing the original."),b()):$("#guess-feedback").removeClass("text-secondary text-success").addClass("text-danger").text("Not quite. Try again or show the answer."))}function b(){const e=$("#study-card").data("word");if($("#study-card").data("revealed"))return;$("#study-card").data("revealed",!0),$("#study-card-word-title").text(e);let t="";const r=$("#study-card").data("scrambled");for(const a of s)t+=c(a,e,r,!1);$("#study-card-examples").html(t),$("#answer-card").removeClass("d-none"),$(".btn-answer").prop("disabled",!1),$("#guess-ui").addClass("d-none")}function h(e){return e.toLocaleLowerCase().normalize("NFKC").trim()}function w(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function f(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}$(".btn-answer").prop("disabled",!0),$("#answer-card").addClass("d-none"),Dictionaries.fetchURIs(),function(){if($("#guess-ui").length)return;$("#study-card-body").prepend('\n            <div id="guess-ui" class="mb-3" style="max-width: 550px; margin: 0 auto;">\n                <div class="input-group">\n                    <input id="guess-input" type="text" class="form-control"\n                           placeholder="Type the correct word…" aria-label="Your guess">\n                    <button id="guess-submit" class="btn btn-outline-primary" type="button">Check</button>\n                    <button id="guess-reveal" class="btn btn-secondary" type="button">Show answer</button>\n                </div>\n                <div id="guess-feedback" class="form-text mt-2 text-secondary">\n                    First letters, spaces & word length are locked as hints.\n                </div>\n            </div>\n        '),$("#guess-submit").on("click",p),$("#guess-reveal").on("click",b),$("#guess-input").on("keypress",(function(e){13===e.which&&(e.preventDefault(),p())}))}(),async function(){try{const e=new URLSearchParams({limit:r}),a=await fetch("/ajax/getcards.php",{method:"POST",body:e});if(!a.ok)throw new Error(`HTTP error: ${a.status}`);const s=await a.json();if(!s.success)throw new Error(s.error_msg||"Failed to fetch list of cards.");if(0==s.payload.length)return u(),!0;t=s.payload.map((e=>({...e,word:e.word.replace(/\r?\n|\r/g," ")}))),r=t.length>r?r:t.length,$("#card-counter").text("1/"+r),g(t[0].status),await o(t[0].word)}catch(e){alert(`Oops! ${e.message}`)}}(),$("body").on("click",".word",(function(){e=$(this),StudyActionBtns.show(e)})),$(".btn-answer").on("click",(async function(e){e.preventDefault();const r=$("#study-card").data("word"),s=$(this).attr("value");n[s][1]=n[s][1]+1,t[a].status=s,$(".btn-answer").prop("disabled",!0);try{const e=new URLSearchParams({word:r,answer:s}),n=await fetch("/ajax/updatecard.php",{method:"POST",body:e});if(!n.ok)throw new Error(`HTTP error: ${n.status}`);const d=await n.json();if(!d.success)throw new Error(d.error_msg||"Failed to update card status.");if(a++,l())return;g(t[a].status),scrollToPageTop(),await o(t[a].word)}catch(e){alert(`Oops! ${e.message}`)}$("#btn-answer-prev").trigger("click")})),$("#btn-answer-prev").on("click",(function(e){e.preventDefault(),$("#answer-card-page-1").removeClass("d-none"),$("#answer-card-page-2").addClass("d-none")})),$("#btn-answer-more").on("click",(function(e){e.preventDefault(),$("#answer-card-page-1").addClass("d-none"),$("#answer-card-page-2").removeClass("d-none")})),$("#btn-translate").on("click",(function(){const t=Dictionaries.getURIs();e.length&&openInNewTab(LinkBuilder.forTranslationInStudy(t.translator,e))})),$("#btn-img-dic").on("click",(function(){const t=Dictionaries.getURIs();e.length&&openInNewTab(LinkBuilder.forWordInDictionary(t.img_dictionary,e.text()))})),$(document).on("contextmenu",(function(e){if(!isMobileDevice()&&$(e.target).is(".word")){const t=Dictionaries.getURIs();openInNewTab(LinkBuilder.forTranslationInStudy(t.translator,$(e.target)))}return!1})),$(document).on("keypress",(function(e){if(!$(".btn-answer").prop("disabled"))switch(e.which){case 49:$("#btn-answer-no-recall").trigger("click");break;case 50:$("#btn-answer-fuzzy").trigger("click");break;case 51:$("#btn-answer-partial").trigger("click");break;case 52:$("#btn-answer-excellent").trigger("click");break;default:break}})),$(document).on("mouseup touchend",(function(e){!1===$(e.target).is(".word")&&!$(e.target).closest("#action-buttons").length>0&&(e.stopPropagation(),ActionBtns.hide())}))}));