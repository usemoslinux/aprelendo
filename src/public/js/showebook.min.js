$(document).ready((function(){const e=$("html").attr("lang"),t=$("#text").attr("data-idText"),n=ePub();let o="";window.parent.show_confirmation_dialog=!0;let r=document.getElementById("text");(new FormData).append("id",t),fetch("ajax/getebook.php?id="+t).then((function(e){if(200===e.status)return e;throw new Error(e.statusText)})).then((e=>e.arrayBuffer())).then((e=>n.open(e))).catch((function(e){alert("There was an unexpected problem opening this ebook file. Try again later."),window.location.replace("/texts")}));let i=n.renderTo("text",{flow:"scrolled-doc"}),a=document.getElementById("readerpage");i.themes.register("darkmode","/css/ebooks.min.css"),i.themes.register("lightmode","/css/ebooks.min.css"),i.themes.register("sepiamode","/css/ebooks.min.css"),i.themes.default({body:{"font-family":a.style.fontFamily+" !important","font-size":a.style.fontSize+" !important","text-align":a.style.textAlign+" !important","line-height":a.style.lineHeight+" !important",padding:"0 5% !important"}}),i.themes.select(a.className),n.opened.then((function(){$.ajax({type:"POST",url:"/ajax/ebookposition.php",data:{mode:"GET",id:t},dataType:"json"}).done((function(e){const t=e.text_pos,n=parseFloat(e.audio_pos),o=document.getElementById("audioplayer"),r=document.getElementById("videoplayer");c(t||1),null!=o?isNaN(n)?o.currentTime=0:o.currentTime=n:null!=r&&initializeVideoPlayer(n)})).fail((function(e,t,n){c(1),null!=audio&&(audio.currentTime=0)}))})),n.loaded.spine.then((e=>{e.each((e=>{e.load(n.load.bind(n))}))}));let l=document.getElementById("next");l.addEventListener("click",(function(e){e.preventDefault(),$(l).tooltip("hide"),$.when(s()).then((function(){c(l.getAttribute("href"))}))}),!1);let d=document.getElementById("prev");function s(){let e=[],t="";return window.parent.show_confirmation_dialog=!1,$("#text").find(".reviewing").each((function(){t=$(this).text().toLowerCase(),-1==jQuery.inArray(t,e)&&e.push(t)})),$.ajax({type:"POST",url:"/ajax/archivetext.php",data:{words:e}}).done((function(e){if(null==e.error_msg){const e={words:{new:getUniqueElements(".reviewing.new"),learning:getUniqueElements(".reviewing.learning"),forgotten:getUniqueElements(".reviewing.forgotten")},texts:{reviewed:1}};return $.ajax({type:"post",url:"/ajax/updateuserscore.php",data:e}).done((function(e){null!=e.error_msg&&alert("Oops! There was an unexpected error updating user score.")})).fail((function(e,t,n){alert("Oops! There was an unexpected error updating user score.")}))}alert("Oops! There was an error unexpected error saving this text.")})).fail((function(e,t,n){alert("Oops! There was an error unexpected error saving this text.")}))}function c(t){let i=n.spine.get(t),a="";return i&&i.render().then((function(s){let c=function(e){e=e.replace(/[\r\n]+/g," ");let t=$("<div/>").append(e);t.contents().filter((function(){return 8===this.nodeType})).remove(),t.find('link[rel="stylesheet"]').remove(),t.find("head, meta, style, title, br").remove(),t.find("*").each((function(){if("img"!==this.tagName.toLowerCase())$(this).removeAttr("class").removeAttr("style").removeAttr("id");else for(let e=this.attributes.length-1;e>=0;e--){let t=this.attributes[e].name;"src"!==t&&"alt"!==t&&$(this).removeAttr(t)}}));const n=["div","blockquote","p","h1","h2","h3","h4","h5","h6"];function o(e){if(e.nodeType===Node.TEXT_NODE)return e.nodeValue;if(e.nodeType===Node.ELEMENT_NODE){let t=e.tagName.toLowerCase();if("img"===t)return e.outerHTML;{let r="";return $(e).contents().each((function(){r+=o(this)})),-1!==n.indexOf(t)?"\n"+r+"\n":r}}return""}let r=o(t[0]);return r=r.replace(/\n\s*\n/g,"\n\n").trim(),$("<div/>").append(r)}(s);$(".loading-spinner-container").fadeIn(300),$("#text-container").hide(),$.ajax({type:"POST",url:"/ajax/getuserwords.php",data:{txt:c.html()},dataType:"json"}).done((function(t){a=TextUnderliner.apply(t,e,!1),r.innerHTML=a,TextProcessor.updateAnchorsList(),$("#text-container").fadeIn(300),$(".loading-spinner-container").fadeOut(300),scrollToPageTop()})).fail((function(e,t,n){alert("There was an unexpected error when trying to underline words for this ebook!")}));let u=i.next(),p=i.prev();if(u){const e=n.navigation.get(u.href);let t="";t=e?e.label:"Next chapter",l.textContent=t+" »",l.href=u.href,isMobileDevice()||(l.setAttribute("data-bs-title","Go to next chapter & mark underlined words as reviewed"),new bootstrap.Tooltip(l,{trigger:"hover"}))}else l.textContent="";if(p){const e=n.navigation.get(p.href);let t="";t=e?e.label:"Previous chapter",d.textContent="« "+t,d.href=p.href,isMobileDevice()||(d.setAttribute("data-bs-title","Go to previous chapter"),new bootstrap.Tooltip(d,{trigger:"hover"}))}else d.textContent="";o=t,function(e){let t,n=document.getElementById("toc"),o=n.querySelector(".fw-bold"),r=document.getElementById("book-title-chapter");o&&o.classList.remove("fw-bold","text-primary");t=1===e?n.querySelector("a"):n.querySelector(`a[href="${e}"]`);t&&(t.classList.add("fw-bold","text-primary"),r.textContent=" - "+t.textContent)}(t)})),i}d.addEventListener("click",(function(e){e.preventDefault(),$(d).tooltip("hide"),c(d.getAttribute("href"))}),!1),$("body").on("click","#btn-close-ebook",(function(){$.when(s()).then((function(){let e=0;const n=document.getElementById("audioplayer"),r=document.getElementById("videoplayer");n?e=n.currentTime:r&&(e=VideoController.getCurrentTime()),o&&$.when(function(e,n){return $.ajax({type:"POST",url:"/ajax/ebookposition.php",data:{mode:"SAVE",id:t,audio_pos:n,text_pos:e}}).done((function(e){null!=e.error_msg&&alert("Oops! There was an error unexpected error saving text and audio position")})).fail((function(e,t,n){alert("Oops! There was an error unexpected error saving text and audio position")}))}(o,e)).then((function(){window.parent.show_confirmation_dialog=!1,window.location.replace("/texts")}))}))})),parent.window.addEventListener("unload",(function(){n.destroy()})),n.loaded.navigation.then((function(e){let t=document.getElementById("toc"),n=document.createDocumentFragment();const o=function(e,t){let n=document.createElement("ul");t.forEach((function(e){let t=document.createElement("li"),r=document.createElement("a");r.textContent=e.label,r.href=e.href,t.appendChild(r),e.subitems&&o(t,e.subitems),r.onclick=function(){const e=r.getAttribute("href");return document.getElementById("opener").click(),c(e),!1},n.appendChild(t)})),e.appendChild(n)};o(n,e),t.appendChild(n),t.offsetHeight+60<window.innerHeight&&t.classList.add("fixed")})),n.loaded.metadata.then((function(e){let t=document.getElementById("title"),o=document.getElementById("book-title"),r=document.getElementById("author"),i=document.getElementById("cover");null!=t&&(t.textContent=e.title,o.textContent=e.title,r.textContent=e.creator,n.archive?n.archive.createUrl(n.cover).then((function(e){i.src=e})):i.src=n.cover)}))}));