$(document).ready((function(){const e=$("html").attr("lang"),t=$("#text").attr("data-idText"),n=ePub();let o="";window.parent.show_confirmation_dialog=!0;let r=document.getElementById("text");(new FormData).append("id",t);let i=function(e,t,n){return fetch("/ajax/getebook.php?id="+e).then(t).then((e=>e.arrayBuffer())).then((e=>n.open(e))).catch((e=>{alert(`Oops! ${e.message}`),window.location.replace("/texts")})),n.renderTo("text",{flow:"scrolled-doc"})}(t,(function(e){if(200!==e.status)throw new Error(e.statusText);return e}),n),a=document.getElementById("readerpage");i.themes.register("darkmode","/css/ebooks.min.css"),i.themes.register("lightmode","/css/ebooks.min.css"),i.themes.register("sepiamode","/css/ebooks.min.css"),i.themes.default({body:{"font-family":a.style.fontFamily+" !important","font-size":a.style.fontSize+" !important","text-align":a.style.textAlign+" !important","line-height":a.style.lineHeight+" !important",padding:"0 5% !important"}}),i.themes.select(a.className),n.opened.then((function(){!async function(){try{const e=new URLSearchParams({mode:"GET",id:t}),n=await fetch("/ajax/ebookposition.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e});if(!n.ok)throw new Error(`HTTP error: ${n.status}`);const o=await n.json();if(!o.success)throw new Error(o.error_msg||"Failed to get text and audio position.");const r=o.payload.text_pos,i=o.payload.audio_pos,a=parseFloat(i),s=document.getElementById("audioplayer"),l=document.getElementById("videoplayer");r?await d(r):await d(1),null!=s?i&&i.includes("|")&&"undefined"!=typeof AudioController?AudioController.setPlaylistPositionFromString(i):isNaN(a)?s.currentTime=0:s.currentTime=a:null!=l&&initializeVideoPlayer(a)}catch(e){await d(1);const t=document.getElementById("audioplayer");null!=t&&(t.currentTime=0)}}()})),n.loaded.spine.then((e=>{e.each((e=>{e.load(n.load.bind(n))}))}));let s=document.getElementById("next");async function l(){let e=[],t="";window.parent.show_confirmation_dialog=!1,$("#text").find(".reviewing").each((function(){t=$(this).text().toLowerCase(),-1==jQuery.inArray(t,e)&&e.push(t)}));try{const t=new URLSearchParams({words:JSON.stringify(e)}),n=await fetch("/ajax/updatewords.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t});if(!n.ok)throw new Error(`HTTP error: ${n.status}`);const o=await n.json();if(!o.success)throw new Error(o.error_msg||"Failed to save text.");const r={words:{new:getUniqueElements(".reviewing.new"),learning:getUniqueElements(".reviewing.learning"),forgotten:getUniqueElements(".reviewing.forgotten")},texts:{reviewed:1}},i=await fetch("/ajax/updateuserscore.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({review_data:JSON.stringify(r)})});if(!i.ok)throw new Error(`HTTP error: ${i.status}`);const a=await i.json();if(!a.success)throw new Error(a.error_msg||"Failed to update user score.")}catch(e){alert(`Oops! ${e.message}`)}}async function d(t){let i=n.spine.get(t),a="";return s.textContent="",s.classList.add("d-none"),s.href="#",i&&await i.render().then((async function(l){let d=function(e){e=e.replace(/[\r\n]+/g," ");let t=$("<div/>").append(e);t.contents().filter((function(){return 8===this.nodeType})).remove(),t.find('link[rel="stylesheet"]').remove(),t.find("head, meta, style, title, br").remove(),t.find("*").each((function(){if("img"!==this.tagName.toLowerCase())$(this).removeAttr("class").removeAttr("style").removeAttr("id");else for(let e=this.attributes.length-1;e>=0;e--){let t=this.attributes[e].name;"src"!==t&&"alt"!==t&&$(this).removeAttr(t)}}));const n=["div","blockquote","p","h1","h2","h3","h4","h5","h6"];function o(e){if(e.nodeType===Node.TEXT_NODE)return e.nodeValue;if(e.nodeType===Node.ELEMENT_NODE){let t=e.tagName.toLowerCase();if("img"===t)return e.outerHTML;{let r="";return $(e).contents().each((function(){r+=o(this)})),-1!==n.indexOf(t)?"\n"+r+"\n":r}}return""}let r=o(t[0]);return r=r.replace(/\n\s*\n/g,"\n\n").trim(),$("<div/>").append(r)}(l);$(".loading-spinner-container").addClass("show"),$("#text-container").removeClass("show");try{const t=new URLSearchParams({txt:d.html()}),n=await fetch("/ajax/getuserwords.php",{method:"POST",body:t});if(!n.ok)throw new Error(`HTTP error: ${n.status}`);const o=await n.json();if(!o.success)throw new Error(o.error_msg||"Failed to get user words for underlining");a=TextUnderliner.apply(o.payload,e),r.innerHTML=a,TextProcessor.updateAnchorsList(),$("#text-container").addClass("show"),$(".loading-spinner-container").removeClass("show"),scrollToPageTop()}catch(e){alert(`Oops! ${e.message}`)}let c=i.next();if(c){const e=n.navigation.get(c.href);let t="";t=e?e.label:"Next chapter",s.textContent=t+" Â»",s.href=c.href,isMobileDevice()?alert("is mobile"):(s.setAttribute("data-bs-title","Go to next chapter & mark underlined words as reviewed"),new bootstrap.Tooltip(s,{trigger:"hover"})),s.classList.remove("d-none")}o=t,function(e){let t,n=document.getElementById("toc"),o=n.querySelector(".bg-primary"),r=document.getElementById("book-title-chapter");o&&o.classList.remove("bg-primary","text-light");t=1===e?n.querySelector("a"):n.querySelector(`a[href="${e}"]`);t&&(t.classList.add("bg-primary","text-light"),r.textContent=" - "+t.textContent)}(t)})),i}s.addEventListener("click",(async function(e){e.preventDefault(),$(s).tooltip("hide"),await l(),d(s.getAttribute("href"))}),!1),$("body").on("click","#btn-close-ebook",(async function(){await l();let e=0;const n=document.getElementById("audioplayer"),r=document.getElementById("videoplayer");n?e="undefined"!=typeof AudioController&&AudioController.isPlaylist()?AudioController.getPlaylistPositionString():n.currentTime:r&&(e=VideoController.getCurrentTime()),o&&(await async function(e,n){try{const o=new URLSearchParams({mode:"SAVE",id:t,audio_pos:n,text_pos:e}),r=await fetch("/ajax/ebookposition.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:o});if(!r.ok)throw new Error(`HTTP error: ${r.status}`);const i=await r.json();if(!i.success)throw new Error(i.error_msg||"Failed to save text and audio position.")}catch(e){alert(`Oops! ${e.message}`)}}(o,e),window.parent.show_confirmation_dialog=!1,window.location.replace("/texts"))})),parent.window.addEventListener("unload",(function(){n.destroy()})),n.loaded.navigation.then((function(e){const t=document.getElementById("toc"),n=document.createDocumentFragment();t.classList.add("list-group");const o=(e,t=0)=>{e.forEach((e=>{const r=Array.isArray(e.subitems)&&e.subitems.length>0;n.appendChild(((e,t,n=0)=>{const o=document.createElement("a");return o.href=t,o.className="list-group-item list-group-item-action toc-item",o.style.setProperty("--depth",n),o.dataset.depth=String(n),o.setAttribute("aria-level",String(n+1)),o.textContent=e,o.onclick=function(){const e=o.getAttribute("href");return document.getElementById("opener").click(),d(e),!1},o})(e.label,e.href,t)),r&&o(e.subitems,t+1)}))};o(e,0),t.appendChild(n),t.offsetHeight+60<window.innerHeight&&t.classList.add("fixed")})),n.loaded.metadata.then((function(e){let t=document.getElementById("title"),o=document.getElementById("book-title"),r=document.getElementById("author"),i=document.getElementById("publisher"),a=document.getElementById("pubdate"),s=document.getElementById("cover");t.textContent=e.title&&""!==e.title.trim()?e.title:"Untitled",o.textContent=e.title&&""!==e.title.trim()?e.title:"Untitled",r.textContent=e.creator&&""!==e.creator.trim()?e.creator:"Unknown",i.textContent=e.publisher&&""!==e.publisher.trim()?e.publisher:"Unknown",a.textContent=e.pubdate&&""!==e.pubdate.trim()?new Intl.DateTimeFormat("en-US",{year:"numeric",month:"long",day:"numeric"}).format(new Date(e.pubdate)):"Not available",n.archive?n.archive.createUrl(n.cover).then((function(e){s.src=e})):s.src=n.cover}))}));