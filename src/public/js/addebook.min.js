$(document).ready((function(){function e(e){$("#upload-progress-bar").parent().addClass("d-none"),$("#btn-upload-epub").removeClass("disabled"),$("#btn-save").removeClass("disabled"),e&&($("#title").val(""),$("#author").val(""),$("#url").val(""))}function o(e){const o=ePub(),t=e.target.result;o.open(t),o.loaded.metadata.then((function(e){const o=document.getElementById("title"),t=document.getElementById("author");null!=o&&(o.value=e.title,t.value=e.creator)})),window.addEventListener("unload",(function(){o.destroy()}))}e(!0),$("#btn-upload-epub").on("click",(function(){$("#url").trigger("click")})),$("#url").on("change",(function(){$("#alert-box").addClass("d-none");const t=$(this);if("epub"!=t[0].files[0].name.split(".").pop().toLowerCase())showMessage("Invalid file extension. Only .epub files are allowed.","alert-danger"),e(!0);else if(window.FileReader){const e=new FileReader;e.onload=o,e.readAsArrayBuffer(t[0].files[0])}})),$("#form-addebook").on("submit",(async function(o){o.preventDefault();const t=$("#upload-progress-bar"),a=new FormData(document.getElementById("form-addebook")),n=$("#audio-uri").val();try{if($("#alert-box").addClass("d-none"),""!=n&&!function(e){let o;try{o=new URL(e)}catch(e){return!1}return"http:"===o.protocol||"https:"===o.protocol}(n))throw new Error("Invalid audio URL.");t.parent().removeClass("d-none"),$("#btn-upload-epub").addClass("disabled"),$("#btn-save").addClass("disabled"),t.width("33%"),t.text("Uploading & converting ebook...");const e=await fetch("ajax/addtext.php",{method:"POST",body:a});if(!e.ok)throw new Error(`HTTP error: ${e.status}`);const o=await e.json();if(!o.success)throw new Error(o.error_msg||"Failed to add ebook");t.width("100%"),t.text("Upload complete..."),setTimeout((()=>{window.location.replace("/texts")}),1500)}catch(o){showMessage(o.message,"alert-danger"),e(!1)}})),$("#audio-uri").on("input",(function(){const e=$(this).val(),o=$("#audio-url-helptext");e.includes("drive.google.com")?o.html('<i class="bi bi-cloud-fill"></i> Remember to <a href="https://support.google.com/drive/answer/2494822?hl=en&co=GENIE.Platform%3DDesktop#zippy=%2Cshare-a-file-publicly" target="_blank" rel="noopener noreferrer" class="alert-link">share this file publicly</a>, allowing access to anyone with the link.'):o.text("Accepts URLs from YouTube, Google Drive, M3U playlists, RSS feeds, or any standard audio source.")}))}));