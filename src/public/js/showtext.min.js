$(document).ready((function(){let e=2;const t=$("html").attr("lang"),n=$(parent.document);let a;function o(){const e=$("#audioplayer");if(0===e.length)return!1;const t=e.data("playlistSrc");return!(!t||""===String(t).trim())||""!=$("#audioplayer").find("source").attr("src")}function s(){let e=[],t=[],n="",a=!0;const o=$("#is_shared").length>0;let s=0;$("#text").find(".reviewing").each((function(){n=$(this).text().toLowerCase(),-1==$.inArray(n,e)&&e.push(n)})),t.push($("#text-container").attr("data-IdText")),o&&(t=void 0,a=void 0),$.ajax({type:"POST",url:"/ajax/updatewords.php",data:{words:e,textIDs:JSON.stringify(t),archivetext:a}}).done((function(e){if(null==e.error_msg){const e={words:{new:getUniqueElements(".reviewing.new"),learning:getUniqueElements(".reviewing.learning"),forgotten:getUniqueElements(".reviewing.forgotten")},texts:{reviewed:1}};$.ajax({type:"post",url:"ajax/updateuserscore.php",data:e}).done((function(e){if(null==e.error_msg){s=e.gems_earned,window.parent.show_confirmation_dialog=!1;const t="/textstats",n=Number($(".word").length)+Number($(".phrase").length),a=$('<form action="'+t+'" method="post"><input type="hidden" name="created" value="'+$(".reviewing.new").length+'" /><input type="hidden" name="learning" value="'+$(".reviewing.learning").length+'" /><input type="hidden" name="learned" value="'+$(".learned").length+'" /><input type="hidden" name="forgotten" value="'+$(".reviewing.forgotten").length+'" /><input type="hidden" name="total" value="'+n+'" /><input type="hidden" name="gems_earned" value="'+s+'" /><input type="hidden" name="is_shared" value="'+$("#is_shared").length+'" /></form>');$("body").append(a),a.submit()}else alert("Oops! There was an unexpected error updating user score.")})).fail((function(e,t,n){alert("Oops! There was an unexpected error updating user score.")}))}else alert("Oops! There was an error unexpected error saving this text.")})).fail((function(e,t,n){alert("Oops! There was an error unexpected error saving this text.")}))}function r(){const t=document.getElementById("btn-next-phase");o()||(0==$(".learning, .new, .forgotten").length?(setNewTooltip(t,"Finish & Save - Will skip some phases: no audio detected & no underlined words"),e=6):(setNewTooltip(t,"Go to phase 5: Review - Will skip some phases: no audio detected"),e=5))}function i(){let n=$("#audioplayer"),a=$("#audio-source").attr("src");const o=n.data("playlistSrc");if(!(n.length>0&&""===a)||$("#readerpage > :first").is("#navigation")||o&&""!==String(o).trim())return!1;{const a=$("#text").text();$.ajax({type:"POST",url:"/ajax/fetchaudiostream.php",data:{text:a,langiso:t},dataType:"json"}).done((function(t){return null==t.error&&t.response?($("#audio-source").attr("src",t.response),n[0].load(),$("#audioplayer-loader").addClass("d-none"),$("#audioplayer-container").removeClass("d-none"),setNewTooltip(document.getElementById("btn-next-phase"),"Go to phase 2: Listening"),e=2,!0):($("#audioplayer-loader").addClass("d-none"),$("#alert-box-audio").removeClass("d-none").empty().append('There was an unexpected error trying to create audio from this text. <a class="alert-link" href="#" id="retry-audio-load">Try again</a> later.'),r(),!1)})).fail((function(e){return 403==e.status?($("#audioplayer-loader").addClass("d-none"),$("#alert-box-audio").removeClass("d-none").empty().append("You have reached your audio streaming limit. Try again tomorrow.")):($("#audioplayer-loader").addClass("d-none"),$("#alert-box-audio").removeClass("d-none").empty().append('There was an unexpected error trying to create audio from this text. <a class="alert-link" href="#" id="retry-audio-load">Try again</a> later.')),r(),!1}))}}window.parent.show_confirmation_dialog=!0,i(),"text"==$("#text-container").data("type")&&$.ajax({type:"POST",url:"/ajax/getuserwords.php",data:{txt:$("#text").text()},dataType:"json"}).done((function(e){$("#text").html(TextUnderliner.apply(e,t,!1)),TextProcessor.updateAnchorsList()})).fail((function(e,t,n){})).always((function(){r()})),Dictionaries.fetchURIs(),"undefined"!=typeof AudioController?a=AudioController:"undefined"!=typeof VideoController&&(a=VideoController),a&&WordSelection.setupEvents({actionBtns:TextActionBtns,controller:a,linkBuilder:LinkBuilder.forTranslationInText}),n.on("click","#btn-add, #btn-forgot",(function(t){const n=WordSelection.get(),s=n.length>1?1:0,i=n.text(),l=o(),d=new URLSearchParams(window.location.search).get("sh");$.ajax({type:"POST",url:"/ajax/addword.php",data:{word:i,is_phrase:s,source_id:$("[data-idtext]").attr("data-idtext"),text_is_shared:d,sentence:SentenceExtractor.extractSentence(n)}}).done((function(){const t=0==$(".learning, .new, .forgotten").length,a=$("#audioplayer")[0]?.readyState>0&&5==e?"style='display: none;'":"";if(s){const e=n.filter(".word").length;TextProcessor.getTextContainer().find("a.word").filter((function(){return $(this).text().toLowerCase()===n.eq(0).text().toLowerCase()})).each((function(){let t=$(this).nextAll("a.word").slice(0,e-1).last(),n=$(this).nextUntil(t).addBack().next("a.word").addBack();n.text().toLowerCase()===i.toLowerCase()&&(n.wrapAll("<a class='word reviewing new' "+a+"></a>"),n.contents().unwrap())}))}else{let e=TextProcessor.getTextContainer().find("a.word").filter((function(){return $(this).text().toLowerCase()===i.toLowerCase()}));e.each((function(){let e=$(this);e.is(".new, .learning, .learned, .forgotten")?e.wrap("<a class='word reviewing forgotten' "+a+"></a>"):e.wrap("<a class='word reviewing new' "+a+"></a>")})),e.contents().unwrap()}if(6==e&&t)if(l){let t=document.getElementById("btn-next-phase");setNewTooltip(t,"Go to phase 4: Dictation"),e=4}else r();TextProcessor.updateAnchorsList()})).fail((function(e,t,n){alert("Oops! There was an error adding this word or phrase to the database.")})),TextActionBtns.hide(),a.resume()})),n.on("click","#btn-remove",(function(){const n=WordSelection.get();$.ajax({type:"POST",url:"/ajax/removeword.php",data:{word:n.text()}}).done((function(){let a=TextProcessor.getTextContainer().find("a.word").filter((function(){return $(this).text().toLowerCase()===n.text().toLowerCase()}));$.ajax({type:"POST",url:"/ajax/getuserwords.php",data:{txt:n.text()},dataType:"json"}).done((function(n){const o=$("#audioplayer")[0]?.readyState>0>0&&5==e;let s=$(TextUnderliner.apply(n,t,o)),r={},i=/""/;a.each((function(){r=$(this),s.filter(".word").each((function(e){i=TextProcessor.langHasNoWordSeparators(t)?new RegExp("(?<![^])"+$(this).text()+"(?![$])","iug").exec(r.text()):new RegExp("(?<![\\p{L}|^])"+$(this).text()+"(?![\\p{L}|$])","iug").exec(r.text()),$(this).text(i);const a=$(this).text().toLowerCase(),o=n.user_words.find((function(e){return e.word==a}));void 0!==o&&(2==o.status?$(this).removeClass("learning").addClass("new"):3==o.status&&$(this).removeClass("learning").addClass("forgotten"))})),r.replaceWith(s.clone())})),TextProcessor.updateAnchorsList()}))})).fail((function(e,t,n){alert("Oops! There was an error removing the word from the database.")})),TextActionBtns.hide(),a.resume()})),$("body").on("click","#btn-next-phase",(function(){const t=o(),n=document.getElementById("btn-next-phase");let i=$("#alert-box-phase");switch(e<6&&!t&&r(),e){case 2:scrollToPageTop(),e++,i.html('\n                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>\n                    <h5 class="alert-heading">üéß Phase 2: Listening</h5>\n                    <p class="small mb-2">Shift your focus from meaning to <strong>auditory patterns</strong> \n                    and phonetic details.</p>\n                    <ul class="small ps-3">\n                        <li><strong>Analyze:</strong> Focus on how individual words blend together in natural speech.</li>\n                        <li><strong>Slow Down:</strong> If the pace feels too fast, reduce the playback speed to\n                        hear distinct sounds.</li>\n                        <li><strong>Identify:</strong> Try to spot the difference between the written spelling and\n                        the actual <a href="https://en.wikipedia.org/wiki/Phonology" class="alert-link">phonetic</a>\n                        output.</li>\n                    </ul>\n                '),setNewTooltip(document.getElementById("btn-next-phase"),"Go to phase 3: Speaking"),a.playFromBeginning();break;case 3:scrollToPageTop(),e++,setNewTooltip(n,"Go to phase 4: Dictation"),i.html('\n                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>\n                    <h5 class="alert-heading">üéôÔ∏è Phase 3: Speaking</h5>\n                    <p class="small mb-2">Focus on <strong>vocalizing</strong> the language to build muscle memory\n                    and fluency.</p>\n                    <ul class="small ps-3">\n                        <li><strong>Listen:</strong> Pay close attention to the native rhythm, intonation, and stress\n                        patterns.</li>\n                        <li><strong>Shadow:</strong> Read the text aloud while trying to <strong>emulate</strong> the\n                        exact pronunciation.</li>\n                        <li><strong>Adjust:</strong> Use the speed controls to slow down the audio if you need to\n                        catch complex sounds.</li>\n                    </ul>\n                '),a.playFromBeginning();break;case 4:scrollToPageTop(),0==$(".learning, .new, .forgotten").length?(setNewTooltip(n,"Finish & Save - Will skip phase 5 (Review): no underlined words"),e=6):(e++,setNewTooltip(n,"Go to phase 5: Review")),i.html('\n                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>\n                    <h5 class="alert-heading">‚úçÔ∏è Phase 4: Dictation</h5>\n                    <p class="small">Listen to the audio and fill in the blanks as accurately as possible.</p>\n                    <p class="small mb-2">Auto-pause while typing is on by default. You can turn it off in the audio controls.</p>\n                    <div class="small bg-light p-2 rounded border">\n                        <strong>Controls:</strong> \n                        <kbd>1</kbd> Back 3s | \n                        <kbd>2</kbd> Play/Pause | \n                        <kbd>3</kbd> Forward 3s\n                    </div>\n                '),a.setSpeed(.75),toggleDictation();break;case 5:scrollToPageTop(),e++,setNewTooltip(n,"Finish & Save"),i.html('\n                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>\n                    <h5 class="alert-heading">üöÄ Phase 5: Review</h5>\n                    <p class="small mb-2">This is the most <strong>critical step</strong> for long-term memory.</p>\n                    <ul class="small ps-3">\n                        <li><strong>Review:</strong> Review all underlined words. Try to recall their meanings and\n                        pronunciations.</li>\n                        <li><strong>Correct:</strong> Pay attention to misspellings shown in \n                        <span class="text-danger">[red brackets]</span> (if any).</li>\n                        <li><strong>Practice:</strong> Try to create original sentences using words underlined in green\n                        to turn <a href="https://en.wiktionary.org/wiki/passive_vocabulary"\n                        class="alert-link">passive</a> knowledge into <a href="https://en.wiktionary.org/wiki/active_vocabulary" class="alert-link">active</a> skill.</li>\n                    </ul>\n                '),toggleDictation();break;case 6:s();break;default:break}})),$("body").on("click","#btn-save-text",s),$("#btn-toggle-audio-player-controls").on("click",(function(){const e=$("#audioplayer-container"),t=$(this);"static"===e.css("position")?(e.css("position","sticky"),t.addClass("active"),setNewTooltip(t[0],"Hide audio controls while scrolling")):(e.css("position","static"),t.removeClass("active"),setNewTooltip(t[0],"Keep audio controls visible while scrolling"))})),n.on("click","#retry-audio-load",(function(e){e.preventDefault(),$("#alert-box-audio").addClass("d-none"),$("#audioplayer-loader").removeClass("d-none"),i()}))}));