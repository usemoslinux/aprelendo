$(document).ready((function(){let e=2;const t=$("html").attr("lang"),n=$(parent.document);let o;function a(){const e=$("#audioplayer");if(0===e.length)return!1;const t=e.data("playlistSrc");return!(!t||""===String(t).trim())||""!=$("#audioplayer").find("source").attr("src")}async function s(){let e=[],t=[],n="",o=!0;const a=$("#is_shared").length>0;let s=0;$("#text").find(".reviewing").each((function(){n=$(this).text().toLowerCase(),-1==$.inArray(n,e)&&e.push(n)})),t.push($("#text-container").attr("data-IdText")),a&&(t=void 0,o=void 0);try{const n=await fetch("/ajax/updatewords.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({words:JSON.stringify(e),textIDs:JSON.stringify(t),archivetext:o})});if(!n.ok)throw new Error(`HTTP error: ${n.status}`);const a=await n.json();if(!a.success)throw new Error(a.error_msg||"Failed to update words status.");const r={words:{new:getUniqueElements(".reviewing.new"),learning:getUniqueElements(".reviewing.learning"),forgotten:getUniqueElements(".reviewing.forgotten")},texts:{reviewed:1}},i=await fetch("ajax/updateuserscore.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({review_data:JSON.stringify(r)})});if(!i.ok)throw new Error(`HTTP error: ${i.status}`);const l=await i.json();if(!l.success)throw new Error(l.error_msg||"Failed to update user score.");s=l.gems_earned,window.parent.show_confirmation_dialog=!1;const d="/textstats",c=Number($(".word").length)+Number($(".phrase").length),h=$('<form action="'+d+'" method="post"><input type="hidden" name="created" value="'+$(".reviewing.new").length+'" /><input type="hidden" name="learning" value="'+$(".reviewing.learning").length+'" /><input type="hidden" name="learned" value="'+$(".learned").length+'" /><input type="hidden" name="forgotten" value="'+$(".reviewing.forgotten").length+'" /><input type="hidden" name="total" value="'+c+'" /><input type="hidden" name="gems_earned" value="'+s+'" /><input type="hidden" name="is_shared" value="'+$("#is_shared").length+'" /></form>');$("body").append(h),h.trigger("submit")}catch(e){alert(`Oops! ${e.message}`)}}function r(){const t=document.getElementById("btn-next-phase");a()||(0==$(".learning, .new, .forgotten").length?(setNewTooltip(t,"Finish & Save - Will skip some phases: no audio detected & no underlined words"),e=6):(setNewTooltip(t,"Go to phase 5: Review - Will skip some phases: no audio detected"),e=5))}async function i(){let n=$("#audioplayer"),o=$("#audio-source").attr("src");const a=n.data("playlistSrc");if(n.length>0&&""===o&&!$("#readerpage > :first").is("#navigation")&&(!a||""===String(a).trim())){const o=$("#text").text();try{const a=await fetch("/ajax/fetchaudiostream.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({text:o,langiso:t})});if(!a.ok){if(403==a.status)throw new Error("Audio streaming limit reached. Try again tomorrow.");throw new Error(`HTTP error: ${a.status}`)}const s=await a.json();if(null!=s.payload.error||!s.payload.response)throw new Error(s.payload.error||"No audio response received");$("#audio-source").attr("src",s.payload.response),n[0].load(),$("#audioplayer-loader").addClass("d-none"),$("#audioplayer-container").removeClass("d-none"),setNewTooltip(document.getElementById("btn-next-phase"),"Go to phase 2: Listening"),e=2}catch(e){$("#audioplayer-loader").addClass("d-none"),$("#alert-box-audio").removeClass("d-none").empty().append(e.message||'Failed to load audio. <a href="#"\n                        class="alert-link" id="retry-audio-load">Try again?</a>'),r()}}}window.parent.show_confirmation_dialog=!0,i(),async function(){if("text"==$("#text-container").data("type"))try{const e=new URLSearchParams({txt:$("#text").text()}),n=await fetch("/ajax/getuserwords.php",{method:"POST",body:e});if(!n.ok)throw new Error(`HTTP error: ${n.status}`);const o=await n.json();if(!o.success)throw new Error(o.error_msg||"Failed to get user words for underlining");$("#text").html(TextUnderliner.apply(o.payload,t)),TextProcessor.updateAnchorsList()}catch(e){alert(`Oops! ${e.message}`)}finally{r()}}(),Dictionaries.fetchURIs(),"undefined"!=typeof AudioController?o=AudioController:"undefined"!=typeof VideoController&&(o=VideoController),o&&WordSelection.setupEvents({actionBtns:TextActionBtns,controller:o,linkBuilder:LinkBuilder.forTranslationInText}),n.on("click","#btn-add, #btn-forgot",(async function(t){const n=$(this);ActionBtns.setActionMenuLoading(n);const s=WordSelection.get(),i=s.length>1?1:0,l=s.text(),d=a(),c=new URLSearchParams(window.location.search).get("sh");try{const t=new URLSearchParams({word:l,is_phrase:i,source_id:$("[data-idtext]").attr("data-idtext"),text_is_shared:c,sentence:SentenceExtractor.extractSentence(s,!0)}),a=await fetch("/ajax/addword.php",{method:"POST",body:t});if(!a.ok)throw new Error(`HTTP error: ${a.status}`);if(data=await a.json(),!data.success)throw new Error(data.error_msg||"Failed to add word.");const h=0==$(".learning, .new, .forgotten").length,u=$("#audioplayer")[0]?.readyState>0&&5==e?"style='display: none;'":"";if(i){const e=s.filter(".word").length;TextProcessor.getTextContainer().find("a.word").filter((function(){return $(this).text().toLowerCase()===s.eq(0).text().toLowerCase()})).each((function(){let t=$(this).nextAll("a.word").slice(0,e-1).last(),n=$(this).nextUntil(t).addBack().next("a.word").addBack();n.text().toLowerCase()===l.toLowerCase()&&(n.wrapAll(`<a class="word reviewing new" ${u}></a>`),n.contents().unwrap())}))}else{let e=TextProcessor.getTextContainer().find("a.word").filter((function(){return $(this).text().toLowerCase()===l.toLowerCase()}));e.each((function(){let e=$(this);e.is(".new, .learning, .learned, .forgotten")?e.wrap(`<a class='word reviewing forgotten' ${u}></a>`):e.wrap(`<a class='word reviewing new' ${u}></a>`)})),e.contents().unwrap()}if(6==e&&h)if(d){let t=document.getElementById("btn-next-phase");setNewTooltip(t,"Go to phase 4: Dictation"),e=4}else r();TextProcessor.updateAnchorsList()}catch(e){alert(`Oops! ${e.message}`)}finally{ActionBtns.clearActionMenuLoading(n),TextActionBtns.hide(),o.resume()}})),n.on("click","#btn-remove",(async function(){const e=$(this);ActionBtns.setActionMenuLoading(e);const n=WordSelection.get();try{const a=await fetch("/ajax/removeword.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({word:n.text().toLowerCase()})});if(!a.ok)throw new Error(`HTTP error: ${a.status}`);const s=await a.json();if(!s.success)throw new Error(s.error_msg||"Failed to remove word.");let r=TextProcessor.getTextContainer().find("a.word").filter((function(){return $(this).text().toLowerCase()===n.text().toLowerCase()}));const i=await fetch("/ajax/getuserwords.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({txt:n.text()})});if(!i.ok)throw new Error(`HTTP error: ${i.status}`);const l=await i.json();if(!l.success)throw new Error(l.error_msg||"Failed to get user words for re-underlining.");let d=$(TextUnderliner.apply(l.payload,t)),c={},h=/""/;r.each((function(){c=$(this),d.filter(".word").each((function(e){h=TextProcessor.langHasNoWordSeparators(t)?new RegExp("(?<![^])"+$(this).text()+"(?![$])","iug").exec(c.text()):new RegExp("(?<![\\p{L}|^])"+$(this).text()+"(?![\\p{L}|$])","iug").exec(c.text()),$(this).text(h);const n=$(this).text().toLowerCase(),o=l.payload.user_words.find((function(e){return e.word==n}));void 0!==o&&(2==o.status?$(this).removeClass("learning").addClass("new"):3==o.status&&$(this).removeClass("learning").addClass("forgotten"))})),c.replaceWith(d.clone())})),TextProcessor.updateAnchorsList()}catch(e){alert(`Oops! ${e.message}`)}finally{ActionBtns.clearActionMenuLoading(e),TextActionBtns.hide(),o.resume()}})),$("body").on("click","#btn-next-phase",(function(){const t=a(),n=document.getElementById("btn-next-phase");let i=$("#alert-box-phase");switch(e<6&&!t&&r(),e){case 2:scrollToPageTop(),e++,i.html('\n                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>\n                    <h5 class="alert-heading">üéß Phase 2: Listening</h5>\n                    <p class="small mb-2">Shift your focus from meaning to <strong>auditory patterns</strong> \n                    and phonetic details.</p>\n                    <ul class="small ps-3">\n                        <li><strong>Analyze:</strong> Focus on how individual words blend together in natural speech.</li>\n                        <li><strong>Slow Down:</strong> If the pace feels too fast, reduce the playback speed to\n                        hear distinct sounds.</li>\n                        <li><strong>Identify:</strong> Try to spot the difference between the written spelling and\n                        the actual <a href="https://en.wikipedia.org/wiki/Phonology" class="alert-link">phonetic</a>\n                        output.</li>\n                    </ul>\n                '),setNewTooltip(document.getElementById("btn-next-phase"),"Go to phase 3: Speaking"),o.playFromBeginning();break;case 3:scrollToPageTop(),e++,setNewTooltip(n,"Go to phase 4: Dictation"),i.html('\n                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>\n                    <h5 class="alert-heading">üéôÔ∏è Phase 3: Speaking</h5>\n                    <p class="small mb-2">Focus on <strong>vocalizing</strong> the language to build muscle memory\n                    and fluency.</p>\n                    <ul class="small ps-3">\n                        <li><strong>Listen:</strong> Pay close attention to the native rhythm, intonation, and stress\n                        patterns.</li>\n                        <li><strong>Shadow:</strong> Read the text aloud while trying to <strong>emulate</strong> the\n                        exact pronunciation.</li>\n                        <li><strong>Adjust:</strong> Use the speed controls to slow down the audio if you need to\n                        catch complex sounds.</li>\n                    </ul>\n                '),o.playFromBeginning();break;case 4:scrollToPageTop(),0==$(".learning, .new, .forgotten").length?(setNewTooltip(n,"Finish & Save - Will skip phase 5 (Review): no underlined words"),e=6):(e++,setNewTooltip(n,"Go to phase 5: Review")),i.html('\n                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>\n                    <h5 class="alert-heading">‚úçÔ∏è Phase 4: Dictation</h5>\n                    <p class="small">Listen to the audio and fill in the blanks as accurately as possible.</p>\n                    <p class="small mb-2">Auto-pause while typing is on by default. You can turn it off in the audio controls.</p>\n                    <div class="small bg-light p-2 rounded border">\n                        <strong>Controls:</strong> \n                        <kbd>1</kbd> Back 3s | \n                        <kbd>2</kbd> Play/Pause | \n                        <kbd>3</kbd> Forward 3s\n                    </div>\n                '),o.setSpeed(.75),toggleDictation();break;case 5:scrollToPageTop(),e++,setNewTooltip(n,"Finish & Save"),i.html('\n                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>\n                    <h5 class="alert-heading">üöÄ Phase 5: Review</h5>\n                    <p class="small mb-2">This is the most <strong>critical step</strong> for long-term memory.</p>\n                    <ul class="small ps-3">\n                        <li><strong>Review:</strong> Review all underlined words. Try to recall their meanings and\n                        pronunciations.</li>\n                        <li><strong>Correct:</strong> Pay attention to misspellings shown in \n                        <span class="text-danger">[red brackets]</span> (if any).</li>\n                        <li><strong>Practice:</strong> Try to create original sentences using words underlined in green\n                        to turn <a href="https://en.wiktionary.org/wiki/passive_vocabulary"\n                        class="alert-link">passive</a> knowledge into <a href="https://en.wiktionary.org/wiki/active_vocabulary" class="alert-link">active</a> skill.</li>\n                    </ul>\n                '),toggleDictation();break;case 6:s();break;default:break}})),$("body").on("click","#btn-save-text",s),$("#btn-toggle-audio-player-controls").on("click",(function(){const e=$("#audioplayer-container"),t=$(this);"static"===e.css("position")?(e.css("position","sticky"),t.addClass("active"),setNewTooltip(t[0],"Hide audio controls while scrolling")):(e.css("position","static"),t.removeClass("active"),setNewTooltip(t[0],"Keep audio controls visible while scrolling"))})),n.on("click","#retry-audio-load",(function(e){e.preventDefault(),$("#alert-box-audio").addClass("d-none"),$("#audioplayer-loader").removeClass("d-none"),i()})),$(window).on("beforeunload",(function(){if(window.parent.show_confirmation_dialog)return"Press Save before you go or your changes will be lost."}))}));