$(document).ready((function(){let e,t,n,o=!1,r=-1,a=-1,i=null,s="",l="",c="",u=0;const d=$("html").attr("lang"),h=$(parent.document);let g=!0,p=.01*window.innerHeight;function w(r){o=!1,t=r.pageX,n=r.pageY,e=setTimeout((function(){o=!0,VideoController.pause(!0)}),500)}function f(){clearTimeout(e),t=null,n=null}function x(){o&&r>=0&&a>=0&&(i=TextProcessor.getHighlightedTextObj(r,a),v()),f(),o=!1,r=-1,a=-1}function m(e){(function(e){if(null==t||null==n)return!1;const o=e.pageX-t,r=e.pageY-n;return Math.abs(o)>10||Math.abs(r)>10})(e)&&f(),o&&function(e){if(!o||r<0)return;const t=document.elementFromPoint(e.clientX,e.clientY),n=$(t).closest("a");n.length&&(a=TextProcessor.getAnchorIndex(n),TextProcessor.removeAllHighlighted(),TextProcessor.addHighlightToSelection(r,a))}(e)}function v(){$("#text-container").disableScroll(),setWordActionButtons(i,!1);setDicActionButtonsClick(i,{dictionary:s,img_dictionary:l,translator:c},"video"),showActionButtons(i)}function y(){$("#text-container").enableScroll(),hideActionButtons()}document.documentElement.style.setProperty("--vh",`${p}px`),$.ajax({type:"POST",url:"/ajax/getuserwords.php",data:{txt:$("#text-container").html()},dataType:"json"}).done((function(e){$("#text-container").html(TextProcessor.underlineWords(e,d,!1)),TextProcessor.updateAnchorsList()})).fail((function(e,t,n){})),$.ajax({url:"/ajax/getdicuris.php",type:"GET",dataType:"json"}).done((function(e){null==e.error_msg&&(s=e.dictionary_uri,l=e.img_dictionary_uri,c=e.translator_uri)})),h.on("contextmenu",(function(e){return e.preventDefault(),!1})),h.on("click","#text .word",(function(e){o||(i=$(this),TextProcessor.removeAllHighlighted(),i.addClass("highlighted"),y(),VideoController.pause(!0),v())})),h.on("mousedown touchstart","#text .word",(function(e){r=TextProcessor.getAnchorIndex($(this))})),h.on("mousedown","#text",(function(e){e.originalEvent.which<2?w(e):3==e.originalEvent.which&&(VideoController.pause(!1),i=$(e.target),openInNewTab(buildVideoTranslationLink(c,i)))})),h.on("mousemove","#text",(function(e){m(e)})),h.on("mouseup","#text",(function(e){x()})),h.on("touchstart","#text",(function(e){w(e.originalEvent.touches[0])})),h.on("touchmove","#text",(function(e){m(e.originalEvent.touches[0])})),h.on("touchend","#text",(function(e){x()})),h.on("mouseup touchend",(function(e){if($("#action-buttons").is(":visible")){let t=$(e.target).is(".word"),n=$(e.target).closest(".btn").length>0,o=$(e.target).closest(".offcanvas").length>0,r=$(e.target).closest(".modal").length>0;t||n||o||r||(e.stopPropagation(),TextProcessor.removeAllHighlighted(),y(),VideoController.resume())}})),$("#btn-add, #btn-forgot").on("click",(function(e){const t=i.text(),n=i.length>1?1:0;$.ajax({type:"POST",url:"ajax/addword.php",data:{word:t.toLowerCase(),is_phrase:n,source_id:$("[data-idtext]").attr("data-idtext"),text_is_shared:!0,sentence:getVideoSentence(i)}}).done((function(){if(n){const n=i.eq(0).text(),o=i.filter(".word").length;$("a.word").filter((function(){return $(this).text().toLowerCase()===n.toLowerCase()})).each((function(){let e=$(this).nextAll("a.word").slice(0,o-1).last(),n=$(this).nextUntil(e).addBack().next("a.word").addBack();n.text().toLowerCase()===t.toLowerCase()&&(n.wrapAll("<a class='word reviewing new'></a>"),n.contents().unwrap())})),$(e.target).is("#btn-add")&&TextProcessor.updateAnchorsList()}else{let e=$("a.word").filter((function(){return $(this).text().toLowerCase()===t.toLowerCase()}));e.each((function(){let e=$(this);e.is(".new, .learning, .learned, .forgotten")?e.wrap("<a class='word reviewing forgotten'></a>"):e.wrap("<a class='word reviewing new'></a>")})),e.contents().unwrap()}})).fail((function(e,t,n){alert("Oops! There was an error adding this word or phrase to the database.")})),y(),VideoController.resume()})),$("#btn-remove").on("click",(function(){$.ajax({type:"POST",url:"ajax/removeword.php",data:{word:i.text().toLowerCase()}}).done((function(){let e=$("a.word").filter((function(){return $(this).text().toLowerCase()===i.text().toLowerCase()}));$.ajax({type:"POST",url:"/ajax/getuserwords.php",data:{txt:i.text()},dataType:"json"}).done((function(t){let n=$(TextProcessor.underlineWords(t,d,!1)),o={},r=/""/;e.each((function(){o=$(this),n.filter(".word").each((function(e){r=TextProcessor.langHasNoWordSeparators(d)?new RegExp("(?<![^])"+$(this).text()+"(?![$])","iug").exec(o.text()):new RegExp("(?<![\\p{L}|^])"+$(this).text()+"(?![\\p{L}|$])","iug").exec(o.text()),$(this).text(r);const n=$(this).text().toLowerCase(),a=t.user_words.find((function(e){return e.word==n}));void 0!==a&&(2==a.status?$(this).removeClass("learning").addClass("new"):3==a.status&&$(this).removeClass("learning").addClass("forgotten"))})),o.replaceWith(n.clone()),TextProcessor.updateAnchorsList()}))})).fail((function(e,t,n){}))})).fail((function(e,t,n){alert("Oops! There was an error removing the word from the database.")})),y(),VideoController.resume()})),$(document).on("click","#btn-save-ytvideo",(function(){let e=[],t=[],n="";$(".learning").each((function(){n=$(this).text().toLowerCase(),-1==$.inArray(n,e)&&e.push(n)})),t.push($("#text-container").attr("data-IdText")),$.ajax({type:"POST",url:"ajax/archivetext.php",data:{words:e,textIDs:JSON.stringify(t)}}).done((function(e){if(null==e.error_msg){const e={words:{new:getUniqueElements(".reviewing.new"),learning:getUniqueElements(".reviewing.learning"),forgotten:getUniqueElements(".reviewing.forgotten")},texts:{reviewed:1}};$.ajax({type:"post",url:"ajax/updateuserscore.php",data:e}).done((function(e){if(null==e.error_msg){u=e.gems_earned,g=!1;const t="/textstats",n=Number($(".word").length)+Number($(".phrase").length),o=$('<form action="'+t+'" method="post"><input type="hidden" name="created" value="'+$(".reviewing.new").length+'" /><input type="hidden" name="reviewed" value="'+$(".reviewing.learning").length+'" /><input type="hidden" name="learned" value="'+$(".learned").length+'" /><input type="hidden" name="forgotten" value="'+$(".reviewing.forgotten").length+'" /><input type="hidden" name="total" value="'+n+'" /><input type="hidden" name="gems_earned" value="'+u+'" /><input type="hidden" name="is_shared" value="1" /></form>');$("body").append(o),o.submit()}else alert("Oops! There was an unexpected error.")})).fail((function(e,t,n){alert("Oops! There was an unexpected error.")}))}else alert("Oops! There was an unexpected error.")})).fail((function(e,t,n){alert("Oops! There was an error updating the database.")}))})),$("#btn-fullscreen").on("click",(function(e){if(document.fullscreenElement)document.exitFullscreen().catch((e=>{alert(`An error occurred while trying to exit fullscreen mode: ${e.message} (${e.name})`)}));else{document.documentElement.requestFullscreen({navigationUI:"show"}).catch((e=>{alert(`An error occurred while trying to switch into fullscreen mode: ${e.message} (${e.name})`)}))}})),$(window).on("beforeunload",(function(){if(g)return"To save your progress, please click the Save button before you go. Otherwise, your changes will be lost. Are you sure you want to exit this page?"})),$(window).on("resize",(function(){p=.01*window.innerHeight,document.documentElement.style.setProperty("--vh",`${p}px`)}))}));