$(document).ready((function(){let e=0;const t=$("html").attr("lang");let r=!0,o=.01*window.innerHeight;document.documentElement.style.setProperty("--vh",`${o}px`),initializeVideoPlayer(0),async function(){try{const e=new URLSearchParams({txt:$("#text").html()}),r=await fetch("/ajax/getuserwords.php",{method:"POST",body:e});if(!r.ok)throw new Error(`HTTP error: ${r.status}`);const o=await r.json();if(!o.success)throw new Error(o.error_msg||"Failed to get user words for underlining");$("#text").html(TextUnderliner.apply(o.payload,t)),TextProcessor.updateAnchorsList()}catch(e){alert(`Oops! ${e.message}`)}}(),Dictionaries.fetchURIs(),WordSelection.setupEvents({actionBtns:VideoActionBtns,controller:VideoController,linkBuilder:LinkBuilder.forTranslationInVideo}),$("#btn-add, #btn-forgot").on("click",(async function(e){const t=WordSelection.get(),r=t.text(),o=t.length>1?1:0;try{const e=new URLSearchParams({word:r.toLowerCase(),is_phrase:o,source_id:$("[data-idtext]").attr("data-idtext"),text_is_shared:!0,sentence:SentenceExtractor.extractSentence(t)}),n=await fetch("/ajax/addword.php",{method:"POST",body:e});if(!n.ok)throw new Error(`HTTP error: ${n.status}`);const a=await n.json();if(!a.success)throw new Error(a.error_msg||"Failed to add word.");if(o){const e=t.eq(0).text(),o=t.filter(".word").length;$("a.word").filter((function(){return $(this).text().toLowerCase()===e.toLowerCase()})).each((function(){let e=$(this).nextAll("a.word").slice(0,o-1).last(),t=$(this).nextUntil(e).addBack().next("a.word").addBack();t.text().toLowerCase()===r.toLowerCase()&&(t.wrapAll("<a class='word reviewing new'></a>"),t.contents().unwrap())}))}else{let e=$("a.word").filter((function(){return $(this).text().toLowerCase()===r.toLowerCase()}));e.each((function(){let e=$(this);e.is(".new, .learning, .learned, .forgotten")?e.wrap("<a class='word reviewing forgotten'></a>"):e.wrap("<a class='word reviewing new'></a>")})),e.contents().unwrap()}TextProcessor.updateAnchorsList()}catch(e){alert(`Oops! ${e.message}`)}VideoActionBtns.hide(),VideoController.resume()})),$("#btn-remove").on("click",(async function(){const e=WordSelection.get();try{const r=await fetch("/ajax/removeword.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({word:e.text().toLowerCase()})});if(!r.ok)throw new Error(`HTTP error: ${r.status}`);const o=await r.json();if(!o.success)throw new Error(o.error_msg||"Failed to remove word.");let n=$("a.word").filter((function(){return $(this).text().toLowerCase()===e.text().toLowerCase()}));const a=await fetch("/ajax/getuserwords.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({txt:e.text()})});if(!a.ok)throw new Error(`HTTP error: ${a.status}`);const s=await a.json();if(!s.success)throw new Error(s.error_msg||"Failed to get user words for re-underlining.");let i=$(TextUnderliner.apply(s.payload,t)),d={},c=/""/;n.each((function(){d=$(this),i.filter(".word").each((function(e){c=TextProcessor.langHasNoWordSeparators(t)?new RegExp("(?<![^])"+$(this).text()+"(?![$])","iug").exec(d.text()):new RegExp("(?<![\\p{L}|^])"+$(this).text()+"(?![\\p{L}|$])","iug").exec(d.text()),$(this).text(c);const r=$(this).text().toLowerCase(),o=s.payload.user_words.find((function(e){return e.word==r}));void 0!==o&&(2==o.status?$(this).removeClass("learning").addClass("new"):3==o.status&&$(this).removeClass("learning").addClass("forgotten"))})),d.replaceWith(i.clone()),TextProcessor.updateAnchorsList()}))}catch(e){alert(`Oops! ${e.message}`)}VideoActionBtns.hide(),VideoController.resume()})),$(document).on("click","#btn-save-ytvideo",(async function(){let t=[],o=[],n="";$(".learning").each((function(){n=$(this).text().toLowerCase(),-1==$.inArray(n,t)&&t.push(n)})),o.push($("#text-container").attr("data-IdText"));try{const n=await fetch("/ajax/updatewords.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({words:JSON.stringify(t),textIDs:JSON.stringify(o)})});if(!n.ok)throw new Error(`HTTP error: ${n.status}`);const a=await n.json();if(!a.success)throw new Error(a.error_msg||"Failed to update words status.");const s={words:{new:getUniqueElements(".reviewing.new"),learning:getUniqueElements(".reviewing.learning"),forgotten:getUniqueElements(".reviewing.forgotten")},texts:{reviewed:1}},i=await fetch("/ajax/updateuserscore.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({review_data:JSON.stringify(s)})});if(!i.ok)throw new Error(`HTTP error: ${i.status}`);const d=await i.json();if(!d.success)throw new Error(d.error_msg||"Failed to update user score.");e=d.gems_earned,r=!1;const c="/textstats",w=Number($(".word").length)+Number($(".phrase").length),l=$('<form action="'+c+'" method="post"><input type="hidden" name="created" value="'+$(".reviewing.new").length+'" /><input type="hidden" name="learning" value="'+$(".reviewing.learning").length+'" /><input type="hidden" name="learned" value="'+$(".learned").length+'" /><input type="hidden" name="forgotten" value="'+$(".reviewing.forgotten").length+'" /><input type="hidden" name="total" value="'+w+'" /><input type="hidden" name="gems_earned" value="'+e+'" /><input type="hidden" name="is_shared" value="1" /></form>');$("body").append(l),l.trigger("submit")}catch(e){alert(`Oops! ${e.message}`)}})),$(window).on("resize",(function(){o=.01*window.innerHeight,document.documentElement.style.setProperty("--vh",`${o}px`)})),$(window).on("beforeunload",(function(){if(r)return"Press Save before you go or your changes will be lost."}))}));