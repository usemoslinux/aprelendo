$(document).ready((function(){let e=0;const t=$("html").attr("lang");let r=!0,o=.01*window.innerHeight;document.documentElement.style.setProperty("--vh",`${o}px`),initializeVideoPlayer(0),async function(){try{const e=new URLSearchParams({txt:$("#text").html()}),r=await fetch("/ajax/getuserwords.php",{method:"POST",body:e});if(!r.ok)throw new Error(`HTTP error: ${r.status}`);const o=await r.json();if(!o.success)throw new Error(o.error_msg||"Failed to get user words for underlining");$("#text").html(TextUnderliner.apply(o.payload,t)),TextProcessor.updateAnchorsList()}catch(e){alert(`Oops! ${e.message}`)}}(),Dictionaries.fetchURIs(),WordSelection.setupEvents({actionBtns:VideoActionBtns,controller:VideoController,linkBuilder:LinkBuilder.forTranslationInVideo}),$("#btn-add, #btn-forgot").on("click",(async function(e){const t=$(this);ActionBtns.setActionMenuLoading(t);const r=WordSelection.get(),o=r.text(),n=r.length>1?1:0;try{const e=new URLSearchParams({word:o.toLowerCase(),is_phrase:n,source_id:$("[data-idtext]").attr("data-idtext"),text_is_shared:!0,sentence:SentenceExtractor.extractSentence(r)}),a=await fetch("/ajax/addword.php",{method:"POST",body:e});if(!a.ok)throw new Error(`HTTP error: ${a.status}`);const s=await a.json();if(!s.success)throw new Error(s.error_msg||"Failed to add word.");if(n){const e=r.eq(0).text(),t=r.filter(".word").length;$("a.word").filter((function(){return $(this).text().toLowerCase()===e.toLowerCase()})).each((function(){let e=$(this).nextAll("a.word").slice(0,t-1).last(),r=$(this).nextUntil(e).addBack().next("a.word").addBack();r.text().toLowerCase()===o.toLowerCase()&&(r.wrapAll("<a class='word reviewing new'></a>"),r.contents().unwrap())}))}else{let e=$("a.word").filter((function(){return $(this).text().toLowerCase()===o.toLowerCase()}));e.each((function(){let e=$(this);e.is(".new, .learning, .learned, .forgotten")?e.wrap("<a class='word reviewing forgotten'></a>"):e.wrap("<a class='word reviewing new'></a>")})),e.contents().unwrap()}TextProcessor.updateAnchorsList()}catch(e){alert(`Oops! ${e.message}`)}finally{ActionBtns.clearActionMenuLoading(t),VideoActionBtns.hide(),VideoController.resume()}})),$("#btn-remove").on("click",(async function(){const e=$(this);ActionBtns.setActionMenuLoading(e);const r=WordSelection.get();try{const o=await fetch("/ajax/removeword.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({word:r.text().toLowerCase()})});if(!o.ok)throw new Error(`HTTP error: ${o.status}`);const n=await o.json();if(!n.success)throw new Error(n.error_msg||"Failed to remove word.");let a=$("a.word").filter((function(){return $(this).text().toLowerCase()===r.text().toLowerCase()}));const s=await fetch("/ajax/getuserwords.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({txt:r.text()})});if(!s.ok)throw new Error(`HTTP error: ${s.status}`);const i=await s.json();if(!i.success)throw new Error(i.error_msg||"Failed to get user words for re-underlining.");let c=$(TextUnderliner.apply(i.payload,t));const d=c.filter(".word").get(),l=TextProcessor.langHasNoWordSeparators(t),w=Array.isArray(i.payload.user_words)?i.payload.user_words:[],u=new Map(w.map((function(e){return[String(e.word).toLowerCase(),e.status]})));a.each((function(){const e=$(this),t=e.text();for(const e of d){const r=e.textContent;let o=null;o=l?new RegExp("(?<![^])"+r+"(?![$])","iug").exec(t):new RegExp("(?<![\\p{L}|^])"+r+"(?![\\p{L}|$])","iug").exec(t),e.textContent=o?o[0]:"";const n=e.textContent.toLowerCase(),a=u.get(n);2==a?(e.classList.remove("learning"),e.classList.add("new")):3==a&&(e.classList.remove("learning"),e.classList.add("forgotten"))}e.replaceWith(c.clone())})),TextProcessor.updateAnchorsList()}catch(e){alert(`Oops! ${e.message}`)}finally{ActionBtns.clearActionMenuLoading(e),VideoActionBtns.hide(),VideoController.resume()}})),$(document).on("click","#btn-save-ytvideo",(async function(){let t=[],o=[],n="";$(".learning").each((function(){n=$(this).text().toLowerCase(),-1==$.inArray(n,t)&&t.push(n)})),o.push($("#text-container").attr("data-IdText"));try{const n=await fetch("/ajax/updatewords.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({words:JSON.stringify(t),textIDs:JSON.stringify(o)})});if(!n.ok)throw new Error(`HTTP error: ${n.status}`);const a=await n.json();if(!a.success)throw new Error(a.error_msg||"Failed to update words status.");const s={words:{new:getUniqueElements(".reviewing.new"),learning:getUniqueElements(".reviewing.learning"),forgotten:getUniqueElements(".reviewing.forgotten")},texts:{reviewed:1}},i=await fetch("/ajax/updateuserscore.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({review_data:JSON.stringify(s)})});if(!i.ok)throw new Error(`HTTP error: ${i.status}`);const c=await i.json();if(!c.success)throw new Error(c.error_msg||"Failed to update user score.");e=c.gems_earned,r=!1;const d="/textstats",l=Number($(".word").length)+Number($(".phrase").length),w=$('<form action="'+d+'" method="post"><input type="hidden" name="created" value="'+$(".reviewing.new").length+'" /><input type="hidden" name="learning" value="'+$(".reviewing.learning").length+'" /><input type="hidden" name="learned" value="'+$(".learned").length+'" /><input type="hidden" name="forgotten" value="'+$(".reviewing.forgotten").length+'" /><input type="hidden" name="total" value="'+l+'" /><input type="hidden" name="gems_earned" value="'+e+'" /><input type="hidden" name="is_shared" value="1" /></form>');$("body").append(w),w.trigger("submit")}catch(e){alert(`Oops! ${e.message}`)}})),$(window).on("resize",(function(){o=.01*window.innerHeight,document.documentElement.style.setProperty("--vh",`${o}px`)})),$(window).on("beforeunload",(function(){if(r)return"Press Save before you go or your changes will be lost."}))}));